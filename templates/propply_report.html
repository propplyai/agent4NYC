<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propply AI - Property Compliance Report</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA4gSJ9LDVqQ9AVxw3zVoHSQQVr_9W2V54&libraries=places"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        :root {
            /* Light Mode Colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --text-muted: #94a3b8;
            --accent-primary: #0ea5e9;
            --accent-secondary: #0284c7;
            --border-color: #e2e8f0;
            --shadow-light: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-medium: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-large: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --glass-bg: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
            
            /* Status Colors */
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --info: #3b82f6;
            
            /* Gradients */
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --gradient-error: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        [data-theme="dark"] {
            /* Comprehensive Dark Mode Variables */
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #222222;
            --bg-card: #1e1e1e;
            --bg-input: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #e0e0e0;
            --text-muted: #b0b0b0;
            --text-accent: #ffffff;
            --border-color: #333333;
            --border-subtle: #2a2a2a;
            --glass-bg: rgba(30, 30, 30, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1);
            --shadow-light: 0 2px 8px rgba(0, 0, 0, 0.3);
            --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.4);
            --shadow-large: 0 8px 32px rgba(0, 0, 0, 0.5);
            --shadow-inner: inset 0 1px 3px rgba(0, 0, 0, 0.3);
            --accent-primary: #0ea5e9;
            --accent-secondary: #3b82f6;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-success: linear-gradient(135deg, #059669 0%, #047857 100%);
            --gradient-warning: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            --gradient-error: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: background-color 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 24px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Modern Header Styles */
        .header {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px 32px;
            margin-bottom: 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-medium);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .header:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-large);
        }
        
        .header-content {
            display: flex;
            align-items: center;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }
        
        .logo-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .logo-icon:hover {
            transform: scale(1.05);
        }
        
        .logo-text h1 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .logo-text p {
            margin: 4px 0 0 0;
            font-size: 14px;
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        /* Dark Mode Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .toggle-label {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-secondary);
            transition: color 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .toggle-switch {
            width: 60px;
            height: 32px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            position: relative;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-light);
        }
        
        .toggle-switch:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-medium);
        }
        
        .toggle-slider {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border-radius: 50%;
            position: absolute;
            top: 1px;
            left: 1px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .light-icon, .dark-icon {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            width: 16px;
            height: 16px;
        }
        
        [data-theme="dark"] .toggle-switch {
            background: var(--bg-tertiary);
            border-color: var(--accent-primary);
        }
        
        [data-theme="dark"] .toggle-slider {
            transform: translateX(28px);
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }
        
        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .property-info {
            flex: 1;
        }
        
        .property-map {
            flex: 1;
            min-height: 300px;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-medium);
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        [data-theme="dark"] .property-map {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-large), var(--shadow-inner);
        }

        /* Modern Search Section */
        .search-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-medium);
            margin-bottom: 32px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        [data-theme="dark"] .search-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-large), var(--shadow-inner);
        }
        
        .search-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-large);
        }
        
        [data-theme="dark"] .search-section:hover {
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6), var(--shadow-inner);
        }

        .search-form {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 400;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-light);
        }
        
        [data-theme="dark"] .search-input {
            background: var(--bg-input);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            box-shadow: var(--shadow-inner);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
            transform: translateY(-1px);
        }
        
        [data-theme="dark"] .search-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.3), var(--shadow-inner);
        }

        .search-input::placeholder {
            color: var(--text-muted);
            opacity: 0.7;
        }
        
        [data-theme="dark"] .search-input::placeholder {
            color: var(--text-muted);
            opacity: 0.8;
        }

        .analyze-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-medium);
            position: relative;
            overflow: hidden;
        }
        
        .analyze-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .analyze-btn:hover::before {
            left: 100%;
        }

        .analyze-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .analyze-btn:active {
            transform: translateY(-1px);
        }
        
        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .property-summary {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .property-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .property-meta-compact {
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        
        [data-theme="dark"] .property-meta-compact {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        .property-main-info {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .address-section {
            cursor: pointer;
            flex: 1;
        }
        
        .address-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .address-text {
            font-weight: 600;
            color: #212529;
            font-size: 1rem;
        }
        
        .expand-icon {
            color: #6c757d;
            font-size: 0.8rem;
            transition: transform 0.2s ease;
        }
        
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        /* Two-Column Compliance Score and Map Layout */
        .compliance-map-layout {
            display: flex;
            gap: 24px;
            margin: 24px 0;
            align-items: stretch;
        }

        @media (max-width: 768px) {
            .compliance-map-layout {
                flex-direction: column;
                gap: 16px;
            }
        }

        /* Compliance Score Card */
        .compliance-score-card {
            flex: 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 32px 24px;
            text-align: center;
            box-shadow: var(--shadow-large);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 280px;
        }

        [data-theme="dark"] .compliance-score-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-large), var(--shadow-inner);
        }

        /* Status-based light mode gradients */
        .compliance-score-card.status-excellent {
            background: linear-gradient(135deg, rgba(5, 150, 105, 0.06) 0%, rgba(4, 120, 87, 0.1) 100%), var(--glass-bg);
            border-color: rgba(5, 150, 105, 0.25);
        }

        .compliance-score-card.status-good {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, rgba(5, 150, 105, 0.08) 100%), var(--glass-bg);
            border-color: rgba(16, 185, 129, 0.2);
        }

        .compliance-score-card.status-caution {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.05) 0%, rgba(217, 119, 6, 0.08) 100%), var(--glass-bg);
            border-color: rgba(245, 158, 11, 0.2);
        }

        .compliance-score-card.status-critical {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.05) 0%, rgba(220, 38, 38, 0.08) 100%), var(--glass-bg);
            border-color: rgba(239, 68, 68, 0.2);
        }

        /* Status Chip */
        .compliance-status-chip {
            align-self: center;
            margin-bottom: 20px;
        }

        .status-text {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
        }

        .status-text.excellent {
            background: linear-gradient(135deg, #059669, #047857);
            color: white;
            box-shadow: 0 2px 8px rgba(5, 150, 105, 0.4);
        }

        .status-text.good {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }

        .status-text.caution {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3);
        }

        .status-text.critical {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        [data-theme="dark"] .status-text.excellent {
            background: linear-gradient(135deg, #047857, #065f46);
            box-shadow: 0 2px 12px rgba(4, 120, 87, 0.5);
        }

        [data-theme="dark"] .status-text.good {
            background: linear-gradient(135deg, #059669, #047857);
            box-shadow: 0 2px 12px rgba(5, 150, 105, 0.4);
        }

        [data-theme="dark"] .status-text.caution {
            background: linear-gradient(135deg, #d97706, #b45309);
            box-shadow: 0 2px 12px rgba(217, 119, 6, 0.4);
        }

        [data-theme="dark"] .status-text.critical {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            box-shadow: 0 2px 12px rgba(220, 38, 38, 0.4);
        }

        /* Compliance Score Container */
        .compliance-score-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Updated Compliance Score Content */
        .compliance-score-content {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 2px;
        }

        .compliance-score-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .compliance-score-unit {
            font-size: 18px;
            font-weight: 500;
            color: var(--text-secondary);
            line-height: 1;
        }

        /* Compliance Score Footer */
        .compliance-score-footer {
            margin-top: 20px;
        }

        .report-date {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: right;
            font-weight: 500;
        }

        /* Map Preview Card */
        .map-preview-card {
            flex: 1;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 0;
            box-shadow: var(--shadow-large);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            min-height: 280px;
        }

        [data-theme="dark"] .map-preview-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-large), var(--shadow-inner);
        }

        .property-map-container {
            width: 100%;
            height: 100%;
            min-height: 280px;
            background: var(--bg-tertiary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            border-radius: 20px;
        }

        .map-placeholder-icon {
            font-size: 32px;
            margin-bottom: 8px;
            opacity: 0.6;
        }

        .map-placeholder-text {
            font-size: 14px;
            font-weight: 500;
            opacity: 0.8;
        }

        
        .circular-progress {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: conic-gradient(#10b981 0deg, #10b981 calc(var(--progress) * 3.6deg), rgba(0, 0, 0, 0.1) calc(var(--progress) * 3.6deg));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin: 0 auto;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        [data-theme="dark"] .circular-progress {
            background: conic-gradient(#059669 0deg, #059669 calc(var(--progress) * 3.6deg), rgba(255, 255, 255, 0.08) calc(var(--progress) * 3.6deg));
            box-shadow: 0 4px 16px rgba(5, 150, 105, 0.3), inset 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .circular-progress:hover {
            transform: scale(1.02);
        }
        
        .circular-progress::before {
            content: '';
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--bg-primary);
            position: absolute;
        }
        
        .compliance-score-content {
            position: relative;
            z-index: 2;
        }
        
        .compliance-score-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.9;
        }
        
        .compliance-score-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: #10b981;
            margin: 0;
            line-height: 1;
            text-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }
        
        [data-theme="dark"] .compliance-score-value {
            color: #34d399;
            text-shadow: 0 2px 8px rgba(52, 211, 153, 0.4);
        }
        
        .compliance-score-value.warning {
            color: #f59e0b;
            text-shadow: 0 2px 4px rgba(245, 158, 11, 0.3);
        }
        
        [data-theme="dark"] .compliance-score-value.warning {
            color: #fbbf24;
            text-shadow: 0 2px 8px rgba(251, 191, 36, 0.4);
        }
        
        .compliance-score-value.critical {
            color: #ef4444;
            text-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }
        
        [data-theme="dark"] .compliance-score-value.critical {
            color: #f87171;
            text-shadow: 0 2px 8px rgba(248, 113, 113, 0.4);
        }
        
        .compliance-score-subtitle {
            font-size: 12px;
            color: var(--text-secondary);
            margin-top: 8px;
            font-weight: 500;
            opacity: 0.8;
        }
        
        /* AI Analysis Results Sections */
        .ai-analysis-results {
            margin-top: 25px;
        }
        
        /* Expandable Sections */
        .expandable-section {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .expandable-section:hover {
            box-shadow: var(--shadow-medium);
        }
        
        .section-header {
            background: var(--bg-secondary);
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }
        
        .section-header:hover {
            background: #e9ecef;
        }
        
        .section-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
        }
        
        .expand-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .expand-icon {
            transition: transform 0.3s ease;
            color: #6c757d;
        }
        
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        .section-content {
            padding: 20px;
            display: none;
        }
        
        .section-content.expanded {
            display: block;
        }
        
        /* Metric Cards */
        .risk-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .metric-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #495057;
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .summary-card.critical {
            border-color: #dc3545;
        }
        
        .summary-card.high {
            border-color: #fd7e14;
        }
        
        .summary-card.medium {
            border-color: #ffc107;
        }
        
        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-card.critical .summary-number {
            color: #dc3545;
        }
        
        .summary-card.high .summary-number {
            color: #fd7e14;
        }
        
        .summary-card.medium .summary-number {
            color: #ffc107;
        }
        
        .summary-label {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .ai-analysis-results > div {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        /* Data Freshness Section */
        .freshness-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .freshness-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .freshness-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .freshness-label {
            font-weight: 600;
            color: #495057;
        }
        
        .freshness-value {
            color: #28a745;
            font-weight: 500;
        }
        
        .confidence-badge {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* Risk Assessment Section */
        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .risk-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .risk-level-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .risk-level-badge.low { background: #d4edda; color: #155724; }
        
        [data-theme="dark"] .risk-level-badge.low { 
            background: #052e16; 
            color: #34d399 !important; 
        }
        .risk-level-badge.moderate { background: #fff3cd; color: #856404; }
        
        [data-theme="dark"] .risk-level-badge.moderate { 
            background: #4a3d00; 
            color: #fbbf24 !important; 
        }
        .risk-level-badge.high { background: #f8d7da; color: #721c24; }
        
        [data-theme="dark"] .risk-level-badge.high { 
            background: #4c1d24; 
            color: #f87171 !important; 
        }
        .risk-level-badge.critical { background: #dc3545; color: white; }
        
        .risk-score {
            margin-bottom: 15px;
        }
        
        .risk-score-label {
            font-weight: 600;
            color: #495057;
        }
        
        .risk-score-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #dc3545;
            margin-left: 10px;
        }
        
        .risk-summary {
            background: var(--bg-tertiary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            line-height: 1.6;
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .risk-summary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .risk-factors h4 {
            color: var(--text-primary);
            margin-bottom: 10px;
        }
        
        .risk-factors ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .risk-factors li {
            margin-bottom: 8px;
            line-height: 1.5;
            color: var(--text-primary);
        }
        
        /* Priority Actions Section */
        .actions-header h3 {
            color: var(--text-primary);
            font-size: 1.3rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .actions-subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 20px;
        }
        
        .actions-grid {
            display: grid;
            gap: 20px;
        }
        
        .action-card {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
            background: var(--bg-card);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .action-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .action-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .action-card.critical {
            border-left: 4px solid #dc3545;
            background: var(--bg-card);
        }
        
        .action-card.high {
            border-left: 4px solid #fd7e14;
            background: var(--bg-card);
        }
        
        .action-card.medium {
            border-left: 4px solid #ffc107;
            background: var(--bg-card);
        }
        
        .action-card.low {
            border-left: 4px solid #28a745;
            background: var(--bg-card);
        }
        
        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .action-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .action-priority {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .action-priority.critical { background: #dc3545; color: white; }
        .action-priority.high { background: #fd7e14; color: white; }
        .action-priority.medium { background: #ffc107; color: #333; }
        .action-priority.low { background: #28a745; color: white; }
        
        .action-description {
            color: var(--text-primary);
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .action-financial {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
        }
        
        .financial-item {
            display: flex;
            justify-content: space-between;
        }
        
        .financial-item-label {
            font-weight: 600;
            color: #495057;
        }
        
        .financial-item-value {
            font-weight: 600;
            color: #dc3545;
        }
        
        .action-expandable {
            cursor: pointer;
            color: #667eea;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-expandable:hover {
            text-decoration: underline;
        }
        
        .action-details {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        /* Financial Impact Section */
        .financial-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .financial-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .financial-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .financial-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .financial-value.critical { color: #dc3545; }
        .financial-value.moderate { color: #fd7e14; }
        .financial-value.positive { color: #28a745; }
        
        .financial-description {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .cost-breakdown h4 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .breakdown-label {
            font-weight: 500;
            color: #495057;
        }
        
        .breakdown-value {
            font-weight: 600;
            color: #333;
        }
        
        /* Equipment Monitoring Section */
        .equipment-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .equipment-subtitle {
            color: #6c757d;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }
        
        .equipment-tabs {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .tab-buttons {
            display: flex;
            background: #f8f9fa;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: var(--bg-card);
            color: #667eea;
            font-weight: 600;
        }
        
        .tab-button:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .tab-content {
            padding: 20px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* Regulatory Intelligence Section */
        .regulatory-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .regulatory-item {
            margin-bottom: 20px;
        }
        
        .regulatory-item h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .regulatory-item div {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
        }
        
        .regulatory-item ul {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 0;
            padding-left: 35px;
        }
        
        .regulatory-item li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .report-date-right {
            font-size: 0.8rem;
            color: #6c757d;
            margin-left: 16px;
        }
        
        .property-details-dropdown {
            border-top: 1px solid #e9ecef;
            background: var(--bg-card);
            padding: 12px 16px;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        
        .detail-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            color: #212529;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        /* Compact Service Providers Styles */
        .service-providers-compact {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            border: 1px solid var(--border-color);
        }
        
        [data-theme="dark"] .service-providers-compact {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        .providers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .providers-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: var(--text-primary);
        }
        
        .providers-badge {
            background: var(--success);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .actions-count {
            background: var(--accent-primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .device-list {
            margin: 20px 0;
        }
        
        .device-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }
        
        [data-theme="dark"] .device-card {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        .device-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-1px);
        }
        
        .device-card h5 {
            margin: 0 0 10px 0;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .device-card p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        .device-card p strong {
            color: var(--text-primary);
        }
        
        /* Device item styles for comprehensive data */
        .device-item {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        
        .device-item:hover {
            box-shadow: var(--shadow-light);
            transform: translateY(-1px);
        }
        
        .device-item.has-defects {
            border-left: 4px solid #dc3545;
            background: rgba(220, 53, 69, 0.05);
        }
        
        .device-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .device-header strong {
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .device-type {
            color: var(--text-secondary);
            font-size: 0.875rem;
            background: var(--bg-tertiary);
            padding: 2px 8px;
            border-radius: 12px;
        }
        
        .defect-indicator {
            color: #dc3545;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .compliant-indicator {
            color: #28a745;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .device-stats {
            display: flex;
            gap: 16px;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .devices-list h4 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1rem;
        }
        
        /* Organic Device Display Styles */
        .device-group-row {
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-primary);
        }
        
        .device-summary-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 16px;
            padding: 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            align-items: center;
        }
        
        .device-summary-row:hover {
            background: var(--bg-secondary);
        }
        
        .device-id-cell {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .device-id-cell strong {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .inspection-count {
            color: var(--text-muted);
            font-size: 0.8rem;
        }
        
        .latest-date-cell {
            color: var(--text-secondary);
            font-weight: 500;
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-badge.accepted {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }
        
        .status-badge.pending {
            background: rgba(245, 158, 11, 0.1);
            color: #d97706;
        }
        
        .status-badge.rejected {
            background: rgba(239, 68, 68, 0.1);
            color: #dc2626;
        }
        
        .defects-indicator {
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .defects-indicator.has-defects {
            color: #dc2626;
        }
        
        .defects-indicator.no-defects {
            color: #059669;
        }
        
        .expand-icon {
            color: var(--text-muted);
            transition: transform 0.3s ease;
        }
        
        .device-inspections-details {
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
            padding: 16px;
        }
        
        .inspections-header h5 {
            margin: 0 0 12px 0;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
        }
        
        .inspection-columns-header {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 16px;
            padding: 8px 12px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        
        .inspections-table {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .inspection-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 16px;
            padding: 12px;
            background: var(--bg-primary);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }
        
        .inspection-date {
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .inspection-status {
            color: var(--text-primary);
        }
        
        .inspection-defects {
            color: var(--text-secondary);
        }
        
        .inspection-details {
            color: var(--text-muted);
            font-size: 0.85rem;
            font-family: monospace;
        }
        
        .no-inspections {
            text-align: center;
            color: var(--text-muted);
            padding: 20px;
            font-style: italic;
        }
        
        .show-more-container {
            text-align: center;
            padding: 12px 0;
            border-top: 1px solid var(--border-color);
            margin-top: 8px;
        }
        
        .show-more-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .show-more-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--primary-color);
        }
        
        .show-more-btn i {
            transition: transform 0.3s ease;
        }
        
        .additional-inspections {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        /* Mobile responsiveness for organic display */
        @media (max-width: 768px) {
            .device-summary-row {
                grid-template-columns: 1fr;
                gap: 8px;
                text-align: left;
            }
            
            .inspection-row {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
        }
        
        .service-category {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        [data-theme="dark"] .service-category {
            background: var(--bg-card);
            border-color: var(--border-color);
        }
        
        .service-category-header {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }
        
        [data-theme="dark"] .service-category-header {
            background: var(--bg-card);
            border-bottom-color: var(--border-color);
        }
        
        .service-category-header:hover {
            background: var(--bg-tertiary);
        }
        
        [data-theme="dark"] .service-category-header:hover {
            background: var(--bg-tertiary);
        }
        
        .service-category-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
        }
        
        .service-category-count {
            background: var(--text-secondary);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-right: 8px;
        }
        
        .service-providers-list {
            display: none;
            padding: 12px;
            background: var(--bg-tertiary);
        }
        
        [data-theme="dark"] .service-providers-list {
            background: var(--bg-secondary);
        }
        
        .service-provider {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .service-provider:last-child {
            border-bottom: none;
        }
        
        .provider-info {
            flex: 1;
        }
        
        .provider-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.85rem;
        }
        
        .provider-details {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }
        
        .provider-contact {
            font-size: 0.8rem;
            color: #007bff;
            text-decoration: none;
        }
        
        .providers-footer {
            margin-top: 12px;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: center;
        }

        .meta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .meta-item:last-child {
            border-bottom: none;
        }

        .meta-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meta-value {
            color: #212529;
            font-weight: 500;
            font-size: 1rem;
        }



        .score-warning { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .score-critical { background: linear-gradient(135deg, #f44336, #d32f2f); }

        .compliance-table {
            background: var(--bg-card);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            background: #667eea;
            color: white;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .compliance-row {
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .compliance-row:hover {
            background: #f8f9fa;
        }

        .compliance-row.expanded {
            background: #f0f4ff;
        }

        .row-summary {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 60px;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }

        .category-name {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-icon {
            width: 20px;
            text-align: center;
        }

        .score-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
        }

        .score-excellent { background: #4CAF50; }
        .score-good { background: #2196F3; }
        .score-warning { background: #FF9800; }
        .score-critical { background: #f44336; }

        .status-summary {
            color: #666;
            font-size: 0.95rem;
        }

        .expand-icon {
            color: #666;
            transition: transform 0.3s ease;
        }

        .compliance-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .row-details {
            display: none;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .compliance-row.expanded .row-details {
            display: block;
        }

        .details-content {
            padding: 25px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-section {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .detail-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .detail-list {
            list-style: none;
        }

        .detail-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }
        
        [data-theme="dark"] .detail-label {
            color: #ffffff !important;
        }

        .detail-value {
            color: var(--text-secondary);
            text-align: right;
            flex: 1;
        }

        .records-table {
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        .records-header {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .records-header, .record-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr;
            gap: 15px;
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .records-header.organic-header {
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 16px;
        }

        .record-row:last-child {
            border-bottom: none;
        }

        .record-row:nth-child(even) {
            background: #fafbfc;
        }

        .expandable-text {
            cursor: pointer;
            color: #667eea;
            transition: color 0.2s ease;
        }

        .expandable-text:hover {
            color: #5a6fd8;
            text-decoration: underline;
        }

        .description-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: var(--bg-card);
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .modal-body {
            line-height: 1.6;
            color: #333;
        }

        .violation-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row strong {
            color: #666;
            min-width: 120px;
        }

        .description-text {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-size: 1rem;
            line-height: 1.6;
        }
        
        .violation-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        /* Simplified Overall Score Display */
        .score-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }
        
        .score-circle-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            margin: 0 auto 15px;
            border: 3px solid rgba(255,255,255,0.3);
        }
        
        .score-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .score-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Enhanced AI Analysis Section */
        .ai-insights {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 0;
            margin-bottom: 25px;
            box-shadow: var(--shadow-large);
            border: 1px solid var(--border-color);
        }
        
        [data-theme="dark"] .ai-insights {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-large), var(--shadow-inner);
        }
        
        .insights-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .insights-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .insights-title .ai-icon {
            font-size: 1.4rem;
            color: #FFD700;
        }
        
        .ai-confidence-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .ai-content {
            padding: 25px;
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .ai-content {
            color: #ffffff;
        }
        
        .ai-content p, .ai-content div, .ai-content span {
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .ai-content p,
        [data-theme="dark"] .ai-content div,
        [data-theme="dark"] .ai-content span {
            color: #ffffff !important;
        }
        
        /* Comprehensive dark mode text fixes with better contrast */
        [data-theme="dark"] .risk-assessment-enhanced,
        [data-theme="dark"] .action-card-enhanced,
        [data-theme="dark"] .ai-insights {
            color: #f8fafc !important;
        }
        
        [data-theme="dark"] .risk-assessment-enhanced *,
        [data-theme="dark"] .action-card-enhanced *,
        [data-theme="dark"] .ai-insights * {
            color: #f8fafc !important;
        }
        
        [data-theme="dark"] .risk-summary,
        [data-theme="dark"] .risk-summary *,
        [data-theme="dark"] .action-description,
        [data-theme="dark"] .action-description *,
        [data-theme="dark"] .detail-compliance-analysis *,
        [data-theme="dark"] .vendor-marketplace * {
            color: #f8fafc !important;
        }
        
        /* Enhanced visibility for specific elements */
        [data-theme="dark"] .compliance-table *,
        [data-theme="dark"] .compliance-row *,
        [data-theme="dark"] .compliance-item *,
        [data-theme="dark"] .service-provider * {
            color: #f8fafc !important;
        }
        
        /* Better contrast for headings and important text */
        [data-theme="dark"] h1, [data-theme="dark"] h2, [data-theme="dark"] h3, 
        [data-theme="dark"] h4, [data-theme="dark"] h5, [data-theme="dark"] h6 {
            color: #ffffff !important;
        }
        
        /* Ensure all paragraph and list text is visible */
        [data-theme="dark"] p, [data-theme="dark"] li, [data-theme="dark"] span,
        [data-theme="dark"] div:not(.status-text):not(.badge):not(.circular-progress):not(.toggle-slider) {
            color: #f8fafc !important;
        }
        
        /* Add base text color inheritance */
        p, li, span, div, label, input, textarea, select {
            color: inherit;
        }
        
        /* Ensure proper contrast for light mode elements */
        .property-summary, .summary-card, .ai-analysis-results > div,
        .action-card, .service-category, .compliance-table,
        .detail-section, .records-table, .modal-content,
        .description-text, .vendor-marketplace, .vendor-category {
            color: var(--text-primary);
        }
        
        /* Risk Assessment Redesign */
        /* Modern Risk Assessment Card */
        .risk-assessment-enhanced {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-medium);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        [data-theme="dark"] .risk-assessment-enhanced {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-large), var(--shadow-inner);
        }
        
        .risk-assessment-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-warning);
            border-radius: 2px 0 0 2px;
        }
        
        .risk-assessment-enhanced.risk-critical-border::before {
            background: var(--gradient-error);
        }
        
        .risk-assessment-enhanced.risk-high-border::before {
            background: linear-gradient(135deg, #ea580c, #dc2626);
        }
        
        .risk-assessment-enhanced.risk-moderate-border::before {
            background: var(--gradient-warning);
        }
        
        .risk-assessment-enhanced.risk-low-border::before {
            background: var(--gradient-success);
        }
        
        .risk-assessment-enhanced:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .risk-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .risk-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .risk-title {
            color: #ffffff !important;
        }
        
        /* Proper dark mode styling using CSS variables */
        [data-theme="dark"] .risk-assessment-enhanced {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .action-card-enhanced {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .compliance-table,
        [data-theme="dark"] .detail-compliance-analysis {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .vendor-marketplace {
            background: var(--bg-card) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        /* Fix service sections with proper contrast */
        [data-theme="dark"] .compliance-row,
        [data-theme="dark"] .compliance-item {
            background: var(--bg-secondary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .compliance-row:hover,
        [data-theme="dark"] .compliance-item:hover {
            background: var(--bg-tertiary) !important;
        }
        
        /* Ensure buttons and interactive elements are visible */
        [data-theme="dark"] .btn, [data-theme="dark"] button {
            color: #ffffff !important;
        }
        
        /* Fix any remaining invisible text */
        [data-theme="dark"] .text-muted,
        [data-theme="dark"] .text-secondary {
            color: #cccccc !important;
        }
        
        /* Fix input and form elements in dark mode */
        [data-theme="dark"] input, 
        [data-theme="dark"] textarea, 
        [data-theme="dark"] select {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Fix dropdown and select elements */
        [data-theme="dark"] option {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
        }
        
        /* Fix table headers and cells */
        [data-theme="dark"] th, 
        [data-theme="dark"] td {
            color: var(--text-primary) !important;
            background: inherit !important;
        }
        
        [data-theme="dark"] .table-header {
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
        }
        
        .risk-badge-enhanced {
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .risk-critical { background: #fecaca; color: #dc2626; }
        .risk-high { background: #fed7aa; color: #ea580c; }
        .risk-moderate { background: #fde68a; color: #d97706; }
        .risk-low { background: #bbf7d0; color: #16a34a; }
        
        .risk-summary {
            font-size: 1rem;
            line-height: 1.6;
            color: #374151;
            margin-bottom: 15px;
        }
        
        .risk-factors {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 15px;
        }
        
        .risk-factors-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .risk-factors-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .risk-factor-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #4b5563;
        }
        
        .risk-factor-item:before {
            content: '';
            color: #ef4444;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* Priority Actions Redesign */
        .priority-actions-enhanced {
            margin-bottom: 20px;
        }
        
        .actions-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
        }
        
        /* Modern Action Cards */
        .action-card-enhanced {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-medium);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        [data-theme="dark"] .action-card-enhanced {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-medium), var(--shadow-inner);
        }
        
        .action-card-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            border-radius: 2px 0 0 2px;
        }
        
        .action-card-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-large);
        }
        
        .action-critical::before { background: var(--gradient-error); }
        .action-high::before { background: linear-gradient(135deg, #ea580c, #dc2626); }
        .action-medium::before { background: var(--gradient-warning); }
        .action-low::before { background: var(--gradient-success); }
        
        .action-header-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .action-priority-enhanced {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .priority-critical { background: #fecaca; color: #dc2626; }
        .priority-high { background: #fed7aa; color: #ea580c; }
        .priority-medium { background: #fde68a; color: #d97706; }
        .priority-low { background: #bbf7d0; color: #16a34a; }
        
        .action-category {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .action-title-enhanced {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .action-reason {
            font-size: 0.9rem;
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .action-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #f3f4f6;
        }
        
        .action-detail {
            text-align: center;
        }
        
        .action-detail-label {
            font-size: 0.7rem;
            color: #9ca3af;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .action-detail-value {
            font-size: 0.9rem;
            color: #1f2937;
            font-weight: 600;
        }
        
        .ai-meta-enhanced {
            text-align: center;
            padding: 15px 25px;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
            font-size: 0.8rem;
            color: #6b7280;
            border-top: 1px solid #f3f4f6;
        }

        /* Vendor Marketplace Styles */
        .vendor-marketplace {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 0;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e3f2f1;
        }
        
        .marketplace-badge {
            background: rgba(76, 175, 80, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #2e7d32;
        }
        
        .vendor-content {
            padding: 25px;
        }
        
        .vendor-intro {
            margin-bottom: 20px;
            font-size: 1rem;
            color: #374151;
        }
        
        .vendor-categories {
            display: grid;
            gap: 20px;
        }
        
        .vendor-category {
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        
        .vendor-category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .vendor-list {
            padding: 20px;
        }
        
        .vendor-card {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            padding: 15px;
            border: 1px solid #f3f4f6;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
            align-items: center;
        }
        
        .vendor-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .vendor-card:last-child {
            margin-bottom: 0;
        }
        
        .vendor-info {
            min-width: 0;
        }
        
        .vendor-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .vendor-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .vendor-detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .vendor-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .star-rating {
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .vendor-distance {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #6b7280;
            white-space: nowrap;
        }
        
        .vendor-actions {
            display: flex;
            gap: 8px;
        }
        
        .vendor-action-btn {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .vendor-action-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f8f9ff;
        }
        
        .vendor-action-btn.primary {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .vendor-action-btn.primary:hover {
            background: #5a6fd8;
            border-color: #5a6fd8;
            color: white;
        }
        
        .vendor-meta {
            text-align: center;
            padding: 15px 25px;
            background: #f8fffe;
            border-radius: 0 0 12px 12px;
            font-size: 0.8rem;
            color: #6b7280;
            border-top: 1px solid #e3f2f1;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .truncated-text {
            cursor: pointer;
            color: #667eea;
            position: relative;
        }

        .truncated-text:hover {
            color: #5a6fd8;
        }

        .truncated-text::after {
            content: " (click to expand)";
            font-size: 0.85em;
            color: #999;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: var(--shadow-large);
            color: var(--text-primary);
        }

        [data-theme="dark"] .loading {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-large), var(--shadow-inner);
        }

        .loading p {
            color: var(--text-primary);
            margin: 8px 0;
        }

        .loading p strong {
            color: var(--text-primary);
        }

        .spinner {
            border: 3px solid var(--border-subtle);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        [data-theme="dark"] .spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-top: 3px solid var(--accent-primary);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: var(--bg-tertiary);
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #d32f2f;
            margin-top: 20px;
        }

        /* Floating Action Button */
        .fab-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1000;
            display: none;
        }
        
        .fab {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--gradient-primary);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(14, 165, 233, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .fab:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 12px 32px rgba(14, 165, 233, 0.4);
        }
        
        .fab:active {
            transform: translateY(-1px) scale(1.02);
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
            display: inline-block;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            text-align: center;
            border-radius: 8px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1001;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            box-shadow: var(--shadow-medium);
        }
        
        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--bg-tertiary) transparent transparent transparent;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        /* Enhanced Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }
        
        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }
        
        .animate-slide-in-right {
            animation: slideInRight 0.6s ease-out;
        }
        
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        
        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .header .tagline {
                font-size: 1rem;
            }

            .row-summary {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .property-meta {
                grid-template-columns: 1fr;
            }
            
            .records-header, .record-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .search-form {
                flex-direction: column;
            }

            .search-input {
                margin-bottom: 10px;
            }

            /* AI Analysis Mobile Styles */
            .actions-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .action-details {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .risk-factors {
                padding: 12px;
            }

            /* Vendor Marketplace Mobile Styles */
            .vendor-card {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 15px;
            }

            .vendor-info {
                order: 1;
            }

            .vendor-rating {
                order: 2;
                justify-self: start;
            }

            .vendor-distance {
                order: 3;
                justify-self: start;
                margin-top: 5px;
            }

            .vendor-actions {
                order: 4;
                flex-direction: column;
                gap: 8px;
                margin-top: 10px;
            }

            .vendor-action-btn {
                width: 100%;
                justify-content: center;
                padding: 10px 12px;
            }

            .vendor-details {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .vendor-detail-item {
                font-size: 0.85rem;
            }

            .vendor-name {
                font-size: 1rem;
                margin-bottom: 8px;
            }

            .star-rating {
                font-size: 0.9rem;
            }

            .vendor-category-header {
                padding: 12px 15px;
                font-size: 0.95rem;
            }

            .vendor-list {
                padding: 15px;
            }

            /* Modal Mobile Styles */
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 10px auto;
                padding: 20px;
                max-height: 90vh;
            }

            .modal-title {
                font-size: 1.1rem;
            }

            .violation-details {
                padding: 15px;
            }

            .detail-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .detail-value {
                text-align: left;
            }

            /* Score Circle Mobile */
            .score-circle-large {
                width: 80px;
                height: 80px;
                font-size: 1.5rem;
            }

            .score-title {
                font-size: 1.1rem;
            }

            .score-subtitle {
                font-size: 0.85rem;
            }
        }

        /* Tablet Responsive Design */
        @media (max-width: 1024px) and (min-width: 769px) {
            .actions-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }

            .vendor-card {
                grid-template-columns: 2fr auto auto;
                gap: 12px;
            }

            .vendor-details {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }

            .vendor-actions {
                flex-direction: column;
                gap: 6px;
            }

            .vendor-action-btn {
                font-size: 0.75rem;
                padding: 6px 10px;
            }
        }

        /* Small Mobile Devices */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 20px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .search-section, .property-summary, .ai-insights, .vendor-marketplace, .compliance-table {
                padding: 15px;
                margin-bottom: 15px;
            }

            .insights-header, .vendor-category-header {
                padding: 15px;
            }

            .insights-title {
                font-size: 1.1rem;
            }

            .vendor-intro {
                font-size: 0.9rem;
                margin-bottom: 15px;
            }

            .vendor-name {
                font-size: 0.95rem;
            }

            .vendor-detail-item {
                font-size: 0.8rem;
            }

            .vendor-action-btn {
                font-size: 0.8rem;
                padding: 8px 10px;
            }

            .action-card-enhanced {
                padding: 15px;
            }

            .action-title-enhanced {
                font-size: 0.95rem;
            }

            .action-reason {
                font-size: 0.85rem;
            }

            .risk-assessment-enhanced {
                padding: 15px;
            }

            .risk-title {
                font-size: 1rem;
            }

            .risk-summary {
                font-size: 0.9rem;
            }

            .property-title {
                font-size: 1.5rem;
            }

            .meta-item {
                padding: 8px 0;
            }

            .analyze-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            /* Improve touch targets on mobile */
            .compliance-row {
                min-height: 60px;
            }

            .expand-icon {
                padding: 10px;
            }

            .truncated-text {
                line-height: 1.4;
                word-break: break-word;
            }

            .vendor-distance {
                font-size: 0.75rem;
                padding: 3px 6px;
            }

            .marketplace-badge, .ai-confidence-badge {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
        }
    </style>
    
    <!-- Comprehensive Dashboard CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/comprehensive-dashboard.css') }}">
    <!-- Dark Mode Fixes CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dark-mode-fixes.css') }}">
</head>
<body>
    <div class="container">
        <!-- Modern Header with Dark Mode Toggle -->
        <header class="header">
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo">
                        <div class="logo-icon">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect width="32" height="32" rx="8" fill="url(#gradient)"/>
                                <path d="M8 20V12C8 10.8954 8.89543 10 10 10H14L16 8L18 10H22C23.1046 10 24 10.8954 24 12V20C24 21.1046 23.1046 22 22 22H10C8.89543 22 8 21.1046 8 20Z" fill="white"/>
                                <circle cx="12" cy="16" r="1.5" fill="#0EA5E9"/>
                                <circle cx="20" cy="16" r="1.5" fill="#0EA5E9"/>
                                <path d="M14 18H18" stroke="#0EA5E9" stroke-width="1.5" stroke-linecap="round"/>
                                <defs>
                                    <linearGradient id="gradient" x1="0" y1="0" x2="32" y2="32" gradientUnits="userSpaceOnUse">
                                        <stop stop-color="#0EA5E9"/>
                                        <stop offset="1" stop-color="#3B82F6"/>
                                    </linearGradient>
                                </defs>
                            </svg>
                        </div>
                        <div class="logo-text">
                            <h1>Propply AI</h1>
                            <p>Intelligent Property Compliance Analysis</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="theme-toggle">
                <span class="toggle-label">Dark Mode</span>
                <div class="toggle-switch" onclick="toggleTheme()">
                    <div class="toggle-slider">
                        <i data-lucide="sun" class="light-icon"></i>
                        <i data-lucide="moon" class="dark-icon" style="display: none;"></i>
                    </div>
                </div>
            </div>
        </header>

        <div class="search-section">
            <div class="search-form">
                <input type="text" id="addressInput" class="search-input" placeholder="Enter property address (e.g., 123 Main Street, City, State ZIP)">
                <button id="analyzeBtn" class="analyze-btn">
                    <i class="fas fa-search"></i> Analyze Property
                </button>
            </div>
        </div>

        <div class="results-section" id="resultsSection" style="display: none;">
            <div class="loading" id="loadingDiv" style="display: none;">
                <div class="spinner"></div>
                <p><strong>Generating comprehensive compliance report...</strong></p>
                <p>Analyzing HPD, DOB, Elevator, Boiler, and Electrical data</p>
            </div>

            <div id="resultsContent" style="display: none;">
                <div class="property-summary">
                    <div class="property-header">
                        <div class="property-info">
                            <h2>Property Analysis Results</h2>
                            
                            <!-- Two-Column Compliance Score and Map Layout -->
                            <div class="compliance-map-layout">
                                <!-- Compliance Score Card -->
                                <div class="compliance-score-card" id="complianceScoreCard">
                                    <div class="compliance-status-chip" id="complianceStatusChip">
                                        <span class="status-text" id="statusText">Good</span>
                                    </div>
                                    <div class="compliance-score-container">
                                        <div class="circular-progress" id="circularProgress" style="--progress: 93">
                                            <div class="compliance-score-content">
                                                <div class="compliance-score-value" id="overallScoreProminent">93</div>
                                                <div class="compliance-score-unit">%</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="compliance-score-footer">
                                        <div class="report-date" id="reportDate">Report generated on: Aug 14, 2025</div>
                                    </div>
                                </div>
                                
                                <!-- Map Preview Card -->
                                <div class="map-preview-card">
                                    <div id="propertyMap" class="property-map-container">
                                        <i class="fas fa-map-marker-alt map-placeholder-icon"></i>
                                        <span class="map-placeholder-text">Map will load here</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="property-meta-compact">
                                <div class="property-main-info">
                                    <div class="address-section" onclick="togglePropertyDetails()">
                                        <div class="address-display">
                                            <span class="address-text" id="propertyAddress">Loading...</span>
                                            <i class="fas fa-chevron-down expand-icon" id="propertyExpandIcon"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="property-details-dropdown" id="propertyDetailsDropdown" style="display: none;">
                                    <div class="details-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">BIN:</span>
                                            <span class="detail-value" id="propertyBin">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">BBL:</span>
                                            <span class="detail-value" id="propertyBbl">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Borough:</span>
                                            <span class="detail-value" id="propertyBorough">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Block/Lot:</span>
                                            <span class="detail-value" id="propertyBlockLot">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">ZIP Code:</span>
                                            <span class="detail-value" id="propertyZip">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Results -->
                <div class="ai-analysis-results" id="aiAnalysisResults" style="display: none;">
                    
                    <!-- Analysis Header with Key Metrics -->
                    <div class="analysis-header">
                        <div class="analysis-title">
                            <h2><i class="fas fa-brain"></i> AI Compliance Analysis</h2>
                            <div class="analysis-meta">
                                <span class="analysis-timestamp" id="analysisTimestamp">-</span>
                                <span class="ai-confidence" id="aiConfidenceLevel">-</span>
                            </div>
                        </div>
                        <div class="key-metrics">
                            <div class="metric-card risk-score">
                                <div class="metric-label">Risk Score</div>
                                <div class="metric-value" id="overallRiskScore">-</div>
                            </div>
                            <div class="metric-card risk-level">
                                <div class="metric-label">Risk Level</div>
                                <div class="metric-value" id="overallRiskLevel">-</div>
                            </div>
                            <div class="metric-card data-freshness">
                                <div class="metric-label">Data Freshness</div>
                                <div class="metric-value" id="dataFreshnessDate">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Executive Summary -->
                    <div class="analysis-section expandable-section">
                        <div class="section-header" onclick="toggleSection('executiveSummary')">
                            <h3><i class="fas fa-chart-line"></i> Executive Summary</h3>
                            <div class="expand-indicator">
                                <i class="fas fa-chevron-down expand-icon" id="executiveSummary-icon"></i>
                            </div>
                        </div>
                        <div class="section-content" id="executiveSummary-content">
                            <div class="summary-card">
                                <h4>Risk Assessment</h4>
                                <p id="riskSummaryText">-</p>
                            </div>
                            <div class="summary-card">
                                <h4>Recommendations Summary</h4>
                                <p id="recommendationsSummary">-</p>
                            </div>
                            <div class="risk-factors-section">
                                <h4>Primary Risk Factors</h4>
                                <ul id="primaryRiskFactors" class="risk-factors-list"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Insights Section -->
                    <div class="analysis-section expandable-section">
                        <div class="section-header" onclick="toggleSection('complianceInsights')">
                            <h3><i class="fas fa-lightbulb"></i> Compliance Insights</h3>
                            <div class="expand-indicator">
                                <span class="trajectory-badge" id="complianceTrajectory">-</span>
                                <i class="fas fa-chevron-down expand-icon" id="complianceInsights-icon"></i>
                            </div>
                        </div>
                        <div class="section-content" id="complianceInsights-content">
                            <div class="insights-grid">
                                <div class="insight-card strengths">
                                    <h4><i class="fas fa-check-circle"></i> Strengths</h4>
                                    <ul id="complianceStrengths" class="insight-list"></ul>
                                </div>
                                <div class="insight-card concerns">
                                    <h4><i class="fas fa-exclamation-circle"></i> Immediate Concerns</h4>
                                    <ul id="immediateConcerns" class="insight-list"></ul>
                                </div>
                            </div>
                            <div class="trends-analysis">
                                <h4>Trends Analysis</h4>
                                <p id="trendsAnalysis">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Priority Actions Section -->
                <div class="analysis-section expandable-section">
                    <div class="section-header" onclick="toggleSection('priorityActions')">
                        <h3><i class="fas fa-tasks"></i> Priority Actions</h3>
                        <div class="expand-indicator">
                            <span class="actions-count" id="actionsCount">0 actions</span>
                            <i class="fas fa-chevron-down expand-icon" id="priorityActions-icon"></i>
                        </div>
                    </div>
                    <div class="section-content" id="priorityActions-content">
                        <div class="actions-summary">
                            <div class="summary-cards">
                                <div class="summary-card critical">
                                    <div class="summary-number" id="criticalCount">0</div>
                                    <div class="summary-label">Critical</div>
                                </div>
                                <div class="summary-card high">
                                    <div class="summary-number" id="highCount">0</div>
                                    <div class="summary-label">High Priority</div>
                                </div>
                                <div class="summary-card medium">
                                    <div class="summary-number" id="mediumCount">0</div>
                                    <div class="summary-label">Medium Priority</div>
                                </div>
                            </div>
                        </div>
                        <div class="priority-actions-list" id="priorityActionsList">
                            <!-- Priority action items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                    <!-- Financial Impact Section -->
                <div class="analysis-section expandable-section">
                    <div class="section-header" onclick="toggleSection('financialImpact')">
                        <h3><i class="fas fa-dollar-sign"></i> Financial Impact Analysis</h3>
                        <div class="expand-indicator">
                            <span class="financial-exposure" id="totalExposure">-</span>
                            <i class="fas fa-chevron-down expand-icon" id="financialImpact-icon"></i>
                        </div>
                    </div>
                    <div class="section-content" id="financialImpact-content">
                        <div class="financial-overview">
                            <div class="financial-metrics">
                                <div class="metric-card immediate-exposure">
                                    <div class="metric-label">Immediate Exposure</div>
                                    <div class="metric-value" id="immediateExposure">-</div>
                                </div>
                                <div class="metric-card annual-costs">
                                    <div class="metric-label">Annual Compliance Costs</div>
                                    <div class="metric-value" id="annualComplianceCosts">-</div>
                                </div>
                                <div class="metric-card priority-investment">
                                    <div class="metric-label">Priority Investment</div>
                                    <div class="metric-value" id="priorityInvestment">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="financial-details">
                            <div class="detail-row">
                                <div class="detail-card">
                                    <h4>Potential Fines</h4>
                                    <p id="potentialFines">-</p>
                                </div>
                                <div class="detail-card">
                                    <h4>Maintenance Costs</h4>
                                    <p id="maintenanceCosts">-</p>
                                </div>
                            </div>
                            <div class="cost-benefit-analysis">
                                <h4>Cost-Benefit Analysis</h4>
                                <p id="costBenefitAnalysis">-</p>
                            </div>
                            <div class="cost-breakdown">
                                <h4>Cost Breakdown by Category</h4>
                                <div class="breakdown-grid" id="costBreakdownGrid">
                                    <!-- Cost breakdown items will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>     <!-- Equipment Monitoring -->
                    <div class="analysis-section expandable-section">
                    <div class="section-header" onclick="toggleSection('equipmentMonitoring')">
                        <h3><i class="fas fa-cogs"></i> Equipment Monitoring</h3>
                        <div class="expand-indicator">
                            <span class="equipment-summary" id="equipmentSummary">-</span>
                            <i class="fas fa-chevron-down expand-icon" id="equipmentMonitoring-icon"></i>
                        </div>
                    </div>
                    <div class="section-content" id="equipmentMonitoring-content">
                        <div class="equipment-tabs">
                            <div class="tab-buttons">
                                <button class="tab-button active" data-tab="elevators">
                                    <i class="fas fa-elevator"></i> Elevators
                                    <span class="device-count" id="elevatorCount">-</span>
                                </button>
                                <button class="tab-button" data-tab="boilers">
                                    <i class="fas fa-fire"></i> Boilers
                                    <span class="device-count" id="boilerCount">-</span>
                                </button>
                                <button class="tab-button" data-tab="electrical">
                                    <i class="fas fa-bolt"></i> Electrical
                                    <span class="device-count" id="electricalCount">-</span>
                                </button>
                            </div>
                            <div class="tab-content">
                                <div class="tab-panel active" id="elevators-panel">
                                    <!-- Elevator monitoring content -->
                                </div>
                                <div class="tab-panel" id="boilers-panel">
                                    <!-- Boiler monitoring content -->
                                </div>
                                <div class="tab-panel" id="electrical-panel">
                                    <!-- Electrical monitoring content -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- Regulatory Intelligence Section -->
                <div class="analysis-section expandable-section">
                    <div class="section-header" onclick="toggleSection('regulatoryIntelligence')">
                        <h3><i class="fas fa-gavel"></i> Regulatory Intelligence</h3>
                        <div class="expand-indicator">
                            <i class="fas fa-chevron-down expand-icon" id="regulatoryIntelligence-icon"></i>
                        </div>
                    </div>
                    <div class="section-content" id="regulatoryIntelligence-content">
                        <div class="regulatory-grid">
                            <div class="regulatory-card">
                                <h4><i class="fas fa-calendar-alt"></i> Upcoming Inspections</h4>
                                <p id="upcomingInspections">-</p>
                            </div>
                            <div class="regulatory-card">
                                <h4><i class="fas fa-leaf"></i> Seasonal Considerations</h4>
                                <p id="seasonalConsiderations">-</p>
                            </div>
                            <div class="regulatory-card">
                                <h4><i class="fas fa-exclamation-triangle"></i> Regulatory Changes</h4>
                                <p id="regulatoryChanges">-</p>
                            </div>
                        </div>
                        <div class="best-practices">
                            <h4><i class="fas fa-star"></i> Best Practices</h4>
                            <ul id="bestPracticesList" class="practices-list"></ul>
                        </div>
                        <div class="monitoring-schedule">
                            <h4><i class="fas fa-clock"></i> Monitoring Schedule</h4>
                            <p id="monitoringSchedule">-</p>
                        </div>
                    </div>
                </div>

                </div>

                <!-- Enhanced AI Insights -->
                <div class="ai-insights" id="aiInsightsSection" style="display: block;">
                    <div class="insights-header">
                        <div class="insights-title">
                            <i class="fas fa-brain ai-icon"></i>
                            AI-Powered Compliance Analysis
                        </div>
                        <div class="ai-confidence-badge" id="aiConfidenceBadge">
                            <i class="fas fa-spinner fa-spin"></i> Processing...
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="aiLoadingState" class="ai-content">
                        <div class="risk-assessment-enhanced risk-moderate-border">
                            <div class="risk-header">
                                <div class="risk-title">
                                    <i class="fas fa-cog fa-spin"></i> Analyzing Property Data
                                </div>
                            </div>
                            <div class="risk-summary">
                                Our AI agent is conducting a comprehensive analysis of your property's compliance data across all NYC datasets. This process typically takes 20-30 seconds and includes evaluation of HPD violations, DOB records, elevator systems, boiler inspections, and electrical permits.
                            </div>
                            <div id="aiLoadingMessage" class="risk-summary" style="margin-top: 15px; font-style: italic; color: var(--text-secondary);">
                                AI analysis in progress... This may take a minute or two.
                            </div>
                            <div id="aiCancelButton" style="margin-top: 15px; display: none;">
                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="cancelAIAnalysis()">
                                    <i class="fas fa-times"></i> Cancel Analysis
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced AI Results (hidden initially) -->
                    <div id="aiResultsState" style="display: none;" class="ai-content">
                        <!-- Risk Assessment -->
                        <div class="risk-assessment-enhanced" id="riskAssessmentContainer">
                            <div class="risk-header">
                                <div class="risk-title">
                                    <i class="fas fa-exclamation-triangle"></i> Risk Assessment
                                </div>
                                <div class="risk-badge-enhanced" id="riskBadgeEnhanced">ANALYZING</div>
                            </div>
                            <div class="risk-summary" id="riskSummaryEnhanced">
                                Analyzing compliance data...
                            </div>
                            <div class="risk-factors">
                                <div class="risk-factors-title">Key Risk Factors</div>
                                <ul class="risk-factors-list" id="riskFactorsList">
                                    <li class="risk-factor-item">Loading analysis...</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Priority Actions -->
                        <div class="priority-actions-enhanced">
                            <div class="actions-title">
                                <i class="fas fa-tasks"></i> Priority Actions & Recommendations
                            </div>
                            <div class="actions-grid" id="actionsGrid">
                                <!-- Actions will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Financial Impact (if available) -->
                        <div id="financialImpactSection" style="display: none;">
                            <div class="actions-title">
                                <i class="fas fa-dollar-sign"></i> Financial Impact Analysis
                            </div>
                            <div class="actions-grid">
                                <div class="action-card-enhanced">
                                    <div class="action-title-enhanced">Potential Fines</div>
                                    <div class="action-reason" id="potentialFines">Calculating...</div>
                                </div>
                                <div class="action-card-enhanced">
                                    <div class="action-title-enhanced">Estimated Costs</div>
                                    <div class="action-reason" id="estimatedCosts">Calculating...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ai-meta-enhanced">
                        <i class="fas fa-robot"></i> Analysis powered by advanced AI  
                        Confidence: <span id="aiConfidenceText">--</span>%  
                        Completed: <span id="analysisTimeText">--</span>
                    </div>
                </div>



                <!-- Detailed Compliance Analysis -->
                <div class="compliance-table">
                    <div class="table-header">
                        <h3><i class="fas fa-clipboard-check"></i> Detailed Compliance Analysis</h3>
                        <p>Click on any category to view detailed information</p>
                    </div>

                    <!-- EQUIPMENT SECTIONS FIRST (as requested by client) -->
                    <div class="compliance-row" onclick="toggleRow('elevator', event)">
                        <div class="row-summary">
                            <div class="category-name">
                                <i class="fas fa-elevator category-icon"></i>
                                Elevator Equipment
                            </div>
                            <div class="status-summary" id="elevatorStatus">0 total, 0 active</div>
                            <div class="status-summary">Elevator and conveyor device inspections</div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="row-details" onclick="event.stopPropagation()">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-section">
                                        <div class="detail-title">Device Summary</div>
                                        <ul class="detail-list">
                                            <li class="detail-item">
                                                <span class="detail-label">Total Devices:</span>
                                                <span class="detail-value" id="elevatorTotal">0</span>
                                            </li>
                                            <li class="detail-item">
                                                <span class="detail-label">Active Devices:</span>
                                                <span class="detail-value" id="elevatorActive">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="records-table" id="elevatorRecords">
                                    <div class="records-header">
                                        <div>Device Number</div>
                                        <div>Type</div>
                                        <div>Status</div>
                                        <div>Last Updated</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="compliance-row" onclick="toggleRow('boiler', event)">
                        <div class="row-summary">
                            <div class="category-name">
                                <i class="fas fa-fire category-icon"></i>
                                Boiler Inspections
                            </div>
                            <div class="status-summary" id="boilerStatus">0 inspections</div>
                            <div class="status-summary">Boiler safety and maintenance inspection records</div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="row-details" onclick="event.stopPropagation()">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-section">
                                        <div class="detail-title">Inspection Summary</div>
                                        <ul class="detail-list">
                                            <li class="detail-item">
                                                <span class="detail-label">Total Devices:</span>
                                                <span class="detail-value" id="boilerTotal">0</span>
                                            </li>
                                            <li class="detail-item">
                                                <span class="detail-label">Recent Inspections:</span>
                                                <span class="detail-value" id="boilerRecent">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="records-table" id="boilerRecords">
                                    <div class="records-header organic-header">
                                        <div>Device ID & Count</div>
                                        <div>Latest Inspection</div>
                                        <div>Status</div>
                                        <div>Defects</div>
                                        <div></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="compliance-row" onclick="toggleRow('electrical', event)">
                        <div class="row-summary">
                            <div class="category-name">
                                <i class="fas fa-bolt category-icon"></i>
                                Electrical Permits
                            </div>
                            <div class="status-summary" id="electricalStatus">0 permits, 0 active</div>
                            <div class="status-summary">Electrical work permits and inspections</div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="row-details" onclick="event.stopPropagation()">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-section">
                                        <div class="detail-title">Permit Summary</div>
                                        <ul class="detail-list">
                                            <li class="detail-item">
                                                <span class="detail-label">Total Permits:</span>
                                                <span class="detail-value" id="electricalTotal">0</span>
                                            </li>
                                            <li class="detail-item">
                                                <span class="detail-label">Active Permits:</span>
                                                <span class="detail-value" id="electricalActive">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="records-table" id="electricalRecords">
                                    <div class="records-header">
                                        <div>Permit Number</div>
                                        <div>Type</div>
                                        <div>Status</div>
                                        <div>Date</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIOLATIONS SECTIONS SECOND (as requested by client) -->
                    <div class="compliance-row" onclick="toggleRow('hpd', event)">
                        <div class="row-summary">
                            <div class="category-name">
                                <i class="fas fa-home category-icon"></i>
                                HPD Violations
                            </div>
                            <div class="status-summary" id="hpdStatus">0 total, 0 active</div>
                            <div class="status-summary">Housing Preservation & Development violations</div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="row-details" onclick="event.stopPropagation()">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-section">
                                        <div class="detail-title">Violation Summary</div>
                                        <ul class="detail-list">
                                            <li class="detail-item">
                                                <span class="detail-label">Total Violations:</span>
                                                <span class="detail-value" id="hpdTotal">0</span>
                                            </li>
                                            <li class="detail-item">
                                                <span class="detail-label">Active Violations:</span>
                                                <span class="detail-value" id="hpdActive">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="records-table" id="hpdRecords">
                                    <div class="records-header">
                                        <div>Violation ID</div>
                                        <div>Status</div>
                                        <div>Date</div>
                                        <div>Description</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="compliance-row" onclick="toggleRow('dob', event)">
                        <div class="row-summary">
                            <div class="category-name">
                                <i class="fas fa-building category-icon"></i>
                                DOB Violations
                            </div>
                            <div class="status-summary" id="dobStatus">0 total, 0 active</div>
                            <div class="status-summary">Building code and construction violations</div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="row-details" onclick="event.stopPropagation()">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-section">
                                        <div class="detail-title">Violation Summary</div>
                                        <ul class="detail-list">
                                            <li class="detail-item">
                                                <span class="detail-label">Total Violations:</span>
                                                <span class="detail-value" id="dobTotal">0</span>
                                            </li>
                                            <li class="detail-item">
                                                <span class="detail-label">Active Violations:</span>
                                                <span class="detail-value" id="dobActive">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="records-table" id="dobRecords">
                                    <div class="records-header">
                                        <div>Violation ID</div>
                                        <div>Category</div>
                                        <div>Date</div>
                                        <div>Description</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>






                </div>
                
                <!-- Compact Service Providers Section (After Compliance Analysis) -->
                <div class="service-providers-compact" id="serviceProvidersSection" style="display: none;">
                    <div class="providers-header">
                        <h3><i class="fas fa-users"></i> Recommended Service Providers</h3>
                        <div class="providers-badge">
                            <i class="fas fa-check-circle"></i> Verified & Licensed
                        </div>
                    </div>
                    
                    <div class="service-categories" id="serviceCategories">
                        <!-- Service categories with dropdowns will be populated by JavaScript -->
                    </div>
                    
                    <div class="providers-footer">
                        <span><i class="fas fa-shield-alt"></i> Licensed contractors</span>  
                        <span><i class="fas fa-map-marker-alt"></i> Local area</span>  
                        <span><i class="fas fa-star"></i> Rated providers</span>
                    </div>
                </div>
            </div>
            
            <div class="error-message" id="errorMessage" style="display: none;"></div>
        </div>

        <!-- Modal for expanded descriptions -->
        <div id="descriptionModal" class="description-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modalTitle">Violation Details</div>
                    <button class="close-btn" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="violation-details" id="violationDetails">
                        <!-- Violation metadata will be populated here -->
                    </div>
                    <div class="description-text" id="fullDescription">
                        <!-- Full description will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Action Button (Mobile) -->
    <div class="fab-container">
        <button class="fab" onclick="scrollToTop()" title="Analyze New Property">
            <i data-lucide="plus"></i>
        </button>
    </div>
    
    <script>
        let currentData = null;
        let propertyMap = null;

        // Google Maps initialization function
        function initializePropertyMap(address) {
            if (typeof google === 'undefined' || !google.maps) {
                console.warn('Google Maps API not loaded');
                document.getElementById('propertyMap').innerHTML = '<i class="fas fa-map-marker-alt"></i> Map unavailable';
                return;
            }

            const geocoder = new google.maps.Geocoder();
            const mapElement = document.getElementById('propertyMap');
            
            geocoder.geocode({ address: address }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    
                    propertyMap = new google.maps.Map(mapElement, {
                        zoom: 17,
                        center: location,
                        mapTypeId: google.maps.MapTypeId.HYBRID,
                        disableDefaultUI: true,
                        zoomControl: true,
                        streetViewControl: true
                    });
                    
                    new google.maps.Marker({
                        position: location,
                        map: propertyMap,
                        title: address,
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#667eea"/>
                                    <circle cx="12" cy="9" r="2.5" fill="white"/>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(24, 24),
                            anchor: new google.maps.Point(12, 24)
                        }
                    });
                    
                    // Add click handler to open full map in popup
                    mapElement.style.cursor = 'pointer';
                    mapElement.addEventListener('click', () => {
                        openMapPopup(address, location);
                    });
                } else {
                    console.error('Geocoding failed:', status);
                    mapElement.innerHTML = '<i class="fas fa-map-marker-alt"></i> Location not found';
                }
            });
        }

        // Function to open full map in popup window
        function openMapPopup(address, location) {
            const lat = location.lat();
            const lng = location.lng();
            const mapUrl = `https://www.google.com/maps?q=${lat},${lng}&z=17&t=h`;
            
            const popup = window.open(
                mapUrl,
                'PropertyMap',
                'width=800,height=600,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no'
            );
            
            if (popup) {
                popup.focus();
            } else {
                // Fallback if popup blocked
                window.open(mapUrl, '_blank');
            }
        }
        
        // Function to toggle property details dropdown
        function togglePropertyDetails() {
            const dropdown = document.getElementById('propertyDetailsDropdown');
            const icon = document.getElementById('propertyExpandIcon');
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                icon.classList.add('rotated');
            } else {
                dropdown.style.display = 'none';
                icon.classList.remove('rotated');
            }
        }
        
        // Function to toggle service category dropdown
        function toggleServiceCategory(categoryId) {
            const dropdown = document.getElementById(`providers-${categoryId}`);
            const icon = document.querySelector(`[data-category="${categoryId}"] .expand-icon`);
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                if (icon) icon.classList.add('rotated');
            } else {
                dropdown.style.display = 'none';
                if (icon) icon.classList.remove('rotated');
            }
        }

        // Updated event listener for the new form structure
        document.getElementById('analyzeBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            const address = document.getElementById('addressInput').value.trim();
            if (!address) return;
            
            // Show results section and loading
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Disable form
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            
            try {
                const response = await fetch('/api/analyze-property', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address: address })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Full response data received:', data);
                    console.log('AI analysis in response:', data.ai_analysis);
                    currentData = data;
                    displayResults(data);
                } else {
                    showError(data.error || 'Analysis failed');
                }
                
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                // Re-enable form
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').innerHTML = '<i class="fas fa-search"></i> Analyze Property';
                document.getElementById('loadingDiv').style.display = 'none';
            }
        });
        
        function displayResults(data) {
            document.getElementById('resultsContent').style.display = 'block';
            
            // Property summary with error handling
            const setTextContent = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
                else console.warn(`Element with ID '${id}' not found`);
            };
            
            setTextContent('propertyAddress', data.property.address);
            setTextContent('propertyBin', data.property.bin);
            setTextContent('propertyBbl', data.property.bbl);
            setTextContent('propertyBorough', data.property.borough);
            setTextContent('propertyBlockLot', `${data.property.block}/${data.property.lot}`);
            setTextContent('propertyZip', data.property.zip_code);
            setTextContent('reportDate', `Report generated on: ${new Date().toLocaleDateString()}`);
            
            // Initialize Google Map
            initializePropertyMap(data.property.address);
            
            // Overall score - prominent display with dynamic styling
            const overallScore = data.compliance_scores.overall;
            updateComplianceScoreCard(overallScore, new Date().toISOString());
            
            // HPD
            updateComplianceRow('hpd', `${data.violations.hpd_total} total, ${data.violations.hpd_active} active`);
            setTextContent('hpdTotal', data.violations.hpd_total);
            setTextContent('hpdActive', data.violations.hpd_active);
            
            // DOB
            updateComplianceRow('dob', `${data.violations.dob_total} total, ${data.violations.dob_active} active`);
            setTextContent('dobTotal', data.violations.dob_total);
            setTextContent('dobActive', data.violations.dob_active);
            
            // Elevator
            updateComplianceRow('elevator', `${data.equipment.elevator_total} total, ${data.equipment.elevator_active} active`);
            setTextContent('elevatorTotal', data.equipment.elevator_total);
            setTextContent('elevatorActive', data.equipment.elevator_active);
            
            // Boiler - Use comprehensive devices data when available, fallback to inspection data
            let boilerData, uniqueBoilerDevices, recentInspections;
            
            if (data.comprehensive_devices && data.comprehensive_devices.boilers && data.comprehensive_devices.boilers.length > 0) {
                // Use comprehensive devices data (no time filtering)
                boilerData = data.comprehensive_devices.boilers;
                uniqueBoilerDevices = new Set(boilerData.map(record => record.boiler_id || record.device_id)).size;
                recentInspections = boilerData.length;
                console.log(`Using comprehensive boiler data: ${uniqueBoilerDevices} unique devices, ${recentInspections} total inspections`);
            } else {
                // Fallback to legacy inspection data
                boilerData = data.inspections.boiler_data || [];
                uniqueBoilerDevices = new Set(boilerData.map(record => record.boiler_id)).size;
                recentInspections = boilerData.length;
                console.log(`Using legacy boiler data: ${uniqueBoilerDevices} unique devices, ${recentInspections} inspections`);
            }
            
            setTextContent('boilerStatus', `${recentInspections} inspections`);
            setTextContent('boilerTotal', uniqueBoilerDevices);
            setTextContent('boilerRecent', recentInspections);
            
            // Electrical
            updateComplianceRow('electrical', `${data.equipment.electrical_permits_total} permits, ${data.equipment.electrical_permits_active} active`);
            setTextContent('electricalTotal', data.equipment.electrical_permits_total);
            setTextContent('electricalActive', data.equipment.electrical_permits_active);
            
            // Display AI Analysis if available
            console.log('Checking AI analysis data:', data.ai_analysis);
            if (data.ai_analysis && data.ai_analysis.property_analysis) {
                console.log('Displaying AI analysis...');
                displayAIAnalysisCompact(data.ai_analysis);
                displayEnhancedAIAnalysis(data.ai_analysis);
            } else {
                console.log('No AI analysis data found or incomplete structure');
                
                // Check if we have an analysis_id for polling
                const analysisId = data.analysis_metadata?.analysis_id;
                const aiStatus = data.analysis_metadata?.ai_analysis_status;
                
                if (analysisId && aiStatus === 'pending') {
                    console.log(`Starting polling for AI analysis with ID: ${analysisId}`);
                    // Show loading state
                    document.getElementById('aiLoadingState').style.display = 'block';
                    document.getElementById('aiResultsState').style.display = 'none';
                    
                    // Start polling for results
                    startPollingForAIAnalysis(analysisId);
                } else {
                    // Show error state instead of hiding section
                    document.getElementById('aiLoadingState').style.display = 'none';
                    document.getElementById('aiResultsState').style.display = 'block';
                    
                    // Show error message using correct element IDs
                    const riskBadge = document.getElementById('riskBadgeEnhanced');
                    const riskSummary = document.getElementById('riskSummaryEnhanced');
                    const actionsGrid = document.getElementById('actionsGrid');
                    
                    if (riskBadge) {
                        riskBadge.textContent = 'ERROR';
                        riskBadge.className = 'risk-badge-enhanced risk-critical';
                    }
                    
                    if (riskSummary) {
                        riskSummary.textContent = 'AI analysis temporarily unavailable. Please try again later.';
                    }
                    
                    if (actionsGrid) {
                        actionsGrid.innerHTML = `
                            <div class="action-card-enhanced action-critical">
                                <div class="action-title-enhanced">AI Analysis Unavailable</div>
                                <div class="action-reason">Our AI agent is currently processing other requests. The compliance data above is still accurate.</div>
                            </div>
                        `;
                    }
                }
            }
            
            // Display vendor recommendations if available
            console.log('Checking vendor recommendations data:', data.vendor_recommendations);
            if (data.vendor_recommendations) {
                console.log('Displaying vendor recommendations...');
                displayVendorRecommendations(data.vendor_recommendations);
            } else {
                console.log('No vendor recommendations data found');
            }
        }
        
        function updateComplianceRow(category, status) {
            const statusElement = document.getElementById(category + 'Status');
            if (statusElement) {
                statusElement.textContent = status;
            } else {
                console.warn(`Status element for category '${category}' not found`);
            }
        }
        
        function displayAIAnalysisCompact(aiData) {
            try {
                console.log('AI Data received:', aiData);
                
                const analysis = aiData.property_analysis;
                const riskAssessment = analysis.overall_risk_assessment;
                
                // Hide loading state and show results
                document.getElementById('aiLoadingState').style.display = 'none';
                document.getElementById('aiResultsState').style.display = 'block';
                
                // Update confidence badge in header
                const confidence = aiData.ai_confidence || '--';
                const confidenceText = typeof confidence === 'string' && confidence.toUpperCase() === 'HIGH' ? '95' : confidence;
                document.getElementById('aiConfidenceBadge').innerHTML = `<i class="fas fa-check-circle"></i> ${confidenceText}% Confidence`;
                
                // Risk Assessment
                const riskLevel = riskAssessment.risk_level.toLowerCase();
                const riskContainer = document.getElementById('riskAssessmentContainer');
                if (riskContainer) riskContainer.className = `risk-assessment-enhanced risk-${riskLevel}-border`;
                
                const riskBadge = document.getElementById('riskBadgeEnhanced');
                if (riskBadge) {
                    riskBadge.textContent = riskAssessment.risk_level;
                    riskBadge.className = `risk-badge-enhanced risk-${riskLevel}`;
                }
                
                const riskSummaryElement = document.getElementById('riskSummaryEnhanced');
                if (riskSummaryElement) riskSummaryElement.textContent = riskAssessment.risk_summary;
                
                // Risk Factors
                const riskFactorsList = document.getElementById('riskFactorsList');
                riskFactorsList.innerHTML = '';
                if (riskAssessment.primary_risk_factors && Array.isArray(riskAssessment.primary_risk_factors)) {
                    riskAssessment.primary_risk_factors.forEach(factor => {
                        const li = document.createElement('li');
                        li.className = 'risk-factor-item';
                        li.textContent = factor;
                        riskFactorsList.appendChild(li);
                    });
                }
                
                // Priority Actions - Enhanced Grid
                const actionsGrid = document.getElementById('actionsGrid');
                actionsGrid.innerHTML = '';
                
                if (analysis.priority_actions && Array.isArray(analysis.priority_actions)) {
                    analysis.priority_actions.forEach(action => {
                        const actionCard = document.createElement('div');
                        const priorityLevel = action.priority.toLowerCase();
                        actionCard.className = `action-card-enhanced action-${priorityLevel}`;
                        
                        const timeline = action.timeline || 'Not specified';
                        const cost = action.estimated_cost || 'Not specified';
                        
                        actionCard.innerHTML = `
                            <div class="action-header-enhanced">
                                <div class="action-priority-enhanced priority-${priorityLevel}">
                                    ${action.priority}
                                </div>
                                <div class="action-category">${action.category}</div>
                            </div>
                            <div class="action-title-enhanced">${action.action}</div>
                            <div class="action-reason">${action.reason}</div>
                            <div class="action-details">
                                <div class="action-detail">
                                    <div class="action-detail-label">Timeline</div>
                                    <div class="action-detail-value">${timeline}</div>
                                </div>
                                <div class="action-detail">
                                    <div class="action-detail-label">Est. Cost</div>
                                    <div class="action-detail-value">${cost}</div>
                                </div>
                            </div>
                        `;
                        
                        actionsGrid.appendChild(actionCard);
                    });
                } else {
                    // Show fallback if no priority actions
                    actionsGrid.innerHTML = `
                        <div class="action-card-enhanced">
                            <div class="action-title-enhanced">No Critical Actions Required</div>
                            <div class="action-reason">Property appears to be in good compliance standing based on current analysis.</div>
                        </div>
                    `;
                }
                
                // Financial Impact (if available)
                if (analysis.financial_impact) {
                    const financialSection = document.getElementById('financialImpactSection');
                    if (financialSection) financialSection.style.display = 'block';
                    
                    const potentialFinesElement = document.getElementById('potentialFines');
                    if (potentialFinesElement) potentialFinesElement.textContent = analysis.financial_impact.potential_fines || 'Not specified';
                    
                    const estimatedCostsElement = document.getElementById('estimatedCosts');
                    if (estimatedCostsElement) estimatedCostsElement.textContent = analysis.financial_impact.maintenance_costs || 'Not specified';
                }
                
                // Footer metadata
                const aiConfidenceTextElement = document.getElementById('aiConfidenceText');
                if (aiConfidenceTextElement) aiConfidenceTextElement.textContent = confidenceText;
                
                const analysisTime = aiData.analysis_timestamp ? 
                    new Date(aiData.analysis_timestamp).toLocaleTimeString() : 
                    new Date().toLocaleTimeString();
                const analysisTimeElement = document.getElementById('analysisTimeText');
                if (analysisTimeElement) analysisTimeElement.textContent = analysisTime;
                
            } catch (error) {
                console.error('Error displaying AI analysis:', error);
                console.error('AI Data structure:', aiData);
                
                // Show error state
                document.getElementById('aiLoadingState').style.display = 'none';
                document.getElementById('aiResultsState').style.display = 'block';
                
                // Update header to show error
                document.getElementById('aiConfidenceBadge').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                document.getElementById('aiConfidenceBadge').style.background = 'rgba(220, 38, 38, 0.2)';
                
                // Show error in risk assessment
                const riskContainer = document.getElementById('riskAssessmentContainer');
                riskContainer.className = 'risk-assessment-enhanced risk-critical-border';
                document.getElementById('riskBadgeEnhanced').textContent = 'ERROR';
                document.getElementById('riskBadgeEnhanced').className = 'risk-badge-enhanced risk-critical';
                document.getElementById('riskSummaryEnhanced').textContent = 'Unable to process AI analysis at this time. Please try again later.';
                
                document.getElementById('actionsGrid').innerHTML = `
                    <div class="action-card-enhanced action-critical">
                        <div class="action-title-enhanced">AI Analysis Temporarily Unavailable</div>
                        <div class="action-reason">Our AI service is currently processing other requests. The compliance data shown above remains accurate and actionable.</div>
                    </div>
                `;
            }
        }
        
        function displayVendorRecommendations(vendorData) {
            try {
                console.log('Displaying vendor recommendations:', vendorData);
                
                if (!vendorData || Object.keys(vendorData).length === 0) {
                    console.log('No vendor recommendations to display');
                    return;
                }
                
                // Show the compact service providers section
                document.getElementById('serviceProvidersSection').style.display = 'block';
                
                const serviceCategories = document.getElementById('serviceCategories');
                serviceCategories.innerHTML = '';
                
                // Category display names and icons
                const categoryInfo = {
                    'hpd': { name: 'Housing & Maintenance', icon: 'fas fa-home' },
                    'dob': { name: 'Building & Construction', icon: 'fas fa-building' },
                    'elevator': { name: 'Elevator Services', icon: 'fas fa-elevator' },
                    'boiler': { name: 'HVAC & Boiler', icon: 'fas fa-fire' },
                    'electrical': { name: 'Electrical Services', icon: 'fas fa-bolt' },
                    'fire_safety': { name: 'Fire Safety & Alarms', icon: 'fas fa-shield-alt' }
                };
                
                // Create compact service categories with dropdowns
                for (const [category, vendors] of Object.entries(vendorData)) {
                    if (!vendors || vendors.length === 0) continue;
                    
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'service-category';
                    
                    const categoryName = categoryInfo[category]?.name || category.toUpperCase();
                    const categoryIcon = categoryInfo[category]?.icon || 'fas fa-tools';
                    
                    categoryDiv.innerHTML = `
                        <div class="service-category-header" onclick="toggleServiceCategory('${category}')" data-category="${category}">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="${categoryIcon}"></i>
                                <span class="service-category-title">${categoryName}</span>
                                <span class="service-category-count">${vendors.length}</span>
                            </div>
                            <i class="fas fa-chevron-down expand-icon"></i>
                        </div>
                        <div class="service-providers-list" id="providers-${category}">
                            ${vendors.map(vendor => createCompactVendorItem(vendor)).join('')}
                        </div>
                    `;
                    
                    serviceCategories.appendChild(categoryDiv);
                }
                
                // Update timestamp
                const vendorUpdateElement = document.getElementById('vendorUpdateTime');
                if (vendorUpdateElement) vendorUpdateElement.textContent = new Date().toLocaleTimeString();
                
                console.log(' Vendor recommendations displayed successfully');
                
            } catch (error) {
                console.error('Error displaying vendor recommendations:', error);
            }
        }
        
        function createCompactVendorItem(vendor) {
            const rating = vendor.rating || 0;
            const ratingCount = vendor.rating_count || 0;
            const distance = vendor.distance_miles || 'N/A';
            const phone = vendor.phone || '';
            const website = vendor.website || '';
            
            const contactInfo = [];
            if (phone) contactInfo.push(`<a href="tel:${phone}" class="provider-contact">${phone}</a>`);
            if (website) contactInfo.push(`<a href="${website}" target="_blank" class="provider-contact">Website</a>`);
            
            return `
                <div class="service-provider">
                    <div class="provider-info">
                        <div class="provider-name">${vendor.name}</div>
                        <div class="provider-details">
                            ${rating > 0 ? ` ${rating.toFixed(1)} (${ratingCount} reviews)` : 'No reviews'}  
                            ${distance !== 'N/A' ? `${distance} miles` : 'Local area'}
                        </div>
                    </div>
                    <div class="provider-contacts">
                        ${contactInfo.join('  ')}
                    </div>
                </div>
            `;
        }
        
        function createVendorCard(vendor) {
            const rating = vendor.rating || 0;
            const ratingCount = vendor.rating_count || 0;
            const distance = vendor.distance_miles || 'N/A';
            const phone = vendor.phone || '';
            const website = vendor.website || '';
            
            // Create star rating display
            const starRating = createStarRating(rating);
            
            // Create contact buttons
            const contactButtons = [];
            if (phone) {
                contactButtons.push(`<a href="tel:${phone}" class="vendor-action-btn"><i class="fas fa-phone"></i> Call</a>`);
            }
            if (website) {
                contactButtons.push(`<a href="${website}" target="_blank" class="vendor-action-btn primary"><i class="fas fa-external-link-alt"></i> Website</a>`);
            }
            
            return `
                <div class="vendor-card">
                    <div class="vendor-info">
                        <div class="vendor-name">${vendor.name || 'Unknown'}</div>
                        <div class="vendor-details">
                            <div class="vendor-detail-item">
                                <i class="fas fa-map-marker-alt"></i>
                                ${vendor.address || 'Address not available'}
                            </div>
                            ${vendor.business_status ? `
                                <div class="vendor-detail-item">
                                    <i class="fas fa-store"></i>
                                    ${vendor.business_status}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="vendor-rating">
                        <div class="star-rating">
                            ${starRating}
                            <span>${rating}/5</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #6b7280;">
                            ${ratingCount} reviews
                        </div>
                    </div>
                    
                    <div class="vendor-distance">${distance} mi</div>
                    
                    <div class="vendor-actions">
                        ${contactButtons.join('')}
                    </div>
                </div>
            `;
        }
        
        function createStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let stars = '';
            
            // Full stars
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            
            // Half star
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }
            
            // Empty stars
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            
            return stars;
        }
        
        function toggleRow(category, event) {
            // Prevent event bubbling from child elements
            if (event) {
                event.stopPropagation();
            }
            
            const row = event.currentTarget;
            const isExpanded = row.classList.contains('expanded');
            
            // Close all rows
            document.querySelectorAll('.compliance-row').forEach(r => r.classList.remove('expanded'));
            
            // If this row wasn't expanded, expand it and load details
            if (!isExpanded) {
                row.classList.add('expanded');
                loadRowDetails(category);
            }
        }
        
        function displayOrganicDeviceData(category, groupedData, container) {
            // Create organic device-grouped display
            groupedData.forEach((device, index) => {
                const deviceRow = document.createElement('div');
                deviceRow.className = 'device-group-row';
                
                const deviceId = device.device_id || device.boiler_id || `Device ${index + 1}`;
                const totalInspections = device.inspections ? device.inspections.length : 0;
                const latestInspection = device.inspections && device.inspections.length > 0 ? device.inspections[0] : null;
                const latestDate = latestInspection ? (latestInspection.inspection_date || 'N/A') : 'N/A';
                const latestStatus = latestInspection ? (latestInspection.report_status || 'N/A') : 'N/A';
                const hasDefects = latestInspection ? (latestInspection.defects_exist === 'Yes') : false;
                
                deviceRow.innerHTML = `
                    <div class="device-summary-row" onclick="toggleDeviceDetails('${deviceId}', '${category}')">
                        <div class="device-id-cell">
                            <strong>${deviceId}</strong>
                            <small class="inspection-count">${totalInspections} inspections</small>
                        </div>
                        <div class="latest-date-cell">${formatDate(latestDate)}</div>
                        <div class="status-cell">
                            <span class="status-badge ${latestStatus.toLowerCase()}">${latestStatus}</span>
                        </div>
                        <div class="defects-cell">
                            <span class="defects-indicator ${hasDefects ? 'has-defects' : 'no-defects'}">
                                ${hasDefects ? ' Yes' : ' No'}
                            </span>
                        </div>
                        <div class="expand-icon">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="device-inspections-details" id="details-${deviceId}" style="display: none;">
                        <div class="inspections-header">
                            <h5>All Inspections for ${deviceId}</h5>
                            <div class="inspection-columns-header">
                                <span>Date</span>
                                <span>Status</span>
                                <span>Defects</span>
                                <span>Tracking #</span>
                            </div>
                        </div>
                        <div class="inspections-table">
                            ${device.inspections ? (
                                device.inspections.slice(0, 3).map(inspection => `
                                    <div class="inspection-row">
                                        <div class="inspection-date">${formatDate(inspection.inspection_date)}</div>
                                        <div class="inspection-status">${inspection.report_status || 'N/A'}</div>
                                        <div class="inspection-defects">${inspection.defects_exist || 'N/A'}</div>
                                        <div class="inspection-details">${inspection.tracking_number || inspection.boiler_make || 'N/A'}</div>
                                    </div>
                                `).join('') +
                                (device.inspections.length > 3 ? `
                                    <div class="show-more-container">
                                        <button class="show-more-btn" onclick="toggleMoreInspections('${deviceId}')">
                                            <i class="fas fa-chevron-down"></i> Show ${device.inspections.length - 3} more inspections
                                        </button>
                                    </div>
                                    <div class="additional-inspections" id="additional-${deviceId}" style="display: none;">
                                        ${device.inspections.slice(3).map(inspection => `
                                            <div class="inspection-row">
                                                <div class="inspection-date">${formatDate(inspection.inspection_date)}</div>
                                                <div class="inspection-status">${inspection.report_status || 'N/A'}</div>
                                                <div class="inspection-defects">${inspection.defects_exist || 'N/A'}</div>
                                                <div class="inspection-details">${inspection.tracking_number || inspection.boiler_make || 'N/A'}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '')
                            ) : '<div class="no-inspections">No inspection records</div>'}
                        </div>
                    </div>
                `;
                
                container.appendChild(deviceRow);
            });
        }
        
        function toggleDeviceDetails(deviceId, category) {
            const detailsDiv = document.getElementById(`details-${deviceId}`);
            const expandIcon = event.currentTarget.querySelector('.expand-icon i');
            
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
                expandIcon.classList.remove('fa-chevron-down');
                expandIcon.classList.add('fa-chevron-up');
            } else {
                detailsDiv.style.display = 'none';
                expandIcon.classList.remove('fa-chevron-up');
                expandIcon.classList.add('fa-chevron-down');
            }
        }
        
        function toggleMoreInspections(deviceId) {
            const additionalDiv = document.getElementById(`additional-${deviceId}`);
            const button = event.currentTarget;
            const icon = button.querySelector('i');
            
            if (additionalDiv.style.display === 'none' || !additionalDiv.style.display) {
                additionalDiv.style.display = 'block';
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                const currentText = button.textContent.trim();
                const count = currentText.match(/\d+/)[0];
                button.innerHTML = `<i class="fas fa-chevron-up"></i> Hide ${count} inspections`;
            } else {
                additionalDiv.style.display = 'none';
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                const currentText = button.textContent.trim();
                const count = currentText.match(/\d+/)[0];
                button.innerHTML = `<i class="fas fa-chevron-down"></i> Show ${count} more inspections`;
            }
        }

        function loadRowDetails(category) {
            if (!currentData || !currentData.inspections) return;
            
            // Helper function for safe textContent setting
            const setTextContent = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
                else console.warn(`Element with ID '${id}' not found`);
            };
            
            const recordsContainer = document.getElementById(category + 'Records');
            const existingHeader = recordsContainer.querySelector('.records-header');
            
            // Clear existing records except header
            while (recordsContainer.children.length > 1) {
                recordsContainer.removeChild(recordsContainer.lastChild);
            }
            
            // Use comprehensive devices data when available, otherwise use inspections data
            let data = [];
            
            if (currentData.comprehensive_devices && category === 'boiler' && currentData.comprehensive_devices.boilers) {
                // Use grouped device data for organic display
                const groupedData = currentData.comprehensive_devices.boilers;
                
                // For boiler category, we'll use the organic grouped display
                displayOrganicDeviceData(category, groupedData, recordsContainer);
                console.log(`Loading comprehensive boiler data: ${groupedData.length} devices`);
                return; // Skip the normal row generation for boilers
            } else if (currentData.comprehensive_devices && category === 'elevator' && currentData.comprehensive_devices.elevators) {
                // Flatten the grouped device data into individual inspection records
                const groupedData = currentData.comprehensive_devices.elevators;
                data = [];
                groupedData.forEach(device => {
                    if (device.inspections && Array.isArray(device.inspections)) {
                        // Add all inspections for this device
                        data.push(...device.inspections);
                    }
                });
                console.log(`Loading comprehensive elevator data: ${groupedData.length} devices, ${data.length} total inspections`);
            } else if (currentData.comprehensive_devices && category === 'electrical' && currentData.comprehensive_devices.electrical_permits) {
                // Flatten the grouped device data into individual inspection/permit records
                const groupedData = currentData.comprehensive_devices.electrical_permits;
                data = [];
                groupedData.forEach(device => {
                    if (device.inspections && Array.isArray(device.inspections)) {
                        // Add all permits/inspections for this device
                        data.push(...device.inspections);
                    }
                });
                console.log(`Loading comprehensive electrical data: ${groupedData.length} devices, ${data.length} total permits`);
            } else {
                // Fallback to legacy inspection data
                data = currentData.inspections[category + '_data'] || 
                      currentData.inspections[category + '_violations'] || 
                      currentData.inspections[category.replace('_', '_inspections')] ||
                      [];
                console.log(`Loading legacy ${category} data: ${data.length} records`);
            }
            
            // Filter to show only active violations/records
            if (category === 'hpd') {
                // Show only open violations (not RESOLVE, CERTIFIED, CLOSE)
                data = data.filter(record => {
                    const status = (record.violationstatus || '').toUpperCase();
                    const currentStatus = (record.currentstatus || '').toUpperCase();
                    return !['RESOLVE', 'RESOLVED', 'CERTIFIED', 'CLOSE', 'CLOSED', 'DISMISSED'].includes(status) && 
                           !['RESOLVE', 'RESOLVED', 'CERTIFIED', 'CLOSE', 'CLOSED', 'DISMISSED'].includes(currentStatus);
                });
            } else if (category === 'dob') {
                // Show only open violations (not RESOLVE, DISMISS, etc.)
                data = data.filter(record => {
                    const disposition = (record.disposition_comments || '').toUpperCase();
                    const status = (record.violation_status || '').toUpperCase();
                    return !['RESOLVE', 'RESOLVED', 'DISMISS', 'DISMISSED', 'CERTIFIED', 'CLOSE', 'CLOSED'].includes(disposition) &&
                           !['RESOLVE', 'RESOLVED', 'DISMISS', 'DISMISSED', 'CERTIFIED', 'CLOSE', 'CLOSED'].includes(status);
                });
            } else if (category === 'elevator') {
                // Show only active devices
                data = data.filter(record => {
                    const status = (record.device_status || '').toUpperCase();
                    return !['INACTIVE', 'REMOVED', 'TERMINATED', 'CANCELLED'].includes(status);
                });
            } else if (category === 'electrical') {
                // Show only active permits
                data = data.filter(record => {
                    const status = (record.filing_status || '').toUpperCase();
                    return !['EXPIRED', 'CANCELLED', 'CLOSED', 'DISAPPROVED', 'REVOKED'].includes(status);
                });
            }
            // For boiler data - only apply 2-year filtering to legacy data, not comprehensive devices
            if (category === 'boiler' && !(currentData.comprehensive_devices && currentData.comprehensive_devices.boilers)) {
                // Filter legacy boiler data to only show last 2 years
                const twoYearsAgo = new Date();
                twoYearsAgo.setFullYear(twoYearsAgo.getFullYear() - 2);
                
                data = data.filter(record => {
                    const inspectionDate = record.inspection_date;
                    if (!inspectionDate) return false;
                    
                    try {
                        // Parse inspection date (format: M/D/YYYY)
                        const recordDate = new Date(inspectionDate);
                        return recordDate >= twoYearsAgo;
                    } catch (e) {
                        // If date parsing fails, exclude the record to be safe
                        return false;
                    }
                });
                console.log(`Applied 2-year filter to legacy boiler data: ${data.length} records remaining`);
            } else if (category === 'boiler' && currentData.comprehensive_devices && currentData.comprehensive_devices.boilers) {
                console.log(`Skipping time filter for comprehensive boiler data: showing all ${data.length} records`);
            }
            
            if (data.length === 0) {
                const noDataRow = document.createElement('div');
                noDataRow.className = 'record-row';
                noDataRow.innerHTML = '<div colspan="4" style="text-align: center; color: #666; grid-column: 1/-1;">No active records found</div>';
                recordsContainer.appendChild(noDataRow);
                return;
            }
            
            // Add up to 10 records
            data.slice(0, 10).forEach(record => {
                const row = document.createElement('div');
                row.className = 'record-row';
                
                if (category === 'hpd') {
                    const description = record.novdescription || 'N/A';
                    const descriptionHtml = description.length > 50 ? 
                        `<span class="truncated-text" onclick="showDescriptionModal('HPD Violation', ${JSON.stringify(record).replace(/"/g, '&quot;')}, '${description.replace(/'/g, "\\'")}', event)">
                            ${truncate(description, 50)}
                        </span>` : description;
                    
                    row.innerHTML = `
                        <div>${record.violationid || 'N/A'}</div>
                        <div>${record.violationstatus || 'N/A'}</div>
                        <div>${formatDate(record.approveddate)}</div>
                        <div>${descriptionHtml}</div>
                    `;
                } else if (category === 'dob') {
                    const description = record.description || 'N/A';
                    const descriptionHtml = description.length > 50 ? 
                        `<span class="truncated-text" onclick="showDescriptionModal('DOB Violation', ${JSON.stringify(record).replace(/"/g, '&quot;')}, '${description.replace(/'/g, "\\'")}', event)">
                            ${truncate(description, 50)}
                        </span>` : description;
                    
                    row.innerHTML = `
                        <div>${record.isn_dob_bis_viol || 'N/A'}</div>
                        <div>${record.violation_category || 'N/A'}</div>
                        <div>${formatDate(record.issue_date)}</div>
                        <div>${descriptionHtml}</div>
                    `;
                } else if (category === 'elevator') {
                    row.innerHTML = `
                        <div>${record.device_number || 'N/A'}</div>
                        <div>${record.device_type || 'N/A'}</div>
                        <div>${record.device_status || 'N/A'}</div>
                        <div>${formatDate(record.status_date)}</div>
                    `;
                } else if (category === 'boiler') {
                    row.innerHTML = `
                        <div>${record.boiler_id || 'N/A'}</div>
                        <div>${formatDate(record.inspection_date)}</div>
                        <div>${record.report_status || 'N/A'}</div>
                        <div>${record.defects_exist || 'N/A'}</div>
                    `;
                    
                    // Update defects count
                    const defects = data.filter(r => r.defects_exist === 'Yes').length;
                    setTextContent('boilerDefects', defects);
                    setTextContent('boilerRecent', data.length);
                } else if (category === 'electrical') {
                    const description = record.job_description || 'N/A';
                    const descriptionHtml = description.length > 50 ? 
                        `<span class="truncated-text" onclick="showDescriptionModal('Electrical Permit', ${JSON.stringify(record).replace(/"/g, '&quot;')}, '${description.replace(/'/g, "\\'")}', event)">
                            ${truncate(description, 50)}
                        </span>` : description;
                    
                    row.innerHTML = `
                        <div>${record.filing_number || 'N/A'}</div>
                        <div>${record.filing_status || 'N/A'}</div>
                        <div>${formatDate(record.filing_date)}</div>
                        <div>${descriptionHtml}</div>
                    `;
                }
                
                recordsContainer.appendChild(row);
            });
            
            if (data.length > 10) {
                const moreRow = document.createElement('div');
                moreRow.className = 'record-row';
                moreRow.innerHTML = `<div style="text-align: center; color: #666; font-style: italic; grid-column: 1/-1;">... and ${data.length - 10} more records</div>`;
                recordsContainer.appendChild(moreRow);
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            
            // Convert string to string if it's a number
            const dateString = String(dateStr);
            
            try {
                // Handle YYYYMMDD format (e.g., "20240802")
                if (/^\d{8}$/.test(dateString)) {
                    const year = dateString.substring(0, 4);
                    const month = dateString.substring(4, 6);
                    const day = dateString.substring(6, 8);
                    const date = new Date(year, month - 1, day); // month is 0-indexed
                    
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString();
                    }
                }
                
                // Handle standard date formats
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString();
                }
                
                // If all else fails, return the original string
                return dateString;
            } catch {
                return dateString;
            }
        }
        
        function truncate(str, length) {
            if (!str) return 'N/A';
            return str.length > length ? str.substring(0, length) + '...' : str;
        }
        
        function getScoreClass(score) {
            if (score >= 95) return 'score-excellent';
            if (score >= 85) return 'score-good';
            if (score >= 70) return 'score-warning';
            return 'score-critical';
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }
        
        function showDescriptionModal(title, record, description, event) {
            // Prevent event bubbling to parent elements
            if (event) {
                event.stopPropagation();
            }
            
            const modal = document.getElementById('descriptionModal');
            const modalTitle = document.getElementById('modalTitle');
            const violationDetails = document.getElementById('violationDetails');
            const fullDescription = document.getElementById('fullDescription');
            
            // Set modal title
            if (modalTitle) modalTitle.textContent = title;
            
            // Set full description
            if (fullDescription) fullDescription.innerHTML = `<p><strong>Full Description:</strong></p><p>${description}</p>`;
            
            // Set violation details based on type
            let detailsHtml = '';
            if (title === 'HPD Violation') {
                detailsHtml = `
                    <div class="detail-item"><strong>Violation ID:</strong> ${record.violationid || 'N/A'}</div>
                    <div class="detail-item"><strong>Status:</strong> ${record.violationstatus || 'N/A'}</div>
                    <div class="detail-item"><strong>Current Status:</strong> ${record.currentstatus || 'N/A'}</div>
                    <div class="detail-item"><strong>Approved Date:</strong> ${formatDate(record.approveddate)}</div>
                    <div class="detail-item"><strong>Rent Impairing:</strong> ${record.rentimpairing || 'N/A'}</div>
                `;
            } else if (title === 'DOB Violation') {
                detailsHtml = `
                    <div class="detail-item"><strong>Violation ID:</strong> ${record.isn_dob_bis_viol || 'N/A'}</div>
                    <div class="detail-item"><strong>Category:</strong> ${record.violation_category || 'N/A'}</div>
                    <div class="detail-item"><strong>Type:</strong> ${record.violation_type || 'N/A'}</div>
                    <div class="detail-item"><strong>Issue Date:</strong> ${formatDate(record.issue_date)}</div>
                    <div class="detail-item"><strong>Disposition:</strong> ${record.disposition_comments || 'N/A'}</div>
                `;
            } else if (title === 'Electrical Permit') {
                detailsHtml = `
                    <div class="detail-item"><strong>Filing Number:</strong> ${record.filing_number || 'N/A'}</div>
                    <div class="detail-item"><strong>Filing Date:</strong> ${formatDate(record.filing_date)}</div>
                    <div class="detail-item"><strong>Status:</strong> ${record.filing_status || 'N/A'}</div>
                    <div class="detail-item"><strong>Applicant:</strong> ${record.applicant_first_name || ''} ${record.applicant_last_name || ''}</div>
                    <div class="detail-item"><strong>Completion Date:</strong> ${formatDate(record.completion_date)}</div>
                    <div class="detail-item"><strong>Amount Paid:</strong> $${record.amount_paid || 'N/A'}</div>
                `;
            }
            
            if (violationDetails) violationDetails.innerHTML = detailsHtml;
            
            // Show modal
            modal.style.display = 'flex';
            
            // Add click outside to close
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            };
        }
        
        function closeModal() {
            const modal = document.getElementById('descriptionModal');
            modal.style.display = 'none';
            
            // Remove click outside handler
            modal.onclick = null;
        }
        
        // AI Analysis Polling Function
        let pollingTimer = null;
        let currentAnalysisId = null;
        const MAX_POLLING_ATTEMPTS = 30; // Maximum number of polling attempts (5 minutes at 10s intervals)
        const POLLING_INTERVAL = 10000; // 10 seconds between polling attempts (more responsive)
        
        function cancelAIAnalysis() {
            console.log('User canceled AI analysis');
            
            // Clear polling timer
            if (pollingTimer) {
                clearInterval(pollingTimer);
                pollingTimer = null;
            }
            
            // Hide loading state and show a cancel message
            document.getElementById('aiLoadingState').style.display = 'none';
            document.getElementById('aiResultsState').style.display = 'block';
            
            // Show cancellation message in the results area
            const riskAssessment = document.getElementById('riskAssessmentContainer');
            if (riskAssessment) {
                riskAssessment.innerHTML = `
                    <div class="risk-assessment-header">
                        <h3>Analysis Canceled</h3>
                        <div class="confidence-badge" style="background: rgba(108, 117, 125, 0.2); color: #6c757d;">
                            <i class="fas fa-times-circle"></i> Canceled by User
                        </div>
                    </div>
                    <div class="risk-summary">
                        <p style="color: var(--text-secondary);">
                            AI analysis was canceled. You can still review the property compliance data above, or try running the analysis again.
                        </p>
                        <button type="button" class="btn btn-primary btn-sm" onclick="location.reload()">
                            <i class="fas fa-refresh"></i> Try Again
                        </button>
                    </div>
                `;
            }
            
            currentAnalysisId = null;
        }
        
        async function startPollingForAIAnalysis(analysisId) {
            let attempts = 0;
            currentAnalysisId = analysisId;
            
            // Clear any existing polling timer
            if (pollingTimer) {
                clearInterval(pollingTimer);
            }
            
            // Update loading message
            const loadingMessage = document.getElementById('aiLoadingMessage');
            if (loadingMessage) {
                loadingMessage.textContent = 'AI analysis in progress... This may take a minute or two.';
            }
            
            // Show cancel button after 30 seconds
            setTimeout(() => {
                const cancelButton = document.getElementById('aiCancelButton');
                if (cancelButton && currentAnalysisId === analysisId) {
                    cancelButton.style.display = 'block';
                }
            }, 30000);
            
            // Define the polling function
            async function pollForResults() {
                attempts++;
                console.log(`Polling for AI analysis results (attempt ${attempts}/${MAX_POLLING_ATTEMPTS})`);
                
                try {
                    const response = await fetch(`/api/ai-analysis/${analysisId}`);
                    const data = await response.json();
                    
                    console.log('Polling response:', data);
                    
                    if (data.success) {
                        if (data.status === 'completed' && data.analysis) {
                            // We have results! Stop polling and display them
                            clearInterval(pollingTimer);
                            pollingTimer = null;
                            currentAnalysisId = null;
                            
                            // Hide cancel button
                            const cancelButton = document.getElementById('aiCancelButton');
                            if (cancelButton) {
                                cancelButton.style.display = 'none';
                            }
                            
                            console.log('AI analysis completed, displaying results');
                            displayAIAnalysisCompact(data.analysis);
                        } else if (data.status === 'failed') {
                            // Analysis failed, stop polling and show error
                            clearInterval(pollingTimer);
                            pollingTimer = null;
                            
                            console.error('AI analysis failed:', data.error);
                            showAIAnalysisError('Analysis failed: ' + (data.error || 'Unknown error'));
                        }
                        // If status is still 'pending', continue polling
                    } else {
                        // API error
                        console.error('Error polling for AI analysis:', data.message);
                        
                        // If we've reached max attempts, stop polling and show error
                        if (attempts >= MAX_POLLING_ATTEMPTS) {
                            clearInterval(pollingTimer);
                            pollingTimer = null;
                            showAIAnalysisError('Analysis timed out. Please try again later.');
                        }
                    }
                } catch (error) {
                    console.error('Network error while polling:', error);
                    
                    // If we've reached max attempts, stop polling and show error
                    if (attempts >= MAX_POLLING_ATTEMPTS) {
                        clearInterval(pollingTimer);
                        pollingTimer = null;
                        showAIAnalysisError('Network error while retrieving analysis results.');
                    }
                }
                
                // Update loading message with time and progress
                if (loadingMessage && pollingTimer) {
                    const timeElapsed = Math.floor((attempts * POLLING_INTERVAL) / 1000);
                    const progressPercent = Math.min(Math.floor((attempts / MAX_POLLING_ATTEMPTS) * 100), 95);
                    loadingMessage.textContent = `AI analysis in progress... ${timeElapsed}s elapsed (${progressPercent}% complete)`;
                }
            }
            
            // Start polling immediately
            await pollForResults();
            
            // Then set up interval for continued polling
            pollingTimer = setInterval(pollForResults, POLLING_INTERVAL);
        }
        
        function displayEnhancedAIAnalysis(aiData) {
            console.log('Displaying enhanced AI analysis:', aiData);
            
            // Handle both direct property_analysis and nested output structure
            const analysis = aiData.property_analysis || aiData.output?.property_analysis;
            if (!analysis) {
                console.error('No property_analysis found in AI data');
                return;
            }
            
            // Show the AI analysis results section
            document.getElementById('aiAnalysisResults').style.display = 'block';
            
            // Populate Analysis Header
            setTextContent('analysisTimestamp', formatTimestamp(analysis.analysis_timestamp));
            setTextContent('aiConfidenceLevel', aiData.ai_confidence || 'High');
            
            // Populate Key Metrics
            if (analysis.overall_risk_assessment) {
                setTextContent('overallRiskScore', analysis.overall_risk_assessment.risk_score || '-');
                setTextContent('overallRiskLevel', analysis.overall_risk_assessment.risk_level || '-');
            }
            
            if (analysis.data_freshness) {
                setTextContent('dataFreshnessDate', analysis.data_freshness.compliance_data_date || '-');
            }
            
            // Populate Executive Summary
            if (analysis.overall_risk_assessment) {
                setTextContent('riskSummaryText', analysis.overall_risk_assessment.risk_summary || '-');
                
                // Populate primary risk factors
                const riskFactorsList = document.getElementById('primaryRiskFactors');
                if (riskFactorsList && analysis.overall_risk_assessment.primary_risk_factors) {
                    riskFactorsList.innerHTML = '';
                    analysis.overall_risk_assessment.primary_risk_factors.forEach(factor => {
                        const li = document.createElement('li');
                        li.textContent = factor;
                        riskFactorsList.appendChild(li);
                    });
                }
            }
            
            // Add recommendations summary
            setTextContent('recommendationsSummary', aiData.recommendations_summary || analysis.recommendations_summary || '-');
            
            // Populate Compliance Insights
            if (analysis.compliance_insights) {
                const insights = analysis.compliance_insights;
                setTextContent('complianceTrajectory', insights.compliance_trajectory || '-');
                setTextContent('trendsAnalysis', insights.trends_analysis || '-');
                
                // Populate strengths
                const strengthsList = document.getElementById('complianceStrengths');
                if (strengthsList && insights.strengths) {
                    strengthsList.innerHTML = '';
                    insights.strengths.forEach(strength => {
                        const li = document.createElement('li');
                        li.textContent = strength;
                        strengthsList.appendChild(li);
                    });
                }
                
                // Populate immediate concerns
                const concernsList = document.getElementById('immediateConcerns');
                if (concernsList && insights.immediate_concerns) {
                    concernsList.innerHTML = '';
                    insights.immediate_concerns.forEach(concern => {
                        const li = document.createElement('li');
                        li.textContent = concern;
                        concernsList.appendChild(li);
                    });
                }
            }
            
            // Populate Priority Actions
            if (analysis.priority_actions) {
                const actionsList = document.getElementById('priorityActionsList');
                if (actionsList) {
                    actionsList.innerHTML = '';
                    
                    // Count actions by priority
                    let criticalCount = 0, highCount = 0, mediumCount = 0;
                    
                    analysis.priority_actions.forEach(action => {
                        const actionItem = createDetailedActionItem(action);
                        actionsList.appendChild(actionItem);
                        
                        // Count by priority
                        const priority = (action.priority || '').toLowerCase();
                        if (priority === 'critical') criticalCount++;
                        else if (priority === 'high') highCount++;
                        else if (priority === 'medium') mediumCount++;
                    });
                    
                    // Update summary cards
                    setTextContent('actionsCount', `${analysis.priority_actions.length} actions`);
                    setTextContent('criticalCount', criticalCount.toString());
                    setTextContent('highCount', highCount.toString());
                    setTextContent('mediumCount', mediumCount.toString());
                }
            }
            
            // Populate Financial Impact
            if (analysis.financial_impact) {
                const financial = analysis.financial_impact;
                setTextContent('totalExposure', financial.immediate_exposure || '-');
                setTextContent('immediateExposure', financial.immediate_exposure || '-');
                setTextContent('annualComplianceCosts', financial.annual_compliance_costs || '-');
                setTextContent('priorityInvestment', financial.priority_investment || '-');
                setTextContent('potentialFines', financial.potential_fines || '-');
                setTextContent('maintenanceCosts', financial.maintenance_costs || '-');
                setTextContent('costBenefitAnalysis', financial.cost_benefit_analysis || '-');
                
                // Populate cost breakdown
                const breakdownGrid = document.getElementById('costBreakdownGrid');
                if (breakdownGrid && financial.cost_breakdown) {
                    breakdownGrid.innerHTML = '';
                    Object.entries(financial.cost_breakdown).forEach(([category, cost]) => {
                        const breakdownItem = document.createElement('div');
                        breakdownItem.className = 'breakdown-item';
                        breakdownItem.innerHTML = `
                            <div class="breakdown-category">${category.replace('_', ' ').toUpperCase()}</div>
                            <div class="breakdown-value">${cost}</div>
                        `;
                        breakdownGrid.appendChild(breakdownItem);
                    });
                }
            }
            
            // Populate Equipment Monitoring
            if (analysis.equipment_monitoring) {
                const equipment = analysis.equipment_monitoring;
                
                // Update equipment summary and counts
                let totalDevices = 0;
                if (equipment.elevators) {
                    setTextContent('elevatorCount', equipment.elevators.total_devices || '0');
                    totalDevices += parseInt(equipment.elevators.total_devices || 0);
                }
                if (equipment.boilers) {
                    setTextContent('boilerCount', equipment.boilers.total_devices || '0');
                    totalDevices += parseInt(equipment.boilers.total_devices || 0);
                }
                if (equipment.electrical) {
                    setTextContent('electricalCount', equipment.electrical.active_permits || '0');
                }
                
                setTextContent('equipmentSummary', `${totalDevices} total devices`);
                
                // Populate detailed equipment tabs with comprehensive devices data when available
                const equipmentData = data.comprehensive_devices ? {
                    elevators: data.comprehensive_devices.elevators,
                    boilers: data.comprehensive_devices.boilers,
                    electrical: data.comprehensive_devices.electrical_permits
                } : equipment;
                populateDetailedEquipmentTabs(equipmentData, data.comprehensive_devices ? true : false);
            }
            
            // Populate Regulatory Intelligence
            if (analysis.regulatory_intelligence) {
                const regulatory = analysis.regulatory_intelligence;
                setTextContent('upcomingInspections', regulatory.upcoming_inspections || '-');
                setTextContent('seasonalConsiderations', regulatory.seasonal_considerations || '-');
                setTextContent('regulatoryChanges', regulatory.regulatory_changes || '-');
                setTextContent('monitoringSchedule', regulatory.monitoring_schedule || '-');
                
                // Populate best practices
                const bestPracticesList = document.getElementById('bestPracticesList');
                if (bestPracticesList && regulatory.best_practices) {
                    bestPracticesList.innerHTML = '';
                    regulatory.best_practices.forEach(practice => {
                        const li = document.createElement('li');
                        li.textContent = practice;
                        bestPracticesList.appendChild(li);
                    });
                }
            }
        }
        
        function createDetailedActionItem(action) {
            const item = document.createElement('div');
            item.className = `priority-action-item ${(action.priority || '').toLowerCase()}`;
            
            // Safely extract data with proper fallbacks
            const actionId = action.id || `action_${Date.now()}`;
            const title = action.title || 'Action Required';
            const category = action.category || 'General';
            const priority = action.priority || 'Medium';
            const actionText = action.action || 'No action specified';
            const reason = action.reason || '';
            
            // Financial impact with safe extraction
            const financial = action.financial_impact || {};
            const estimatedCost = financial.estimated_cost || 'Not specified';
            const potentialPenalty = financial.potential_penalty || 'Not specified';
            const penaltyEscalation = financial.penalty_escalation || '';
            const costBenefit = financial.cost_benefit || '';
            
            // Timeline with safe extraction
            const timeline = action.timeline || {};
            const urgency = timeline.urgency || 'Not specified';
            const deadline = timeline.deadline || 'Not specified';
            const consequences = timeline.consequences || 'Not specified';
            
            // Regulatory context
            const regulatory = action.regulatory_context || {};
            const regulationRef = regulatory.regulation_reference || '';
            const penaltySchedule = regulatory.penalty_schedule || '';
            const filingRequirements = regulatory.filing_requirements || '';
            
            item.innerHTML = `
                <div class="action-item-header" onclick="toggleActionItem('${actionId}')">
                    <div class="action-main-info">
                        <div class="action-title">${title}</div>
                        <div class="action-category-badge">${category}</div>
                        <div class="action-priority-badge ${priority.toLowerCase()}">${priority}</div>
                    </div>
                    <div class="action-summary">
                        <span class="cost-summary">${estimatedCost}</span>
                        <i class="fas fa-chevron-down expand-icon" id="${actionId}-icon"></i>
                    </div>
                </div>
                <div class="action-item-content" id="${actionId}-content" style="display: none;">
                    <div class="action-description">
                        <h4>Action Required</h4>
                        <p>${actionText}</p>
                        ${reason ? `<p><strong>Reason:</strong> ${reason}</p>` : ''}
                    </div>
                    
                    <div class="action-details-grid">
                        <div class="detail-section financial">
                            <h4><i class="fas fa-dollar-sign"></i> Financial Impact</h4>
                            <div class="detail-items">
                                <div class="detail-item">
                                    <span class="detail-label">Estimated Cost:</span>
                                    <span class="detail-value">${estimatedCost}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Potential Penalty:</span>
                                    <span class="detail-value">${potentialPenalty}</span>
                                </div>
                                ${penaltyEscalation ? `
                                <div class="detail-item">
                                    <span class="detail-label">Penalty Escalation:</span>
                                    <span class="detail-value">${penaltyEscalation}</span>
                                </div>` : ''}
                                ${costBenefit ? `
                                <div class="detail-item">
                                    <span class="detail-label">Cost vs Benefit:</span>
                                    <span class="detail-value">${costBenefit}</span>
                                </div>` : ''}
                            </div>
                        </div>
                        
                        <div class="detail-section timeline">
                            <h4><i class="fas fa-clock"></i> Timeline</h4>
                            <div class="detail-items">
                                <div class="detail-item">
                                    <span class="detail-label">Urgency:</span>
                                    <span class="detail-value urgency-${urgency.toLowerCase().replace('_', '-')}">${urgency}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Deadline:</span>
                                    <span class="detail-value">${deadline}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Consequences:</span>
                                    <span class="detail-value">${consequences}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${regulationRef || penaltySchedule || filingRequirements ? `
                        <div class="detail-section regulatory">
                            <h4><i class="fas fa-gavel"></i> Regulatory Context</h4>
                            <div class="detail-items">
                                ${regulationRef ? `
                                <div class="detail-item">
                                    <span class="detail-label">Regulation:</span>
                                    <span class="detail-value">${regulationRef}</span>
                                </div>` : ''}
                                ${penaltySchedule ? `
                                <div class="detail-item">
                                    <span class="detail-label">Penalty Schedule:</span>
                                    <span class="detail-value">${penaltySchedule}</span>
                                </div>` : ''}
                                ${filingRequirements ? `
                                <div class="detail-item">
                                    <span class="detail-label">Filing Requirements:</span>
                                    <span class="detail-value">${filingRequirements}</span>
                                </div>` : ''}
                            </div>
                        </div>` : ''}
                    </div>
                </div>
            `;
            
            return item;
        }
        
        function populateEquipmentTabs(equipment) {
            // Populate Elevators tab with device-specific information
            if (equipment.elevators) {
                const elevatorsPanel = document.getElementById('elevators-panel');
                if (elevatorsPanel) {
                    const elevatorData = equipment.elevators;
                    
                    // Handle individual elevator devices if available
                    let deviceList = '';
                    if (elevatorData.devices && Array.isArray(elevatorData.devices)) {
                        deviceList = elevatorData.devices.map(device => `
                            <div class="device-card">
                                <h5>${device.device_id || 'Elevator Device'}</h5>
                                <p><strong>Status:</strong> ${device.status || 'Unknown'}</p>
                                <p><strong>Last Inspection:</strong> ${device.last_inspection || 'Not specified'}</p>
                                <p><strong>Next Due:</strong> ${device.next_due || 'Not specified'}</p>
                                ${device.compliance_gaps ? `<p><strong>Issues:</strong> ${device.compliance_gaps.join(', ')}</p>` : ''}
                            </div>
                        `).join('');
                    }
                    
                    elevatorsPanel.innerHTML = `
                        <div class="equipment-summary">
                            <h4>Elevator Overview</h4>
                            <p><strong>Total Devices:</strong> ${elevatorData.total_devices || '-'}</p>
                            <p><strong>Active Devices:</strong> ${elevatorData.active_devices || '-'}</p>
                            <p><strong>Estimated Annual Costs:</strong> ${elevatorData.estimated_annual_costs || '-'}</p>
                        </div>
                        ${deviceList ? `<div class="device-list">${deviceList}</div>` : ''}
                        <div class="equipment-requirements">
                            <h4>CAT-1 Requirements</h4>
                            <ul>${(elevatorData.cat1_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                            <h4>CAT-5 Requirements</h4>
                            <ul>${(elevatorData.cat5_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                            <h4>Compliance Gaps</h4>
                            <ul>${(elevatorData.compliance_gaps || []).map(gap => `<li style="color: #dc3545;">${gap}</li>`).join('')}</ul>
                        </div>
                    `;
                }
            }
            
            // Populate Boilers tab with comprehensive or legacy data
            if (equipment.boilers) {
                const boilersPanel = document.getElementById('boilers-panel');
                if (boilersPanel) {
                    if (isComprehensive && Array.isArray(equipment.boilers)) {
                        // Handle comprehensive boiler devices data
                        const uniqueBoilers = new Map();
                        equipment.boilers.forEach(device => {
                            const id = device.boiler_id || device.device_id || 'Unknown';
                            if (!uniqueBoilers.has(id)) {
                                uniqueBoilers.set(id, {
                                    id: id,
                                    type: device.boiler_type || 'Boiler',
                                    inspections: [],
                                    hasDefects: false
                                });
                            }
                            uniqueBoilers.get(id).inspections.push(device);
                            if (device.deficiency_description || device.test_results) {
                                const defectText = (device.deficiency_description || device.test_results || '').toLowerCase();
                                if (defectText.includes('fail') || defectText.includes('defect') || defectText.includes('violation')) {
                                    uniqueBoilers.get(id).hasDefects = true;
                                }
                            }
                        });
                        
                        const deviceList = Array.from(uniqueBoilers.values()).map(device => `
                            <div class="device-item ${device.hasDefects ? 'has-defects' : ''}">
                                <div class="device-header">
                                    <strong>${device.id}</strong>
                                    <span class="device-type">${device.type}</span>
                                    ${device.hasDefects ? '<span class="defect-indicator"><i class="fas fa-exclamation-triangle"></i> Issues Found</span>' : '<span class="compliant-indicator"><i class="fas fa-check"></i> Compliant</span>'}
                                </div>
                                <div class="device-stats">
                                    <span>Inspections: ${device.inspections.length}</span>
                                    <span>Latest: ${device.inspections.length > 0 ? (device.inspections[0].inspection_date || 'N/A') : 'N/A'}</span>
                                </div>
                            </div>
                        `).join('');
                        
                        boilersPanel.innerHTML = `
                            <div class="equipment-summary">
                                <h4>Comprehensive Boiler Data</h4>
                                <p><strong>Unique Devices:</strong> ${uniqueBoilers.size}</p>
                                <p><strong>Total Inspections:</strong> ${equipment.boilers.length}</p>
                                <p><strong>Devices with Issues:</strong> ${Array.from(uniqueBoilers.values()).filter(d => d.hasDefects).length}</p>
                            </div>
                            <div class="devices-list">
                                <h4>Device Details</h4>
                                ${deviceList || '<p>No boiler devices found</p>'}
                            </div>
                        `;
                    } else {
                        // Handle legacy equipment data
                        boilersPanel.innerHTML = `
                            <div class="equipment-summary">
                                <h4>Boiler Overview</h4>
                                <p><strong>Total Devices:</strong> ${equipment.boilers.total_devices || '-'}</p>
                                <p><strong>Inspection Status:</strong> ${equipment.boilers.inspection_status || '-'}</p>
                                <p><strong>Estimated Annual Costs:</strong> ${equipment.boilers.estimated_annual_costs || '-'}</p>
                            </div>
                            <div class="equipment-requirements">
                                <h4>Filing Requirements</h4>
                                <ul>${(equipment.boilers.filing_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                                <h4>Compliance Gaps</h4>
                                <ul>${(equipment.boilers.compliance_gaps || []).map(gap => `<li style="color: #dc3545;">${gap}</li>`).join('')}</ul>
                            </div>
                        `;
                    }
                }
            }
            
            // Populate Electrical tab
            if (equipment.electrical) {
                const electricalPanel = document.getElementById('electrical-panel');
                if (electricalPanel) {
                    electricalPanel.innerHTML = `
                        <div class="equipment-summary">
                            <h4>Electrical Overview</h4>
                            <p><strong>Active Permits:</strong> ${equipment.electrical.active_permits || '-'}</p>
                            <p><strong>Status:</strong> ${equipment.electrical.status_summary || '-'}</p>
                        </div>
                        <div class="equipment-requirements">
                            <h4>Actions Needed</h4>
                            <ul>${(equipment.electrical.action_needed || []).map(action => `<li>${action}</li>`).join('')}</ul>
                        </div>
                    `;
                }
            }
        }
        
        function toggleActionItem(actionId) {
            const content = document.getElementById(`${actionId}-content`);
            const icon = document.getElementById(`${actionId}-icon`);
            
            if (content && icon) {
                const isVisible = content.style.display !== 'none';
                content.style.display = isVisible ? 'none' : 'block';
                icon.className = isVisible ? 'fas fa-chevron-down expand-icon' : 'fas fa-chevron-up expand-icon';
            }
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch (e) {
                return timestamp;
            }
        }
        
        function updateComplianceScoreCard(score, reportDate) {
            // Update score value and progress
            const scoreElement = document.getElementById('overallScoreProminent');
            const progressElement = document.getElementById('circularProgress');
            const statusElement = document.getElementById('statusText');
            const cardElement = document.getElementById('complianceScoreCard');
            const dateElement = document.getElementById('reportDate');
            
            if (scoreElement) {
                scoreElement.textContent = score;
            }
            
            if (progressElement) {
                progressElement.style.setProperty('--progress', score);
            }
            
            // Determine status based on score
            let status = 'excellent';
            let statusText = 'Excellent';
            let progressColor = '#10b981';
            
            if (score < 50) {
                status = 'critical';
                statusText = 'Critical';
                progressColor = '#ef4444';
            } else if (score < 70) {
                status = 'caution';
                statusText = 'Caution';
                progressColor = '#f59e0b';
            } else if (score < 90) {
                status = 'good';
                statusText = 'Good';
                progressColor = '#10b981';
            }
            
            // Update status chip
            if (statusElement) {
                statusElement.textContent = statusText;
                statusElement.className = `status-text ${status}`;
            }
            
            // Update card styling
            if (cardElement) {
                cardElement.className = `compliance-score-card status-${status}`;
            }
            
            // Update circular progress colors
            if (progressElement) {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                let bgColor, shadowColor;
                
                if (status === 'excellent') {
                    bgColor = isDark ? '#047857' : '#059669';
                    shadowColor = isDark ? 'rgba(4, 120, 87, 0.4)' : 'rgba(5, 150, 105, 0.3)';
                } else if (status === 'good') {
                    bgColor = isDark ? '#059669' : '#10b981';
                    shadowColor = isDark ? 'rgba(5, 150, 105, 0.3)' : 'rgba(16, 185, 129, 0.2)';
                } else if (status === 'caution') {
                    bgColor = isDark ? '#d97706' : '#f59e0b';
                    shadowColor = isDark ? 'rgba(217, 119, 6, 0.3)' : 'rgba(245, 158, 11, 0.2)';
                } else {
                    bgColor = isDark ? '#dc2626' : '#ef4444';
                    shadowColor = isDark ? 'rgba(220, 38, 38, 0.3)' : 'rgba(239, 68, 68, 0.2)';
                }
                
                const grayColor = isDark ? 'rgba(255, 255, 255, 0.08)' : 'rgba(0, 0, 0, 0.1)';
                progressElement.style.background = `conic-gradient(${bgColor} 0deg, ${bgColor} calc(var(--progress) * 3.6deg), ${grayColor} calc(var(--progress) * 3.6deg))`;
                progressElement.style.boxShadow = `0 4px 12px ${shadowColor}`;
            }
            
            // Update report date
            if (dateElement && reportDate) {
                const formattedDate = new Date(reportDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
                dateElement.textContent = `Report generated on: ${formattedDate}`;
            }
        }
        
        function populateDetailedEquipmentTabs(equipment, isComprehensive = false) {
            // Populate Elevators tab with detailed information
            if (equipment.elevators) {
                const elevatorsPanel = document.getElementById('elevators-panel');
                if (elevatorsPanel) {
                    const elevatorData = equipment.elevators;
                    
                    elevatorsPanel.innerHTML = `
                        <div class="equipment-overview">
                            <div class="equipment-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Total Devices:</span>
                                    <span class="stat-value">${elevatorData.total_devices || '-'}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Active Devices:</span>
                                    <span class="stat-value">${elevatorData.active_devices || '-'}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Estimated Annual Costs:</span>
                                    <span class="stat-value">${elevatorData.estimated_annual_costs || '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="equipment-requirements">
                            <div class="requirement-section">
                                <h4><i class="fas fa-clipboard-check"></i> CAT-1 Requirements</h4>
                                <ul>${(elevatorData.cat1_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                            </div>
                            <div class="requirement-section">
                                <h4><i class="fas fa-clipboard-list"></i> CAT-5 Requirements</h4>
                                <ul>${(elevatorData.cat5_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                            </div>
                            <div class="requirement-section gaps">
                                <h4><i class="fas fa-exclamation-triangle"></i> Compliance Gaps</h4>
                                <ul>${(elevatorData.compliance_gaps || []).map(gap => `<li class="gap-item">${gap}</li>`).join('')}</ul>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Boiler tab handling is now done above in the comprehensive section
            
            // Populate Electrical tab with detailed information
            if (equipment.electrical) {
                const electricalPanel = document.getElementById('electrical-panel');
                if (electricalPanel) {
                    const electricalData = equipment.electrical;
                    
                    electricalPanel.innerHTML = `
                        <div class="equipment-overview">
                            <div class="equipment-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Active Permits:</span>
                                    <span class="stat-value">${electricalData.active_permits || '-'}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Status Summary:</span>
                                    <span class="stat-value">${electricalData.status_summary || '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="equipment-requirements">
                            <div class="requirement-section">
                                <h4><i class="fas fa-tasks"></i> Actions Needed</h4>
                                <ul>${(electricalData.action_needed || []).map(action => `<li>${action}</li>`).join('')}</ul>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // Expandable sections functionality
        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const icon = document.getElementById(`${sectionId}-icon`);
            
            if (content && icon) {
                const isExpanded = content.classList.contains('expanded');
                
                if (isExpanded) {
                    content.classList.remove('expanded');
                    icon.classList.remove('rotated');
                } else {
                    content.classList.add('expanded');
                    icon.classList.add('rotated');
                }
            }
        }
        
        // Tab functionality for equipment monitoring
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and panels
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanels.forEach(panel => panel.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding panel
                    this.classList.add('active');
                    document.getElementById(`${tabName}-panel`).classList.add('active');
                });
            });
            
            // Auto-expand first section by default
            const firstSection = document.querySelector('.expandable-section');
            if (firstSection) {
                const firstSectionId = firstSection.querySelector('.section-content').id.replace('-content', '');
                toggleSection(firstSectionId);
            }
        });
        
        function showAIAnalysisError(errorMessage) {
            // Show error state
            document.getElementById('aiLoadingState').style.display = 'none';
            document.getElementById('aiResultsState').style.display = 'block';
            
            // Update header to show error
            const confidenceBadge = document.getElementById('aiConfidenceBadge');
            if (confidenceBadge) {
                confidenceBadge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                confidenceBadge.style.background = 'rgba(220, 38, 38, 0.2)';
            }
            
            // Show error in risk assessment
            const riskContainer = document.getElementById('riskAssessmentContainer');
            if (riskContainer) {
                riskContainer.className = 'risk-assessment-enhanced risk-critical-border';
            }
            
            const riskBadge = document.getElementById('riskBadgeEnhanced');
            if (riskBadge) {
                riskBadge.textContent = 'ERROR';
                riskBadge.className = 'risk-badge-enhanced risk-critical';
            }
            
            const riskSummary = document.getElementById('riskSummaryEnhanced');
            if (riskSummary) {
                riskSummary.textContent = errorMessage || 'Unable to process AI analysis at this time.';
            }
            
            const actionsGrid = document.getElementById('actionsGrid');
            if (actionsGrid) {
                actionsGrid.innerHTML = `
                    <div class="action-card-enhanced action-critical">
                        <div class="action-title-enhanced">AI Analysis Temporarily Unavailable</div>
                        <div class="action-reason">Our AI service is currently experiencing issues. The compliance data shown above remains accurate and actionable.</div>
                    </div>
                `;
            }
        }
        
        // Dark Mode Toggle Functionality
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update toggle icons
            const lightIcon = document.querySelector('.light-icon');
            const darkIcon = document.querySelector('.dark-icon');
            
            if (newTheme === 'dark') {
                lightIcon.style.display = 'none';
                darkIcon.style.display = 'block';
            } else {
                lightIcon.style.display = 'block';
                darkIcon.style.display = 'none';
            }
        }
        
        // Initialize theme from localStorage
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            // Update toggle icons based on saved theme
            const lightIcon = document.querySelector('.light-icon');
            const darkIcon = document.querySelector('.dark-icon');
            
            if (savedTheme === 'dark') {
                if (lightIcon) lightIcon.style.display = 'none';
                if (darkIcon) darkIcon.style.display = 'block';
            } else {
                if (lightIcon) lightIcon.style.display = 'block';
                if (darkIcon) darkIcon.style.display = 'none';
            }
        }
        
        // Scroll to top function for FAB
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
            // Clear address input and hide results
            document.getElementById('addressInput').value = '';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('addressInput').focus();
        }
        
        // Show/hide FAB based on scroll and screen size
        function toggleFAB() {
            const fab = document.querySelector('.fab-container');
            const isMobile = window.innerWidth <= 768;
            const scrolled = window.scrollY > 300;
            const hasResults = document.getElementById('resultsSection').style.display !== 'none';
            
            if (fab) {
                fab.style.display = (isMobile && (scrolled || hasResults)) ? 'block' : 'none';
            }
        }
        
        // Initialize everything when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Propply AI Report page loaded');
            
            // Initialize theme first
            initializeTheme();
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Setup FAB visibility
            window.addEventListener('scroll', toggleFAB);
            window.addEventListener('resize', toggleFAB);
            toggleFAB(); // Initial check
            
            // Add animation classes to cards when they come into view
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-fade-in-up');
                    }
                });
            }, observerOptions);
            
            // Observe all cards for animation
            const cards = document.querySelectorAll('.risk-assessment-enhanced, .priority-actions-enhanced, .action-card-enhanced, .detailed-analysis');
            cards.forEach(card => observer.observe(card));
        });
        
    </script>
</body>
</html>