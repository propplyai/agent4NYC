<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Propply AI - Property Compliance Report</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyA4gSJ9LDVqQ9AVxw3zVoHSQQVr_9W2V54&libraries=places"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .header .tagline {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .property-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .property-info {
            flex: 1;
        }
        
        .property-map {
            width: 300px;
            height: 200px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .search-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .search-form {
            display: flex;
            gap: 15px;
        }

        .search-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .analyze-btn {
            padding: 12px 25px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .analyze-btn:hover {
            background: #5a6fd8;
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .results-section {
            display: none;
        }

        .property-summary {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }

        .property-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 15px;
        }

        .property-meta-compact {
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            overflow: hidden;
        }
        
        .property-main-info {
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .address-section {
            cursor: pointer;
            flex: 1;
        }
        
        .address-display {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .address-text {
            font-weight: 600;
            color: #212529;
            font-size: 1rem;
        }
        
        .expand-icon {
            color: #6c757d;
            font-size: 0.8rem;
            transition: transform 0.2s ease;
        }
        
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        .compliance-score-under-address {
            margin-top: 4px;
            font-size: 0.9rem;
        }
        
        .score-text {
            color: #495057;
            font-weight: 500;
        }
        
        .score-text span {
            font-weight: 700;
            color: #28a745;
        }
        
        /* Enhanced Compliance Score Display */
        .compliance-score-prominent {
            background: linear-gradient(135deg, #28a745, #20c997);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: white;
            margin: 15px 0;
            box-shadow: 0 3px 12px rgba(40, 167, 69, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .compliance-score-prominent .score-number {
            font-size: 2.5rem;
            font-weight: 600;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .compliance-score-label {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.1rem;
            font-weight: 500;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .compliance-score-value {
            color: white;
            font-size: 4rem;
            font-weight: 800;
            line-height: 1;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: relative;
            z-index: 1;
        }
        
        .compliance-score-subtitle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.95rem;
            margin-top: 8px;
            font-weight: 400;
        }
        
        /* AI Analysis Results Sections */
        .ai-analysis-results {
            margin-top: 25px;
        }
        
        /* Expandable Sections */
        .expandable-section {
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .expandable-section:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.2s ease;
        }
        
        .section-header:hover {
            background: #e9ecef;
        }
        
        .section-header h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #495057;
        }
        
        .expand-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .expand-icon {
            transition: transform 0.3s ease;
            color: #6c757d;
        }
        
        .expand-icon.rotated {
            transform: rotate(180deg);
        }
        
        .section-content {
            padding: 20px;
            display: none;
        }
        
        .section-content.expanded {
            display: block;
        }
        
        /* Metric Cards */
        .risk-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #e9ecef;
        }
        
        .metric-label {
            font-size: 0.85rem;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #495057;
        }
        
        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .summary-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
            transition: all 0.2s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .summary-card.critical {
            border-color: #dc3545;
        }
        
        .summary-card.high {
            border-color: #fd7e14;
        }
        
        .summary-card.medium {
            border-color: #ffc107;
        }
        
        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .summary-card.critical .summary-number {
            color: #dc3545;
        }
        
        .summary-card.high .summary-number {
            color: #fd7e14;
        }
        
        .summary-card.medium .summary-number {
            color: #ffc107;
        }
        
        .summary-label {
            font-size: 0.85rem;
            color: #6c757d;
            font-weight: 500;
        }
        
        .ai-analysis-results > div {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 25px;
        }
        
        /* Data Freshness Section */
        .freshness-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .freshness-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .freshness-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .freshness-label {
            font-weight: 600;
            color: #495057;
        }
        
        .freshness-value {
            color: #28a745;
            font-weight: 500;
        }
        
        .confidence-badge {
            background: #28a745;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        /* Risk Assessment Section */
        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .risk-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .risk-level-badge {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .risk-level-badge.low { background: #d4edda; color: #155724; }
        .risk-level-badge.moderate { background: #fff3cd; color: #856404; }
        .risk-level-badge.high { background: #f8d7da; color: #721c24; }
        .risk-level-badge.critical { background: #dc3545; color: white; }
        
        .risk-score {
            margin-bottom: 15px;
        }
        
        .risk-score-label {
            font-weight: 600;
            color: #495057;
        }
        
        .risk-score-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #dc3545;
            margin-left: 10px;
        }
        
        .risk-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            line-height: 1.6;
        }
        
        .risk-factors h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .risk-factors ul {
            margin: 0;
            padding-left: 20px;
        }
        
        .risk-factors li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        /* Priority Actions Section */
        .actions-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .actions-subtitle {
            color: #6c757d;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }
        
        .actions-grid {
            display: grid;
            gap: 20px;
        }
        
        .action-card {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .action-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .action-card.critical {
            border-left: 4px solid #dc3545;
            background: #fff5f5;
        }
        
        .action-card.high {
            border-left: 4px solid #fd7e14;
            background: #fff8f0;
        }
        
        .action-card.medium {
            border-left: 4px solid #ffc107;
            background: #fffbf0;
        }
        
        .action-card.low {
            border-left: 4px solid #28a745;
            background: #f8fff9;
        }
        
        .action-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        
        .action-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .action-priority {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .action-priority.critical { background: #dc3545; color: white; }
        .action-priority.high { background: #fd7e14; color: white; }
        .action-priority.medium { background: #ffc107; color: #333; }
        .action-priority.low { background: #28a745; color: white; }
        
        .action-description {
            color: #495057;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .action-financial {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.03);
            border-radius: 8px;
        }
        
        .financial-item {
            display: flex;
            justify-content: space-between;
        }
        
        .financial-item-label {
            font-weight: 600;
            color: #495057;
        }
        
        .financial-item-value {
            font-weight: 600;
            color: #dc3545;
        }
        
        .action-expandable {
            cursor: pointer;
            color: #667eea;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .action-expandable:hover {
            text-decoration: underline;
        }
        
        .action-details {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        /* Financial Impact Section */
        .financial-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .financial-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .financial-card {
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #e9ecef;
        }
        
        .financial-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .financial-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .financial-value.critical { color: #dc3545; }
        .financial-value.moderate { color: #fd7e14; }
        .financial-value.positive { color: #28a745; }
        
        .financial-description {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .cost-breakdown h4 {
            color: #333;
            margin-bottom: 15px;
        }
        
        .breakdown-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .breakdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
        }
        
        .breakdown-label {
            font-weight: 500;
            color: #495057;
        }
        
        .breakdown-value {
            font-weight: 600;
            color: #333;
        }
        
        /* Equipment Monitoring Section */
        .equipment-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .equipment-subtitle {
            color: #6c757d;
            font-size: 0.95rem;
            margin-bottom: 20px;
        }
        
        .equipment-tabs {
            border: 1px solid #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .tab-buttons {
            display: flex;
            background: #f8f9fa;
        }
        
        .tab-button {
            flex: 1;
            padding: 15px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        
        .tab-button.active {
            background: white;
            color: #667eea;
            font-weight: 600;
        }
        
        .tab-button:hover {
            background: rgba(102, 126, 234, 0.1);
        }
        
        .tab-content {
            padding: 20px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
        }
        
        /* Regulatory Intelligence Section */
        .regulatory-header h3 {
            color: #333;
            font-size: 1.3rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .regulatory-item {
            margin-bottom: 20px;
        }
        
        .regulatory-item h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }
        
        .regulatory-item div {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            line-height: 1.6;
        }
        
        .regulatory-item ul {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 0;
            padding-left: 35px;
        }
        
        .regulatory-item li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .report-date-right {
            font-size: 0.8rem;
            color: #6c757d;
            margin-left: 16px;
        }
        
        .property-details-dropdown {
            border-top: 1px solid #e9ecef;
            background: #ffffff;
            padding: 12px 16px;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
        }
        
        .detail-label {
            font-weight: 500;
            color: #6c757d;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .detail-value {
            color: #212529;
            font-weight: 500;
            font-size: 0.85rem;
        }
        
        /* Compact Service Providers Styles */
        .service-providers-compact {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 16px;
            margin-top: 20px;
            border: 1px solid #e9ecef;
        }
        
        .providers-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .providers-header h3 {
            margin: 0;
            font-size: 1.1rem;
            color: #495057;
        }
        
        .providers-badge {
            background: #28a745;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .actions-count {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .device-list {
            margin: 20px 0;
        }
        
        .device-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
        }
        
        .device-card:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transform: translateY(-1px);
        }
        
        .device-card h5 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .device-card p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .device-card p strong {
            color: #495057;
        }
        
        .service-category {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 8px;
            overflow: hidden;
        }
        
        .service-category-header {
            padding: 10px 12px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #ffffff;
            border-bottom: 1px solid #dee2e6;
        }
        
        .service-category-header:hover {
            background: #f8f9fa;
        }
        
        .service-category-title {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }
        
        .service-category-count {
            background: #6c757d;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-right: 8px;
        }
        
        .service-providers-list {
            display: none;
            padding: 12px;
            background: #fafafa;
        }
        
        .service-provider {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .service-provider:last-child {
            border-bottom: none;
        }
        
        .provider-info {
            flex: 1;
        }
        
        .provider-name {
            font-weight: 600;
            color: #212529;
            font-size: 0.85rem;
        }
        
        .provider-details {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 2px;
        }
        
        .provider-contact {
            font-size: 0.8rem;
            color: #007bff;
            text-decoration: none;
        }
        
        .providers-footer {
            margin-top: 12px;
            font-size: 0.75rem;
            color: #6c757d;
            text-align: center;
        }

        .meta-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .meta-item:last-child {
            border-bottom: none;
        }

        .meta-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .meta-value {
            color: #212529;
            font-weight: 500;
            font-size: 1rem;
        }



        .score-warning { background: linear-gradient(135deg, #FF9800, #F57C00); }
        .score-critical { background: linear-gradient(135deg, #f44336, #d32f2f); }

        .compliance-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .table-header {
            background: #667eea;
            color: white;
            padding: 20px;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .compliance-row {
            border-bottom: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .compliance-row:hover {
            background: #f8f9fa;
        }

        .compliance-row.expanded {
            background: #f0f4ff;
        }

        .row-summary {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 60px;
            align-items: center;
            padding: 20px;
            gap: 20px;
        }

        .category-name {
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .category-icon {
            width: 20px;
            text-align: center;
        }

        .score-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
        }

        .score-excellent { background: #4CAF50; }
        .score-good { background: #2196F3; }
        .score-warning { background: #FF9800; }
        .score-critical { background: #f44336; }

        .status-summary {
            color: #666;
            font-size: 0.95rem;
        }

        .expand-icon {
            color: #666;
            transition: transform 0.3s ease;
        }

        .compliance-row.expanded .expand-icon {
            transform: rotate(90deg);
        }

        .row-details {
            display: none;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .compliance-row.expanded .row-details {
            display: block;
        }

        .details-content {
            padding: 25px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .detail-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border-left: 4px solid #667eea;
        }

        .detail-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .detail-list {
            list-style: none;
        }

        .detail-item {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-label {
            font-weight: 500;
            color: #666;
            min-width: 120px;
        }

        .detail-value {
            color: #333;
            text-align: right;
            flex: 1;
        }

        .records-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            margin-top: 20px;
        }

        .records-header {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .records-header, .record-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 2fr;
            gap: 15px;
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .record-row:last-child {
            border-bottom: none;
        }

        .record-row:nth-child(even) {
            background: #fafbfc;
        }

        .expandable-text {
            cursor: pointer;
            color: #667eea;
            transition: color 0.2s ease;
        }

        .expandable-text:hover {
            color: #5a6fd8;
            text-decoration: underline;
        }

        .description-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 80%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .close-btn:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .modal-body {
            line-height: 1.6;
            color: #333;
        }

        .violation-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-row strong {
            color: #666;
            min-width: 120px;
        }

        .description-text {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            font-size: 1rem;
            line-height: 1.6;
        }
        
        .violation-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .detail-item {
            margin-bottom: 8px;
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
        }
        
        .detail-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        
        /* Simplified Overall Score Display */
        .score-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
        }
        
        .score-circle-large {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: white;
            margin: 0 auto 15px;
            border: 3px solid rgba(255,255,255,0.3);
        }
        
        .score-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .score-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Enhanced AI Analysis Section */
        .ai-insights {
            background: linear-gradient(135deg, #f8f9fb 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 0;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e3e8ef;
        }
        
        .insights-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .insights-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.3rem;
            font-weight: 600;
        }
        
        .insights-title .ai-icon {
            font-size: 1.4rem;
            color: #FFD700;
        }
        
        .ai-confidence-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .ai-content {
            padding: 25px;
        }
        
        /* Risk Assessment Redesign */
        .risk-assessment-enhanced {
            background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
            border-left: 5px solid;
        }
        
        .risk-critical-border { border-left-color: #dc2626; }
        .risk-high-border { border-left-color: #ea580c; }
        .risk-moderate-border { border-left-color: #d97706; }
        .risk-low-border { border-left-color: #16a34a; }
        
        .risk-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        
        .risk-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .risk-badge-enhanced {
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .risk-critical { background: #fecaca; color: #dc2626; }
        .risk-high { background: #fed7aa; color: #ea580c; }
        .risk-moderate { background: #fde68a; color: #d97706; }
        .risk-low { background: #bbf7d0; color: #16a34a; }
        
        .risk-summary {
            font-size: 1rem;
            line-height: 1.6;
            color: #374151;
            margin-bottom: 15px;
        }
        
        .risk-factors {
            background: rgba(255,255,255,0.7);
            border-radius: 8px;
            padding: 15px;
        }
        
        .risk-factors-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .risk-factors-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .risk-factor-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: #4b5563;
        }
        
        .risk-factor-item:before {
            content: '•';
            color: #ef4444;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        /* Priority Actions Redesign */
        .priority-actions-enhanced {
            margin-bottom: 20px;
        }
        
        .actions-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 15px;
        }
        
        .action-card-enhanced {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .action-card-enhanced:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
        }
        
        .action-critical { border-left-color: #dc2626; }
        .action-high { border-left-color: #ea580c; }
        .action-medium { border-left-color: #d97706; }
        .action-low { border-left-color: #16a34a; }
        
        .action-header-enhanced {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .action-priority-enhanced {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .priority-critical { background: #fecaca; color: #dc2626; }
        .priority-high { background: #fed7aa; color: #ea580c; }
        .priority-medium { background: #fde68a; color: #d97706; }
        .priority-low { background: #bbf7d0; color: #16a34a; }
        
        .action-category {
            font-size: 0.8rem;
            color: #6b7280;
            font-weight: 500;
        }
        
        .action-title-enhanced {
            font-weight: 600;
            font-size: 1rem;
            color: #1f2937;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        
        .action-reason {
            font-size: 0.9rem;
            color: #4b5563;
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        .action-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid #f3f4f6;
        }
        
        .action-detail {
            text-align: center;
        }
        
        .action-detail-label {
            font-size: 0.7rem;
            color: #9ca3af;
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .action-detail-value {
            font-size: 0.9rem;
            color: #1f2937;
            font-weight: 600;
        }
        
        .ai-meta-enhanced {
            text-align: center;
            padding: 15px 25px;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
            font-size: 0.8rem;
            color: #6b7280;
            border-top: 1px solid #f3f4f6;
        }

        /* Vendor Marketplace Styles */
        .vendor-marketplace {
            background: linear-gradient(135deg, #f8fffe 0%, #ffffff 100%);
            border-radius: 12px;
            padding: 0;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e3f2f1;
        }
        
        .marketplace-badge {
            background: rgba(76, 175, 80, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            color: #2e7d32;
        }
        
        .vendor-content {
            padding: 25px;
        }
        
        .vendor-intro {
            margin-bottom: 20px;
            font-size: 1rem;
            color: #374151;
        }
        
        .vendor-categories {
            display: grid;
            gap: 20px;
        }
        
        .vendor-category {
            background: white;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }
        
        .vendor-category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .vendor-list {
            padding: 20px;
        }
        
        .vendor-card {
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 15px;
            padding: 15px;
            border: 1px solid #f3f4f6;
            border-radius: 8px;
            margin-bottom: 15px;
            transition: all 0.2s ease;
            align-items: center;
        }
        
        .vendor-card:hover {
            border-color: #667eea;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .vendor-card:last-child {
            margin-bottom: 0;
        }
        
        .vendor-info {
            min-width: 0;
        }
        
        .vendor-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
            margin-bottom: 5px;
        }
        
        .vendor-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.9rem;
            color: #6b7280;
        }
        
        .vendor-detail-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .vendor-rating {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .star-rating {
            color: #fbbf24;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        
        .vendor-distance {
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #6b7280;
            white-space: nowrap;
        }
        
        .vendor-actions {
            display: flex;
            gap: 8px;
        }
        
        .vendor-action-btn {
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            background: white;
            color: #374151;
            text-decoration: none;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .vendor-action-btn:hover {
            border-color: #667eea;
            color: #667eea;
            background: #f8f9ff;
        }
        
        .vendor-action-btn.primary {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .vendor-action-btn.primary:hover {
            background: #5a6fd8;
            border-color: #5a6fd8;
            color: white;
        }
        
        .vendor-meta {
            text-align: center;
            padding: 15px 25px;
            background: #f8fffe;
            border-radius: 0 0 12px 12px;
            font-size: 0.8rem;
            color: #6b7280;
            border-top: 1px solid #e3f2f1;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .truncated-text {
            cursor: pointer;
            color: #667eea;
            position: relative;
        }

        .truncated-text:hover {
            color: #5a6fd8;
        }

        .truncated-text::after {
            content: " (click to expand)";
            font-size: 0.85em;
            color: #999;
            font-style: italic;
        }

        .loading {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-message {
            background: #fff3f3;
            color: #d32f2f;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #d32f2f;
            margin-top: 20px;
        }

        /* Mobile Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .header .tagline {
                font-size: 1rem;
            }

            .row-summary {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .property-meta {
                grid-template-columns: 1fr;
            }
            
            .records-header, .record-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .search-form {
                flex-direction: column;
            }

            .search-input {
                margin-bottom: 10px;
            }

            /* AI Analysis Mobile Styles */
            .actions-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .action-details {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .risk-factors {
                padding: 12px;
            }

            /* Vendor Marketplace Mobile Styles */
            .vendor-card {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 15px;
            }

            .vendor-info {
                order: 1;
            }

            .vendor-rating {
                order: 2;
                justify-self: start;
            }

            .vendor-distance {
                order: 3;
                justify-self: start;
                margin-top: 5px;
            }

            .vendor-actions {
                order: 4;
                flex-direction: column;
                gap: 8px;
                margin-top: 10px;
            }

            .vendor-action-btn {
                width: 100%;
                justify-content: center;
                padding: 10px 12px;
            }

            .vendor-details {
                grid-template-columns: 1fr;
                gap: 8px;
            }

            .vendor-detail-item {
                font-size: 0.85rem;
            }

            .vendor-name {
                font-size: 1rem;
                margin-bottom: 8px;
            }

            .star-rating {
                font-size: 0.9rem;
            }

            .vendor-category-header {
                padding: 12px 15px;
                font-size: 0.95rem;
            }

            .vendor-list {
                padding: 15px;
            }

            /* Modal Mobile Styles */
            .modal-content {
                width: 95%;
                max-width: none;
                margin: 10px auto;
                padding: 20px;
                max-height: 90vh;
            }

            .modal-title {
                font-size: 1.1rem;
            }

            .violation-details {
                padding: 15px;
            }

            .detail-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }

            .detail-value {
                text-align: left;
            }

            /* Score Circle Mobile */
            .score-circle-large {
                width: 80px;
                height: 80px;
                font-size: 1.5rem;
            }

            .score-title {
                font-size: 1.1rem;
            }

            .score-subtitle {
                font-size: 0.85rem;
            }
        }

        /* Tablet Responsive Design */
        @media (max-width: 1024px) and (min-width: 769px) {
            .actions-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }

            .vendor-card {
                grid-template-columns: 2fr auto auto;
                gap: 12px;
            }

            .vendor-details {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }

            .vendor-actions {
                flex-direction: column;
                gap: 6px;
            }

            .vendor-action-btn {
                font-size: 0.75rem;
                padding: 6px 10px;
            }
        }

        /* Small Mobile Devices */
        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 20px;
                margin-bottom: 20px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .search-section, .property-summary, .ai-insights, .vendor-marketplace, .compliance-table {
                padding: 15px;
                margin-bottom: 15px;
            }

            .insights-header, .vendor-category-header {
                padding: 15px;
            }

            .insights-title {
                font-size: 1.1rem;
            }

            .vendor-intro {
                font-size: 0.9rem;
                margin-bottom: 15px;
            }

            .vendor-name {
                font-size: 0.95rem;
            }

            .vendor-detail-item {
                font-size: 0.8rem;
            }

            .vendor-action-btn {
                font-size: 0.8rem;
                padding: 8px 10px;
            }

            .action-card-enhanced {
                padding: 15px;
            }

            .action-title-enhanced {
                font-size: 0.95rem;
            }

            .action-reason {
                font-size: 0.85rem;
            }

            .risk-assessment-enhanced {
                padding: 15px;
            }

            .risk-title {
                font-size: 1rem;
            }

            .risk-summary {
                font-size: 0.9rem;
            }

            .property-title {
                font-size: 1.5rem;
            }

            .meta-item {
                padding: 8px 0;
            }

            .analyze-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            /* Improve touch targets on mobile */
            .compliance-row {
                min-height: 60px;
            }

            .expand-icon {
                padding: 10px;
            }

            .truncated-text {
                line-height: 1.4;
                word-break: break-word;
            }

            .vendor-distance {
                font-size: 0.75rem;
                padding: 3px 6px;
            }

            .marketplace-badge, .ai-confidence-badge {
                font-size: 0.75rem;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏢 Propply AI</h1>
            <p class="tagline">Intelligent Property Compliance Analysis</p>
        </div>

        <div class="search-section">
            <div class="search-form">
                <input type="text" id="addressInput" class="search-input" placeholder="Enter property address (e.g., 123 Main Street, City, State ZIP)">
                <button id="analyzeBtn" class="analyze-btn">
                    <i class="fas fa-search"></i> Analyze Property
                </button>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="loading" id="loadingDiv">
                <div class="spinner"></div>
                <p><strong>Generating comprehensive compliance report...</strong></p>
                <p>Analyzing HPD, DOB, Elevator, Boiler, and Electrical data</p>
            </div>

            <div id="resultsContent" style="display: none;">
                <div class="property-summary">
                    <div class="property-header">
                        <div class="property-info">
                            <h2>Property Analysis Results</h2>
                            
                            <!-- Prominent Compliance Score Display -->
                            <div class="compliance-score-prominent">
                                <div class="compliance-score-label">Compliance Score</div>
                                <div class="compliance-score-value" id="overallScoreProminent">93</div>
                                <div class="compliance-score-subtitle" id="reportDate">Report generated on: 8/14/2025</div>
                            </div>
                            
                            <div class="property-meta-compact">
                                <div class="property-main-info">
                                    <div class="address-section" onclick="togglePropertyDetails()">
                                        <div class="address-display">
                                            <span class="address-text" id="propertyAddress">Loading...</span>
                                            <i class="fas fa-chevron-down expand-icon" id="propertyExpandIcon"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="property-details-dropdown" id="propertyDetailsDropdown" style="display: none;">
                                    <div class="details-grid">
                                        <div class="detail-item">
                                            <span class="detail-label">BIN:</span>
                                            <span class="detail-value" id="propertyBin">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">BBL:</span>
                                            <span class="detail-value" id="propertyBbl">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Borough:</span>
                                            <span class="detail-value" id="propertyBorough">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">Block/Lot:</span>
                                            <span class="detail-value" id="propertyBlockLot">-</span>
                                        </div>
                                        <div class="detail-item">
                                            <span class="detail-label">ZIP Code:</span>
                                            <span class="detail-value" id="propertyZip">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="property-map">
                            <div id="propertyMap" style="width: 100%; height: 100%; background: #f0f0f0; display: flex; align-items: center; justify-content: center; color: #666;">
                                <i class="fas fa-map-marker-alt"></i> Map will load here
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Analysis Results -->
                <div class="ai-analysis-results" id="aiAnalysisResults" style="display: none;">
                    
                    <!-- Analysis Header with Key Metrics -->
                    <div class="analysis-header">
                        <div class="analysis-title">
                            <h2><i class="fas fa-brain"></i> AI Compliance Analysis</h2>
                            <div class="analysis-meta">
                                <span class="analysis-timestamp" id="analysisTimestamp">-</span>
                                <span class="ai-confidence" id="aiConfidenceLevel">-</span>
                            </div>
                        </div>
                        <div class="key-metrics">
                            <div class="metric-card risk-score">
                                <div class="metric-label">Risk Score</div>
                                <div class="metric-value" id="overallRiskScore">-</div>
                            </div>
                            <div class="metric-card risk-level">
                                <div class="metric-label">Risk Level</div>
                                <div class="metric-value" id="overallRiskLevel">-</div>
                            </div>
                            <div class="metric-card data-freshness">
                                <div class="metric-label">Data Freshness</div>
                                <div class="metric-value" id="dataFreshnessDate">-</div>
                            </div>
                        </div>
                    </div>

                    <!-- Executive Summary -->
                    <div class="analysis-section expandable-section">
                        <div class="section-header" onclick="toggleSection('executiveSummary')">
                            <h3><i class="fas fa-chart-line"></i> Executive Summary</h3>
                            <div class="expand-indicator">
                                <i class="fas fa-chevron-down expand-icon" id="executiveSummary-icon"></i>
                            </div>
                        </div>
                        <div class="section-content" id="executiveSummary-content">
                            <div class="summary-card">
                                <h4>Risk Assessment</h4>
                                <p id="riskSummaryText">-</p>
                            </div>
                            <div class="summary-card">
                                <h4>Recommendations Summary</h4>
                                <p id="recommendationsSummary">-</p>
                            </div>
                            <div class="risk-factors-section">
                                <h4>Primary Risk Factors</h4>
                                <ul id="primaryRiskFactors" class="risk-factors-list"></ul>
                            </div>
                        </div>
                    </div>

                    <!-- Compliance Insights Section -->
                    <div class="analysis-section expandable-section">
                        <div class="section-header" onclick="toggleSection('complianceInsights')">
                            <h3><i class="fas fa-lightbulb"></i> Compliance Insights</h3>
                            <div class="expand-indicator">
                                <span class="trajectory-badge" id="complianceTrajectory">-</span>
                                <i class="fas fa-chevron-down expand-icon" id="complianceInsights-icon"></i>
                            </div>
                        </div>
                        <div class="section-content" id="complianceInsights-content">
                            <div class="insights-grid">
                                <div class="insight-card strengths">
                                    <h4><i class="fas fa-check-circle"></i> Strengths</h4>
                                    <ul id="complianceStrengths" class="insight-list"></ul>
                                </div>
                                <div class="insight-card concerns">
                                    <h4><i class="fas fa-exclamation-circle"></i> Immediate Concerns</h4>
                                    <ul id="immediateConcerns" class="insight-list"></ul>
                                </div>
                            </div>
                            <div class="trends-analysis">
                                <h4>Trends Analysis</h4>
                                <p id="trendsAnalysis">-</p>
                            </div>
                        </div>
                    </div>

                    <!-- Priority Actions Section -->
                <div class="analysis-section expandable-section">
                    <div class="section-header" onclick="toggleSection('priorityActions')">
                        <h3><i class="fas fa-tasks"></i> Priority Actions</h3>
                        <div class="expand-indicator">
                            <span class="actions-count" id="actionsCount">0 actions</span>
                            <i class="fas fa-chevron-down expand-icon" id="priorityActions-icon"></i>
                        </div>
                    </div>
                    <div class="section-content" id="priorityActions-content">
                        <div class="actions-summary">
                            <div class="summary-cards">
                                <div class="summary-card critical">
                                    <div class="summary-number" id="criticalCount">0</div>
                                    <div class="summary-label">Critical</div>
                                </div>
                                <div class="summary-card high">
                                    <div class="summary-number" id="highCount">0</div>
                                    <div class="summary-label">High Priority</div>
                                </div>
                                <div class="summary-card medium">
                                    <div class="summary-number" id="mediumCount">0</div>
                                    <div class="summary-label">Medium Priority</div>
                                </div>
                            </div>
                        </div>
                        <div class="priority-actions-list" id="priorityActionsList">
                            <!-- Priority action items will be populated by JavaScript -->
                        </div>
                    </div>
                </div>

                    <!-- Financial Impact Section -->
                <div class="analysis-section expandable-section">
                    <div class="section-header" onclick="toggleSection('financialImpact')">
                        <h3><i class="fas fa-dollar-sign"></i> Financial Impact Analysis</h3>
                        <div class="expand-indicator">
                            <span class="financial-exposure" id="totalExposure">-</span>
                            <i class="fas fa-chevron-down expand-icon" id="financialImpact-icon"></i>
                        </div>
                    </div>
                    <div class="section-content" id="financialImpact-content">
                        <div class="financial-overview">
                            <div class="financial-metrics">
                                <div class="metric-card immediate-exposure">
                                    <div class="metric-label">Immediate Exposure</div>
                                    <div class="metric-value" id="immediateExposure">-</div>
                                </div>
                                <div class="metric-card annual-costs">
                                    <div class="metric-label">Annual Compliance Costs</div>
                                    <div class="metric-value" id="annualComplianceCosts">-</div>
                                </div>
                                <div class="metric-card priority-investment">
                                    <div class="metric-label">Priority Investment</div>
                                    <div class="metric-value" id="priorityInvestment">-</div>
                                </div>
                            </div>
                        </div>
                        <div class="financial-details">
                            <div class="detail-row">
                                <div class="detail-card">
                                    <h4>Potential Fines</h4>
                                    <p id="potentialFines">-</p>
                                </div>
                                <div class="detail-card">
                                    <h4>Maintenance Costs</h4>
                                    <p id="maintenanceCosts">-</p>
                                </div>
                            </div>
                            <div class="cost-benefit-analysis">
                                <h4>Cost-Benefit Analysis</h4>
                                <p id="costBenefitAnalysis">-</p>
                            </div>
                            <div class="cost-breakdown">
                                <h4>Cost Breakdown by Category</h4>
                                <div class="breakdown-grid" id="costBreakdownGrid">
                                    <!-- Cost breakdown items will be populated here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>     <!-- Equipment Monitoring -->
                    <div class="analysis-section expandable-section">
                    <div class="section-header" onclick="toggleSection('equipmentMonitoring')">
                        <h3><i class="fas fa-cogs"></i> Equipment Monitoring</h3>
                        <div class="expand-indicator">
                            <span class="equipment-summary" id="equipmentSummary">-</span>
                            <i class="fas fa-chevron-down expand-icon" id="equipmentMonitoring-icon"></i>
                        </div>
                    </div>
                    <div class="section-content" id="equipmentMonitoring-content">
                        <div class="equipment-tabs">
                            <div class="tab-buttons">
                                <button class="tab-button active" data-tab="elevators">
                                    <i class="fas fa-elevator"></i> Elevators
                                    <span class="device-count" id="elevatorCount">-</span>
                                </button>
                                <button class="tab-button" data-tab="boilers">
                                    <i class="fas fa-fire"></i> Boilers
                                    <span class="device-count" id="boilerCount">-</span>
                                </button>
                                <button class="tab-button" data-tab="electrical">
                                    <i class="fas fa-bolt"></i> Electrical
                                    <span class="device-count" id="electricalCount">-</span>
                                </button>
                            </div>
                            <div class="tab-content">
                                <div class="tab-panel active" id="elevators-panel">
                                    <!-- Elevator monitoring content -->
                                </div>
                                <div class="tab-panel" id="boilers-panel">
                                    <!-- Boiler monitoring content -->
                                </div>
                                <div class="tab-panel" id="electrical-panel">
                                    <!-- Electrical monitoring content -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                    <!-- Regulatory Intelligence Section -->
                <div class="analysis-section expandable-section">
                    <div class="section-header" onclick="toggleSection('regulatoryIntelligence')">
                        <h3><i class="fas fa-gavel"></i> Regulatory Intelligence</h3>
                        <div class="expand-indicator">
                            <i class="fas fa-chevron-down expand-icon" id="regulatoryIntelligence-icon"></i>
                        </div>
                    </div>
                    <div class="section-content" id="regulatoryIntelligence-content">
                        <div class="regulatory-grid">
                            <div class="regulatory-card">
                                <h4><i class="fas fa-calendar-alt"></i> Upcoming Inspections</h4>
                                <p id="upcomingInspections">-</p>
                            </div>
                            <div class="regulatory-card">
                                <h4><i class="fas fa-leaf"></i> Seasonal Considerations</h4>
                                <p id="seasonalConsiderations">-</p>
                            </div>
                            <div class="regulatory-card">
                                <h4><i class="fas fa-exclamation-triangle"></i> Regulatory Changes</h4>
                                <p id="regulatoryChanges">-</p>
                            </div>
                        </div>
                        <div class="best-practices">
                            <h4><i class="fas fa-star"></i> Best Practices</h4>
                            <ul id="bestPracticesList" class="practices-list"></ul>
                        </div>
                        <div class="monitoring-schedule">
                            <h4><i class="fas fa-clock"></i> Monitoring Schedule</h4>
                            <p id="monitoringSchedule">-</p>
                        </div>
                    </div>
                </div>

                </div>

                <!-- Enhanced AI Insights -->
                <div class="ai-insights" id="aiInsightsSection" style="display: block;">
                    <div class="insights-header">
                        <div class="insights-title">
                            <i class="fas fa-brain ai-icon"></i>
                            AI-Powered Compliance Analysis
                        </div>
                        <div class="ai-confidence-badge" id="aiConfidenceBadge">
                            <i class="fas fa-spinner fa-spin"></i> Processing...
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="aiLoadingState" class="ai-content">
                        <div class="risk-assessment-enhanced risk-moderate-border">
                            <div class="risk-header">
                                <div class="risk-title">
                                    <i class="fas fa-cog fa-spin"></i> Analyzing Property Data
                                </div>
                            </div>
                            <div class="risk-summary">
                                Our AI agent is conducting a comprehensive analysis of your property's compliance data across all NYC datasets. This process typically takes 20-30 seconds and includes evaluation of HPD violations, DOB records, elevator systems, boiler inspections, and electrical permits.
                            </div>
                            <div id="aiLoadingMessage" class="risk-summary" style="margin-top: 15px; font-style: italic; color: #666;">
                                AI analysis in progress... This may take a minute or two.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced AI Results (hidden initially) -->
                    <div id="aiResultsState" style="display: none;" class="ai-content">
                        <!-- Risk Assessment -->
                        <div class="risk-assessment-enhanced" id="riskAssessmentContainer">
                            <div class="risk-header">
                                <div class="risk-title">
                                    <i class="fas fa-exclamation-triangle"></i> Risk Assessment
                                </div>
                                <div class="risk-badge-enhanced" id="riskBadgeEnhanced">ANALYZING</div>
                            </div>
                            <div class="risk-summary" id="riskSummaryEnhanced">
                                Analyzing compliance data...
                            </div>
                            <div class="risk-factors">
                                <div class="risk-factors-title">Key Risk Factors</div>
                                <ul class="risk-factors-list" id="riskFactorsList">
                                    <li class="risk-factor-item">Loading analysis...</li>
                                </ul>
                            </div>
                        </div>
                        
                        <!-- Priority Actions -->
                        <div class="priority-actions-enhanced">
                            <div class="actions-title">
                                <i class="fas fa-tasks"></i> Priority Actions & Recommendations
                            </div>
                            <div class="actions-grid" id="actionsGrid">
                                <!-- Actions will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Financial Impact (if available) -->
                        <div id="financialImpactSection" style="display: none;">
                            <div class="actions-title">
                                <i class="fas fa-dollar-sign"></i> Financial Impact Analysis
                            </div>
                            <div class="actions-grid">
                                <div class="action-card-enhanced">
                                    <div class="action-title-enhanced">Potential Fines</div>
                                    <div class="action-reason" id="potentialFines">Calculating...</div>
                                </div>
                                <div class="action-card-enhanced">
                                    <div class="action-title-enhanced">Estimated Costs</div>
                                    <div class="action-reason" id="estimatedCosts">Calculating...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="ai-meta-enhanced">
                        <i class="fas fa-robot"></i> Analysis powered by advanced AI • 
                        Confidence: <span id="aiConfidenceText">--</span>% • 
                        Completed: <span id="analysisTimeText">--</span>
                    </div>
                </div>



                <!-- Detailed Compliance Analysis -->
                <div class="compliance-table">
                    <div class="table-header">
                        <h3><i class="fas fa-clipboard-check"></i> Detailed Compliance Analysis</h3>
                        <p>Click on any category to view detailed information</p>
                    </div>

                    <!-- EQUIPMENT SECTIONS FIRST (as requested by client) -->
                    <div class="compliance-row" onclick="toggleRow('elevator', event)">
                        <div class="row-summary">
                            <div class="category-name">
                                <i class="fas fa-elevator category-icon"></i>
                                Elevator Equipment
                            </div>
                            <div class="status-summary" id="elevatorStatus">0 total, 0 active</div>
                            <div class="status-summary">Elevator and conveyor device inspections</div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="row-details" onclick="event.stopPropagation()">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-section">
                                        <div class="detail-title">Device Summary</div>
                                        <ul class="detail-list">
                                            <li class="detail-item">
                                                <span class="detail-label">Total Devices:</span>
                                                <span class="detail-value" id="elevatorTotal">0</span>
                                            </li>
                                            <li class="detail-item">
                                                <span class="detail-label">Active Devices:</span>
                                                <span class="detail-value" id="elevatorActive">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="records-table" id="elevatorRecords">
                                    <div class="records-header">
                                        <div>Device Number</div>
                                        <div>Type</div>
                                        <div>Status</div>
                                        <div>Last Updated</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="compliance-row" onclick="toggleRow('boiler', event)">
                        <div class="row-summary">
                            <div class="category-name">
                                <i class="fas fa-fire category-icon"></i>
                                Boiler Inspections
                            </div>
                            <div class="status-summary" id="boilerStatus">0 inspections</div>
                            <div class="status-summary">Boiler safety and maintenance inspection records</div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="row-details" onclick="event.stopPropagation()">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-section">
                                        <div class="detail-title">Inspection Summary</div>
                                        <ul class="detail-list">
                                            <li class="detail-item">
                                                <span class="detail-label">Total Devices:</span>
                                                <span class="detail-value" id="boilerTotal">0</span>
                                            </li>
                                            <li class="detail-item">
                                                <span class="detail-label">Recent Inspections:</span>
                                                <span class="detail-value" id="boilerRecent">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="records-table" id="boilerRecords">
                                    <div class="records-header">
                                        <div>Boiler ID</div>
                                        <div>Inspection Date</div>
                                        <div>Status</div>
                                        <div>Defects</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="compliance-row" onclick="toggleRow('electrical', event)">
                        <div class="row-summary">
                            <div class="category-name">
                                <i class="fas fa-bolt category-icon"></i>
                                Electrical Permits
                            </div>
                            <div class="status-summary" id="electricalStatus">0 permits, 0 active</div>
                            <div class="status-summary">Electrical work permits and inspections</div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="row-details" onclick="event.stopPropagation()">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-section">
                                        <div class="detail-title">Permit Summary</div>
                                        <ul class="detail-list">
                                            <li class="detail-item">
                                                <span class="detail-label">Total Permits:</span>
                                                <span class="detail-value" id="electricalTotal">0</span>
                                            </li>
                                            <li class="detail-item">
                                                <span class="detail-label">Active Permits:</span>
                                                <span class="detail-value" id="electricalActive">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="records-table" id="electricalRecords">
                                    <div class="records-header">
                                        <div>Permit Number</div>
                                        <div>Type</div>
                                        <div>Status</div>
                                        <div>Date</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- VIOLATIONS SECTIONS SECOND (as requested by client) -->
                    <div class="compliance-row" onclick="toggleRow('hpd', event)">
                        <div class="row-summary">
                            <div class="category-name">
                                <i class="fas fa-home category-icon"></i>
                                HPD Violations
                            </div>
                            <div class="status-summary" id="hpdStatus">0 total, 0 active</div>
                            <div class="status-summary">Housing Preservation & Development violations</div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="row-details" onclick="event.stopPropagation()">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-section">
                                        <div class="detail-title">Violation Summary</div>
                                        <ul class="detail-list">
                                            <li class="detail-item">
                                                <span class="detail-label">Total Violations:</span>
                                                <span class="detail-value" id="hpdTotal">0</span>
                                            </li>
                                            <li class="detail-item">
                                                <span class="detail-label">Active Violations:</span>
                                                <span class="detail-value" id="hpdActive">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="records-table" id="hpdRecords">
                                    <div class="records-header">
                                        <div>Violation ID</div>
                                        <div>Status</div>
                                        <div>Date</div>
                                        <div>Description</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="compliance-row" onclick="toggleRow('dob', event)">
                        <div class="row-summary">
                            <div class="category-name">
                                <i class="fas fa-building category-icon"></i>
                                DOB Violations
                            </div>
                            <div class="status-summary" id="dobStatus">0 total, 0 active</div>
                            <div class="status-summary">Building code and construction violations</div>
                            <div class="expand-icon">
                                <i class="fas fa-chevron-right"></i>
                            </div>
                        </div>
                        <div class="row-details" onclick="event.stopPropagation()">
                            <div class="details-content">
                                <div class="details-grid">
                                    <div class="detail-section">
                                        <div class="detail-title">Violation Summary</div>
                                        <ul class="detail-list">
                                            <li class="detail-item">
                                                <span class="detail-label">Total Violations:</span>
                                                <span class="detail-value" id="dobTotal">0</span>
                                            </li>
                                            <li class="detail-item">
                                                <span class="detail-label">Active Violations:</span>
                                                <span class="detail-value" id="dobActive">0</span>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="records-table" id="dobRecords">
                                    <div class="records-header">
                                        <div>Violation ID</div>
                                        <div>Category</div>
                                        <div>Date</div>
                                        <div>Description</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>






                </div>
                
                <!-- Compact Service Providers Section (After Compliance Analysis) -->
                <div class="service-providers-compact" id="serviceProvidersSection" style="display: none;">
                    <div class="providers-header">
                        <h3><i class="fas fa-users"></i> Recommended Service Providers</h3>
                        <div class="providers-badge">
                            <i class="fas fa-check-circle"></i> Verified & Licensed
                        </div>
                    </div>
                    
                    <div class="service-categories" id="serviceCategories">
                        <!-- Service categories with dropdowns will be populated by JavaScript -->
                    </div>
                    
                    <div class="providers-footer">
                        <span><i class="fas fa-shield-alt"></i> Licensed contractors</span> • 
                        <span><i class="fas fa-map-marker-alt"></i> Local area</span> • 
                        <span><i class="fas fa-star"></i> Rated providers</span>
                    </div>
                </div>
            </div>
            
            <div class="error-message" id="errorMessage" style="display: none;"></div>
        </div>

        <!-- Modal for expanded descriptions -->
        <div id="descriptionModal" class="description-modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title" id="modalTitle">Violation Details</div>
                    <button class="close-btn" onclick="closeModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="violation-details" id="violationDetails">
                        <!-- Violation metadata will be populated here -->
                    </div>
                    <div class="description-text" id="fullDescription">
                        <!-- Full description will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let propertyMap = null;

        // Google Maps initialization function
        function initializePropertyMap(address) {
            if (typeof google === 'undefined' || !google.maps) {
                console.warn('Google Maps API not loaded');
                document.getElementById('propertyMap').innerHTML = '<i class="fas fa-map-marker-alt"></i> Map unavailable';
                return;
            }

            const geocoder = new google.maps.Geocoder();
            const mapElement = document.getElementById('propertyMap');
            
            geocoder.geocode({ address: address }, (results, status) => {
                if (status === 'OK' && results[0]) {
                    const location = results[0].geometry.location;
                    
                    propertyMap = new google.maps.Map(mapElement, {
                        zoom: 17,
                        center: location,
                        mapTypeId: google.maps.MapTypeId.HYBRID,
                        disableDefaultUI: true,
                        zoomControl: true,
                        streetViewControl: true
                    });
                    
                    new google.maps.Marker({
                        position: location,
                        map: propertyMap,
                        title: address,
                        icon: {
                            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7z" fill="#667eea"/>
                                    <circle cx="12" cy="9" r="2.5" fill="white"/>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(24, 24),
                            anchor: new google.maps.Point(12, 24)
                        }
                    });
                    
                    // Add click handler to open full map in popup
                    mapElement.style.cursor = 'pointer';
                    mapElement.addEventListener('click', () => {
                        openMapPopup(address, location);
                    });
                } else {
                    console.error('Geocoding failed:', status);
                    mapElement.innerHTML = '<i class="fas fa-map-marker-alt"></i> Location not found';
                }
            });
        }

        // Function to open full map in popup window
        function openMapPopup(address, location) {
            const lat = location.lat();
            const lng = location.lng();
            const mapUrl = `https://www.google.com/maps?q=${lat},${lng}&z=17&t=h`;
            
            const popup = window.open(
                mapUrl,
                'PropertyMap',
                'width=800,height=600,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no'
            );
            
            if (popup) {
                popup.focus();
            } else {
                // Fallback if popup blocked
                window.open(mapUrl, '_blank');
            }
        }
        
        // Function to toggle property details dropdown
        function togglePropertyDetails() {
            const dropdown = document.getElementById('propertyDetailsDropdown');
            const icon = document.getElementById('propertyExpandIcon');
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                icon.classList.add('rotated');
            } else {
                dropdown.style.display = 'none';
                icon.classList.remove('rotated');
            }
        }
        
        // Function to toggle service category dropdown
        function toggleServiceCategory(categoryId) {
            const dropdown = document.getElementById(`providers-${categoryId}`);
            const icon = document.querySelector(`[data-category="${categoryId}"] .expand-icon`);
            
            if (dropdown.style.display === 'none' || dropdown.style.display === '') {
                dropdown.style.display = 'block';
                if (icon) icon.classList.add('rotated');
            } else {
                dropdown.style.display = 'none';
                if (icon) icon.classList.remove('rotated');
            }
        }

        // Updated event listener for the new form structure
        document.getElementById('analyzeBtn').addEventListener('click', async function(e) {
            e.preventDefault();
            
            const address = document.getElementById('addressInput').value.trim();
            if (!address) return;
            
            // Show results section and loading
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('resultsContent').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            
            // Disable form
            document.getElementById('analyzeBtn').disabled = true;
            document.getElementById('analyzeBtn').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analyzing...';
            
            try {
                const response = await fetch('/api/analyze-property', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ address: address })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('Full response data received:', data);
                    console.log('AI analysis in response:', data.ai_analysis);
                    currentData = data;
                    displayResults(data);
                } else {
                    showError(data.error || 'Analysis failed');
                }
                
            } catch (error) {
                showError('Network error: ' + error.message);
            } finally {
                // Re-enable form
                document.getElementById('analyzeBtn').disabled = false;
                document.getElementById('analyzeBtn').innerHTML = '<i class="fas fa-search"></i> Analyze Property';
                document.getElementById('loadingDiv').style.display = 'none';
            }
        });
        
        function displayResults(data) {
            document.getElementById('resultsContent').style.display = 'block';
            
            // Property summary with error handling
            const setTextContent = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
                else console.warn(`Element with ID '${id}' not found`);
            };
            
            setTextContent('propertyAddress', data.property.address);
            setTextContent('propertyBin', data.property.bin);
            setTextContent('propertyBbl', data.property.bbl);
            setTextContent('propertyBorough', data.property.borough);
            setTextContent('propertyBlockLot', `${data.property.block}/${data.property.lot}`);
            setTextContent('propertyZip', data.property.zip_code);
            setTextContent('reportDate', `Report generated on: ${new Date().toLocaleDateString()}`);
            
            // Initialize Google Map
            initializePropertyMap(data.property.address);
            
            // Overall score - prominent display
            const overallScore = data.compliance_scores.overall;
            setTextContent('overallScoreProminent', overallScore);
            
            // Update prominent score background based on score
            const prominentScoreContainer = document.querySelector('.compliance-score-prominent');
            if (prominentScoreContainer) {
                if (overallScore >= 80) {
                    prominentScoreContainer.style.background = 'linear-gradient(135deg, #28a745 0%, #20c997 100%)';
                    prominentScoreContainer.style.boxShadow = '0 8px 25px rgba(40, 167, 69, 0.3)';
                } else if (overallScore >= 60) {
                    prominentScoreContainer.style.background = 'linear-gradient(135deg, #ffc107 0%, #fd7e14 100%)';
                    prominentScoreContainer.style.boxShadow = '0 8px 25px rgba(255, 193, 7, 0.3)';
                } else {
                    prominentScoreContainer.style.background = 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)';
                    prominentScoreContainer.style.boxShadow = '0 8px 25px rgba(220, 53, 69, 0.3)';
                }
            }
            
            // HPD
            updateComplianceRow('hpd', `${data.violations.hpd_total} total, ${data.violations.hpd_active} active`);
            setTextContent('hpdTotal', data.violations.hpd_total);
            setTextContent('hpdActive', data.violations.hpd_active);
            
            // DOB
            updateComplianceRow('dob', `${data.violations.dob_total} total, ${data.violations.dob_active} active`);
            setTextContent('dobTotal', data.violations.dob_total);
            setTextContent('dobActive', data.violations.dob_active);
            
            // Elevator
            updateComplianceRow('elevator', `${data.equipment.elevator_total} total, ${data.equipment.elevator_active} active`);
            setTextContent('elevatorTotal', data.equipment.elevator_total);
            setTextContent('elevatorActive', data.equipment.elevator_active);
            
            // Boiler - Fix labeling to show inspections not devices
            setTextContent('boilerStatus', `${data.equipment.boiler_total} inspections`);
            setTextContent('boilerTotal', data.equipment.boiler_total);
            
            // Electrical
            updateComplianceRow('electrical', `${data.equipment.electrical_permits_total} permits, ${data.equipment.electrical_permits_active} active`);
            setTextContent('electricalTotal', data.equipment.electrical_permits_total);
            setTextContent('electricalActive', data.equipment.electrical_permits_active);
            
            // Display AI Analysis if available
            console.log('Checking AI analysis data:', data.ai_analysis);
            if (data.ai_analysis && data.ai_analysis.property_analysis) {
                console.log('Displaying AI analysis...');
                displayAIAnalysisCompact(data.ai_analysis);
                displayEnhancedAIAnalysis(data.ai_analysis);
            } else {
                console.log('No AI analysis data found or incomplete structure');
                
                // Check if we have an analysis_id for polling
                const analysisId = data.analysis_metadata?.analysis_id;
                const aiStatus = data.analysis_metadata?.ai_analysis_status;
                
                if (analysisId && aiStatus === 'pending') {
                    console.log(`Starting polling for AI analysis with ID: ${analysisId}`);
                    // Show loading state
                    document.getElementById('aiLoadingState').style.display = 'block';
                    document.getElementById('aiResultsState').style.display = 'none';
                    
                    // Start polling for results
                    startPollingForAIAnalysis(analysisId);
                } else {
                    // Show error state instead of hiding section
                    document.getElementById('aiLoadingState').style.display = 'none';
                    document.getElementById('aiResultsState').style.display = 'block';
                    
                    // Show error message using correct element IDs
                    const riskBadge = document.getElementById('riskBadgeEnhanced');
                    const riskSummary = document.getElementById('riskSummaryEnhanced');
                    const actionsGrid = document.getElementById('actionsGrid');
                    
                    if (riskBadge) {
                        riskBadge.textContent = 'ERROR';
                        riskBadge.className = 'risk-badge-enhanced risk-critical';
                    }
                    
                    if (riskSummary) {
                        riskSummary.textContent = 'AI analysis temporarily unavailable. Please try again later.';
                    }
                    
                    if (actionsGrid) {
                        actionsGrid.innerHTML = `
                            <div class="action-card-enhanced action-critical">
                                <div class="action-title-enhanced">AI Analysis Unavailable</div>
                                <div class="action-reason">Our AI agent is currently processing other requests. The compliance data above is still accurate.</div>
                            </div>
                        `;
                    }
                }
            }
            
            // Display vendor recommendations if available
            console.log('Checking vendor recommendations data:', data.vendor_recommendations);
            if (data.vendor_recommendations) {
                console.log('Displaying vendor recommendations...');
                displayVendorRecommendations(data.vendor_recommendations);
            } else {
                console.log('No vendor recommendations data found');
            }
        }
        
        function updateComplianceRow(category, status) {
            const statusElement = document.getElementById(category + 'Status');
            if (statusElement) {
                statusElement.textContent = status;
            } else {
                console.warn(`Status element for category '${category}' not found`);
            }
        }
        
        function displayAIAnalysisCompact(aiData) {
            try {
                console.log('AI Data received:', aiData);
                
                const analysis = aiData.property_analysis;
                const riskAssessment = analysis.overall_risk_assessment;
                
                // Hide loading state and show results
                document.getElementById('aiLoadingState').style.display = 'none';
                document.getElementById('aiResultsState').style.display = 'block';
                
                // Update confidence badge in header
                const confidence = aiData.ai_confidence || '--';
                const confidenceText = typeof confidence === 'string' && confidence.toUpperCase() === 'HIGH' ? '95' : confidence;
                document.getElementById('aiConfidenceBadge').innerHTML = `<i class="fas fa-check-circle"></i> ${confidenceText}% Confidence`;
                
                // Risk Assessment
                const riskLevel = riskAssessment.risk_level.toLowerCase();
                const riskContainer = document.getElementById('riskAssessmentContainer');
                if (riskContainer) riskContainer.className = `risk-assessment-enhanced risk-${riskLevel}-border`;
                
                const riskBadge = document.getElementById('riskBadgeEnhanced');
                if (riskBadge) {
                    riskBadge.textContent = riskAssessment.risk_level;
                    riskBadge.className = `risk-badge-enhanced risk-${riskLevel}`;
                }
                
                const riskSummaryElement = document.getElementById('riskSummaryEnhanced');
                if (riskSummaryElement) riskSummaryElement.textContent = riskAssessment.risk_summary;
                
                // Risk Factors
                const riskFactorsList = document.getElementById('riskFactorsList');
                riskFactorsList.innerHTML = '';
                if (riskAssessment.primary_risk_factors && Array.isArray(riskAssessment.primary_risk_factors)) {
                    riskAssessment.primary_risk_factors.forEach(factor => {
                        const li = document.createElement('li');
                        li.className = 'risk-factor-item';
                        li.textContent = factor;
                        riskFactorsList.appendChild(li);
                    });
                }
                
                // Priority Actions - Enhanced Grid
                const actionsGrid = document.getElementById('actionsGrid');
                actionsGrid.innerHTML = '';
                
                if (analysis.priority_actions && Array.isArray(analysis.priority_actions)) {
                    analysis.priority_actions.forEach(action => {
                        const actionCard = document.createElement('div');
                        const priorityLevel = action.priority.toLowerCase();
                        actionCard.className = `action-card-enhanced action-${priorityLevel}`;
                        
                        const timeline = action.timeline || 'Not specified';
                        const cost = action.estimated_cost || 'Not specified';
                        
                        actionCard.innerHTML = `
                            <div class="action-header-enhanced">
                                <div class="action-priority-enhanced priority-${priorityLevel}">
                                    ${action.priority}
                                </div>
                                <div class="action-category">${action.category}</div>
                            </div>
                            <div class="action-title-enhanced">${action.action}</div>
                            <div class="action-reason">${action.reason}</div>
                            <div class="action-details">
                                <div class="action-detail">
                                    <div class="action-detail-label">Timeline</div>
                                    <div class="action-detail-value">${timeline}</div>
                                </div>
                                <div class="action-detail">
                                    <div class="action-detail-label">Est. Cost</div>
                                    <div class="action-detail-value">${cost}</div>
                                </div>
                            </div>
                        `;
                        
                        actionsGrid.appendChild(actionCard);
                    });
                } else {
                    // Show fallback if no priority actions
                    actionsGrid.innerHTML = `
                        <div class="action-card-enhanced">
                            <div class="action-title-enhanced">No Critical Actions Required</div>
                            <div class="action-reason">Property appears to be in good compliance standing based on current analysis.</div>
                        </div>
                    `;
                }
                
                // Financial Impact (if available)
                if (analysis.financial_impact) {
                    const financialSection = document.getElementById('financialImpactSection');
                    if (financialSection) financialSection.style.display = 'block';
                    
                    const potentialFinesElement = document.getElementById('potentialFines');
                    if (potentialFinesElement) potentialFinesElement.textContent = analysis.financial_impact.potential_fines || 'Not specified';
                    
                    const estimatedCostsElement = document.getElementById('estimatedCosts');
                    if (estimatedCostsElement) estimatedCostsElement.textContent = analysis.financial_impact.maintenance_costs || 'Not specified';
                }
                
                // Footer metadata
                const aiConfidenceTextElement = document.getElementById('aiConfidenceText');
                if (aiConfidenceTextElement) aiConfidenceTextElement.textContent = confidenceText;
                
                const analysisTime = aiData.analysis_timestamp ? 
                    new Date(aiData.analysis_timestamp).toLocaleTimeString() : 
                    new Date().toLocaleTimeString();
                const analysisTimeElement = document.getElementById('analysisTimeText');
                if (analysisTimeElement) analysisTimeElement.textContent = analysisTime;
                
            } catch (error) {
                console.error('Error displaying AI analysis:', error);
                console.error('AI Data structure:', aiData);
                
                // Show error state
                document.getElementById('aiLoadingState').style.display = 'none';
                document.getElementById('aiResultsState').style.display = 'block';
                
                // Update header to show error
                document.getElementById('aiConfidenceBadge').innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                document.getElementById('aiConfidenceBadge').style.background = 'rgba(220, 38, 38, 0.2)';
                
                // Show error in risk assessment
                const riskContainer = document.getElementById('riskAssessmentContainer');
                riskContainer.className = 'risk-assessment-enhanced risk-critical-border';
                document.getElementById('riskBadgeEnhanced').textContent = 'ERROR';
                document.getElementById('riskBadgeEnhanced').className = 'risk-badge-enhanced risk-critical';
                document.getElementById('riskSummaryEnhanced').textContent = 'Unable to process AI analysis at this time. Please try again later.';
                
                document.getElementById('actionsGrid').innerHTML = `
                    <div class="action-card-enhanced action-critical">
                        <div class="action-title-enhanced">AI Analysis Temporarily Unavailable</div>
                        <div class="action-reason">Our AI service is currently processing other requests. The compliance data shown above remains accurate and actionable.</div>
                    </div>
                `;
            }
        }
        
        function displayVendorRecommendations(vendorData) {
            try {
                console.log('Displaying vendor recommendations:', vendorData);
                
                if (!vendorData || Object.keys(vendorData).length === 0) {
                    console.log('No vendor recommendations to display');
                    return;
                }
                
                // Show the compact service providers section
                document.getElementById('serviceProvidersSection').style.display = 'block';
                
                const serviceCategories = document.getElementById('serviceCategories');
                serviceCategories.innerHTML = '';
                
                // Category display names and icons
                const categoryInfo = {
                    'hpd': { name: 'Housing & Maintenance', icon: 'fas fa-home' },
                    'dob': { name: 'Building & Construction', icon: 'fas fa-building' },
                    'elevator': { name: 'Elevator Services', icon: 'fas fa-elevator' },
                    'boiler': { name: 'HVAC & Boiler', icon: 'fas fa-fire' },
                    'electrical': { name: 'Electrical Services', icon: 'fas fa-bolt' },
                    'fire_safety': { name: 'Fire Safety & Alarms', icon: 'fas fa-shield-alt' }
                };
                
                // Create compact service categories with dropdowns
                for (const [category, vendors] of Object.entries(vendorData)) {
                    if (!vendors || vendors.length === 0) continue;
                    
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'service-category';
                    
                    const categoryName = categoryInfo[category]?.name || category.toUpperCase();
                    const categoryIcon = categoryInfo[category]?.icon || 'fas fa-tools';
                    
                    categoryDiv.innerHTML = `
                        <div class="service-category-header" onclick="toggleServiceCategory('${category}')" data-category="${category}">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <i class="${categoryIcon}"></i>
                                <span class="service-category-title">${categoryName}</span>
                                <span class="service-category-count">${vendors.length}</span>
                            </div>
                            <i class="fas fa-chevron-down expand-icon"></i>
                        </div>
                        <div class="service-providers-list" id="providers-${category}">
                            ${vendors.map(vendor => createCompactVendorItem(vendor)).join('')}
                        </div>
                    `;
                    
                    serviceCategories.appendChild(categoryDiv);
                }
                
                // Update timestamp
                const vendorUpdateElement = document.getElementById('vendorUpdateTime');
                if (vendorUpdateElement) vendorUpdateElement.textContent = new Date().toLocaleTimeString();
                
                console.log('✅ Vendor recommendations displayed successfully');
                
            } catch (error) {
                console.error('Error displaying vendor recommendations:', error);
            }
        }
        
        function createCompactVendorItem(vendor) {
            const rating = vendor.rating || 0;
            const ratingCount = vendor.rating_count || 0;
            const distance = vendor.distance_miles || 'N/A';
            const phone = vendor.phone || '';
            const website = vendor.website || '';
            
            const contactInfo = [];
            if (phone) contactInfo.push(`<a href="tel:${phone}" class="provider-contact">${phone}</a>`);
            if (website) contactInfo.push(`<a href="${website}" target="_blank" class="provider-contact">Website</a>`);
            
            return `
                <div class="service-provider">
                    <div class="provider-info">
                        <div class="provider-name">${vendor.name}</div>
                        <div class="provider-details">
                            ${rating > 0 ? `★ ${rating.toFixed(1)} (${ratingCount} reviews)` : 'No reviews'} • 
                            ${distance !== 'N/A' ? `${distance} miles` : 'Local area'}
                        </div>
                    </div>
                    <div class="provider-contacts">
                        ${contactInfo.join(' • ')}
                    </div>
                </div>
            `;
        }
        
        function createVendorCard(vendor) {
            const rating = vendor.rating || 0;
            const ratingCount = vendor.rating_count || 0;
            const distance = vendor.distance_miles || 'N/A';
            const phone = vendor.phone || '';
            const website = vendor.website || '';
            
            // Create star rating display
            const starRating = createStarRating(rating);
            
            // Create contact buttons
            const contactButtons = [];
            if (phone) {
                contactButtons.push(`<a href="tel:${phone}" class="vendor-action-btn"><i class="fas fa-phone"></i> Call</a>`);
            }
            if (website) {
                contactButtons.push(`<a href="${website}" target="_blank" class="vendor-action-btn primary"><i class="fas fa-external-link-alt"></i> Website</a>`);
            }
            
            return `
                <div class="vendor-card">
                    <div class="vendor-info">
                        <div class="vendor-name">${vendor.name || 'Unknown'}</div>
                        <div class="vendor-details">
                            <div class="vendor-detail-item">
                                <i class="fas fa-map-marker-alt"></i>
                                ${vendor.address || 'Address not available'}
                            </div>
                            ${vendor.business_status ? `
                                <div class="vendor-detail-item">
                                    <i class="fas fa-store"></i>
                                    ${vendor.business_status}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <div class="vendor-rating">
                        <div class="star-rating">
                            ${starRating}
                            <span>${rating}/5</span>
                        </div>
                        <div style="font-size: 0.8rem; color: #6b7280;">
                            ${ratingCount} reviews
                        </div>
                    </div>
                    
                    <div class="vendor-distance">${distance} mi</div>
                    
                    <div class="vendor-actions">
                        ${contactButtons.join('')}
                    </div>
                </div>
            `;
        }
        
        function createStarRating(rating) {
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            let stars = '';
            
            // Full stars
            for (let i = 0; i < fullStars; i++) {
                stars += '<i class="fas fa-star"></i>';
            }
            
            // Half star
            if (hasHalfStar) {
                stars += '<i class="fas fa-star-half-alt"></i>';
            }
            
            // Empty stars
            for (let i = 0; i < emptyStars; i++) {
                stars += '<i class="far fa-star"></i>';
            }
            
            return stars;
        }
        
        function toggleRow(category, event) {
            // Prevent event bubbling from child elements
            if (event) {
                event.stopPropagation();
            }
            
            const row = event.currentTarget;
            const isExpanded = row.classList.contains('expanded');
            
            // Close all rows
            document.querySelectorAll('.compliance-row').forEach(r => r.classList.remove('expanded'));
            
            // If this row wasn't expanded, expand it and load details
            if (!isExpanded) {
                row.classList.add('expanded');
                loadRowDetails(category);
            }
        }
        
        function loadRowDetails(category) {
            if (!currentData || !currentData.inspections) return;
            
            // Helper function for safe textContent setting
            const setTextContent = (id, value) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
                else console.warn(`Element with ID '${id}' not found`);
            };
            
            const recordsContainer = document.getElementById(category + 'Records');
            const existingHeader = recordsContainer.querySelector('.records-header');
            
            // Clear existing records except header
            while (recordsContainer.children.length > 1) {
                recordsContainer.removeChild(recordsContainer.lastChild);
            }
            
            let data = currentData.inspections[category + '_data'] || 
                      currentData.inspections[category + '_violations'] || 
                      currentData.inspections[category.replace('_', '_inspections')] ||
                      [];
            
            // Filter to show only active violations/records
            if (category === 'hpd') {
                // Show only open violations (not RESOLVE, CERTIFIED, CLOSE)
                data = data.filter(record => {
                    const status = (record.violationstatus || '').toUpperCase();
                    const currentStatus = (record.currentstatus || '').toUpperCase();
                    return !['RESOLVE', 'RESOLVED', 'CERTIFIED', 'CLOSE', 'CLOSED', 'DISMISSED'].includes(status) && 
                           !['RESOLVE', 'RESOLVED', 'CERTIFIED', 'CLOSE', 'CLOSED', 'DISMISSED'].includes(currentStatus);
                });
            } else if (category === 'dob') {
                // Show only open violations (not RESOLVE, DISMISS, etc.)
                data = data.filter(record => {
                    const disposition = (record.disposition_comments || '').toUpperCase();
                    const status = (record.violation_status || '').toUpperCase();
                    return !['RESOLVE', 'RESOLVED', 'DISMISS', 'DISMISSED', 'CERTIFIED', 'CLOSE', 'CLOSED'].includes(disposition) &&
                           !['RESOLVE', 'RESOLVED', 'DISMISS', 'DISMISSED', 'CERTIFIED', 'CLOSE', 'CLOSED'].includes(status);
                });
            } else if (category === 'elevator') {
                // Show only active devices
                data = data.filter(record => {
                    const status = (record.device_status || '').toUpperCase();
                    return !['INACTIVE', 'REMOVED', 'TERMINATED', 'CANCELLED'].includes(status);
                });
            } else if (category === 'electrical') {
                // Show only active permits
                data = data.filter(record => {
                    const status = (record.filing_status || '').toUpperCase();
                    return !['EXPIRED', 'CANCELLED', 'CLOSED', 'DISAPPROVED', 'REVOKED'].includes(status);
                });
            }
            // For boiler, show all records as they are inspection records, not violations
            
            if (data.length === 0) {
                const noDataRow = document.createElement('div');
                noDataRow.className = 'record-row';
                noDataRow.innerHTML = '<div colspan="4" style="text-align: center; color: #666; grid-column: 1/-1;">No active records found</div>';
                recordsContainer.appendChild(noDataRow);
                return;
            }
            
            // Add up to 10 records
            data.slice(0, 10).forEach(record => {
                const row = document.createElement('div');
                row.className = 'record-row';
                
                if (category === 'hpd') {
                    const description = record.novdescription || 'N/A';
                    const descriptionHtml = description.length > 50 ? 
                        `<span class="truncated-text" onclick="showDescriptionModal('HPD Violation', ${JSON.stringify(record).replace(/"/g, '&quot;')}, '${description.replace(/'/g, "\\'")}', event)">
                            ${truncate(description, 50)}
                        </span>` : description;
                    
                    row.innerHTML = `
                        <div>${record.violationid || 'N/A'}</div>
                        <div>${record.violationstatus || 'N/A'}</div>
                        <div>${formatDate(record.approveddate)}</div>
                        <div>${descriptionHtml}</div>
                    `;
                } else if (category === 'dob') {
                    const description = record.description || 'N/A';
                    const descriptionHtml = description.length > 50 ? 
                        `<span class="truncated-text" onclick="showDescriptionModal('DOB Violation', ${JSON.stringify(record).replace(/"/g, '&quot;')}, '${description.replace(/'/g, "\\'")}', event)">
                            ${truncate(description, 50)}
                        </span>` : description;
                    
                    row.innerHTML = `
                        <div>${record.isn_dob_bis_viol || 'N/A'}</div>
                        <div>${record.violation_category || 'N/A'}</div>
                        <div>${formatDate(record.issue_date)}</div>
                        <div>${descriptionHtml}</div>
                    `;
                } else if (category === 'elevator') {
                    row.innerHTML = `
                        <div>${record.device_number || 'N/A'}</div>
                        <div>${record.device_type || 'N/A'}</div>
                        <div>${record.device_status || 'N/A'}</div>
                        <div>${formatDate(record.status_date)}</div>
                    `;
                } else if (category === 'boiler') {
                    row.innerHTML = `
                        <div>${record.boiler_id || 'N/A'}</div>
                        <div>${formatDate(record.inspection_date)}</div>
                        <div>${record.report_status || 'N/A'}</div>
                        <div>${record.defects_exist || 'N/A'}</div>
                    `;
                    
                    // Update defects count
                    const defects = data.filter(r => r.defects_exist === 'Yes').length;
                    setTextContent('boilerDefects', defects);
                    setTextContent('boilerRecent', data.length);
                } else if (category === 'electrical') {
                    const description = record.job_description || 'N/A';
                    const descriptionHtml = description.length > 50 ? 
                        `<span class="truncated-text" onclick="showDescriptionModal('Electrical Permit', ${JSON.stringify(record).replace(/"/g, '&quot;')}, '${description.replace(/'/g, "\\'")}', event)">
                            ${truncate(description, 50)}
                        </span>` : description;
                    
                    row.innerHTML = `
                        <div>${record.filing_number || 'N/A'}</div>
                        <div>${record.filing_status || 'N/A'}</div>
                        <div>${formatDate(record.filing_date)}</div>
                        <div>${descriptionHtml}</div>
                    `;
                }
                
                recordsContainer.appendChild(row);
            });
            
            if (data.length > 10) {
                const moreRow = document.createElement('div');
                moreRow.className = 'record-row';
                moreRow.innerHTML = `<div style="text-align: center; color: #666; font-style: italic; grid-column: 1/-1;">... and ${data.length - 10} more records</div>`;
                recordsContainer.appendChild(moreRow);
            }
        }
        
        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            
            // Convert string to string if it's a number
            const dateString = String(dateStr);
            
            try {
                // Handle YYYYMMDD format (e.g., "20240802")
                if (/^\d{8}$/.test(dateString)) {
                    const year = dateString.substring(0, 4);
                    const month = dateString.substring(4, 6);
                    const day = dateString.substring(6, 8);
                    const date = new Date(year, month - 1, day); // month is 0-indexed
                    
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleDateString();
                    }
                }
                
                // Handle standard date formats
                const date = new Date(dateString);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleDateString();
                }
                
                // If all else fails, return the original string
                return dateString;
            } catch {
                return dateString;
            }
        }
        
        function truncate(str, length) {
            if (!str) return 'N/A';
            return str.length > length ? str.substring(0, length) + '...' : str;
        }
        
        function getScoreClass(score) {
            if (score >= 95) return 'score-excellent';
            if (score >= 85) return 'score-good';
            if (score >= 70) return 'score-warning';
            return 'score-critical';
        }
        
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            if (errorElement) {
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
        }
        
        function showDescriptionModal(title, record, description, event) {
            // Prevent event bubbling to parent elements
            if (event) {
                event.stopPropagation();
            }
            
            const modal = document.getElementById('descriptionModal');
            const modalTitle = document.getElementById('modalTitle');
            const violationDetails = document.getElementById('violationDetails');
            const fullDescription = document.getElementById('fullDescription');
            
            // Set modal title
            if (modalTitle) modalTitle.textContent = title;
            
            // Set full description
            if (fullDescription) fullDescription.innerHTML = `<p><strong>Full Description:</strong></p><p>${description}</p>`;
            
            // Set violation details based on type
            let detailsHtml = '';
            if (title === 'HPD Violation') {
                detailsHtml = `
                    <div class="detail-item"><strong>Violation ID:</strong> ${record.violationid || 'N/A'}</div>
                    <div class="detail-item"><strong>Status:</strong> ${record.violationstatus || 'N/A'}</div>
                    <div class="detail-item"><strong>Current Status:</strong> ${record.currentstatus || 'N/A'}</div>
                    <div class="detail-item"><strong>Approved Date:</strong> ${formatDate(record.approveddate)}</div>
                    <div class="detail-item"><strong>Rent Impairing:</strong> ${record.rentimpairing || 'N/A'}</div>
                `;
            } else if (title === 'DOB Violation') {
                detailsHtml = `
                    <div class="detail-item"><strong>Violation ID:</strong> ${record.isn_dob_bis_viol || 'N/A'}</div>
                    <div class="detail-item"><strong>Category:</strong> ${record.violation_category || 'N/A'}</div>
                    <div class="detail-item"><strong>Type:</strong> ${record.violation_type || 'N/A'}</div>
                    <div class="detail-item"><strong>Issue Date:</strong> ${formatDate(record.issue_date)}</div>
                    <div class="detail-item"><strong>Disposition:</strong> ${record.disposition_comments || 'N/A'}</div>
                `;
            } else if (title === 'Electrical Permit') {
                detailsHtml = `
                    <div class="detail-item"><strong>Filing Number:</strong> ${record.filing_number || 'N/A'}</div>
                    <div class="detail-item"><strong>Filing Date:</strong> ${formatDate(record.filing_date)}</div>
                    <div class="detail-item"><strong>Status:</strong> ${record.filing_status || 'N/A'}</div>
                    <div class="detail-item"><strong>Applicant:</strong> ${record.applicant_first_name || ''} ${record.applicant_last_name || ''}</div>
                    <div class="detail-item"><strong>Completion Date:</strong> ${formatDate(record.completion_date)}</div>
                    <div class="detail-item"><strong>Amount Paid:</strong> $${record.amount_paid || 'N/A'}</div>
                `;
            }
            
            if (violationDetails) violationDetails.innerHTML = detailsHtml;
            
            // Show modal
            modal.style.display = 'flex';
            
            // Add click outside to close
            modal.onclick = function(e) {
                if (e.target === modal) {
                    closeModal();
                }
            };
        }
        
        function closeModal() {
            const modal = document.getElementById('descriptionModal');
            modal.style.display = 'none';
            
            // Remove click outside handler
            modal.onclick = null;
        }
        
        // AI Analysis Polling Function
        let pollingTimer = null;
        const MAX_POLLING_ATTEMPTS = 20; // Maximum number of polling attempts (10 minutes at 30s intervals)
        const POLLING_INTERVAL = 30000; // 30 seconds between polling attempts
        
        async function startPollingForAIAnalysis(analysisId) {
            let attempts = 0;
            
            // Clear any existing polling timer
            if (pollingTimer) {
                clearInterval(pollingTimer);
            }
            
            // Update loading message
            const loadingMessage = document.getElementById('aiLoadingMessage');
            if (loadingMessage) {
                loadingMessage.textContent = 'AI analysis in progress... This may take a minute or two.';
            }
            
            // Define the polling function
            async function pollForResults() {
                attempts++;
                console.log(`Polling for AI analysis results (attempt ${attempts}/${MAX_POLLING_ATTEMPTS})`);
                
                try {
                    const response = await fetch(`/api/ai-analysis/${analysisId}`);
                    const data = await response.json();
                    
                    console.log('Polling response:', data);
                    
                    if (data.success) {
                        if (data.status === 'completed' && data.analysis) {
                            // We have results! Stop polling and display them
                            clearInterval(pollingTimer);
                            pollingTimer = null;
                            
                            console.log('AI analysis completed, displaying results');
                            displayAIAnalysisCompact(data.analysis);
                        } else if (data.status === 'failed') {
                            // Analysis failed, stop polling and show error
                            clearInterval(pollingTimer);
                            pollingTimer = null;
                            
                            console.error('AI analysis failed:', data.error);
                            showAIAnalysisError('Analysis failed: ' + (data.error || 'Unknown error'));
                        }
                        // If status is still 'pending', continue polling
                    } else {
                        // API error
                        console.error('Error polling for AI analysis:', data.message);
                        
                        // If we've reached max attempts, stop polling and show error
                        if (attempts >= MAX_POLLING_ATTEMPTS) {
                            clearInterval(pollingTimer);
                            pollingTimer = null;
                            showAIAnalysisError('Analysis timed out. Please try again later.');
                        }
                    }
                } catch (error) {
                    console.error('Network error while polling:', error);
                    
                    // If we've reached max attempts, stop polling and show error
                    if (attempts >= MAX_POLLING_ATTEMPTS) {
                        clearInterval(pollingTimer);
                        pollingTimer = null;
                        showAIAnalysisError('Network error while retrieving analysis results.');
                    }
                }
                
                // Update loading message with attempt count
                if (loadingMessage && pollingTimer) {
                    loadingMessage.textContent = `AI analysis in progress... (${attempts}/${MAX_POLLING_ATTEMPTS})`;
                }
            }
            
            // Start polling immediately
            await pollForResults();
            
            // Then set up interval for continued polling
            pollingTimer = setInterval(pollForResults, POLLING_INTERVAL);
        }
        
        function displayEnhancedAIAnalysis(aiData) {
            console.log('Displaying enhanced AI analysis:', aiData);
            
            // Handle both direct property_analysis and nested output structure
            const analysis = aiData.property_analysis || aiData.output?.property_analysis;
            if (!analysis) {
                console.error('No property_analysis found in AI data');
                return;
            }
            
            // Show the AI analysis results section
            document.getElementById('aiAnalysisResults').style.display = 'block';
            
            // Populate Analysis Header
            setTextContent('analysisTimestamp', formatTimestamp(analysis.analysis_timestamp));
            setTextContent('aiConfidenceLevel', aiData.ai_confidence || 'High');
            
            // Populate Key Metrics
            if (analysis.overall_risk_assessment) {
                setTextContent('overallRiskScore', analysis.overall_risk_assessment.risk_score || '-');
                setTextContent('overallRiskLevel', analysis.overall_risk_assessment.risk_level || '-');
            }
            
            if (analysis.data_freshness) {
                setTextContent('dataFreshnessDate', analysis.data_freshness.compliance_data_date || '-');
            }
            
            // Populate Executive Summary
            if (analysis.overall_risk_assessment) {
                setTextContent('riskSummaryText', analysis.overall_risk_assessment.risk_summary || '-');
                
                // Populate primary risk factors
                const riskFactorsList = document.getElementById('primaryRiskFactors');
                if (riskFactorsList && analysis.overall_risk_assessment.primary_risk_factors) {
                    riskFactorsList.innerHTML = '';
                    analysis.overall_risk_assessment.primary_risk_factors.forEach(factor => {
                        const li = document.createElement('li');
                        li.textContent = factor;
                        riskFactorsList.appendChild(li);
                    });
                }
            }
            
            // Add recommendations summary
            setTextContent('recommendationsSummary', aiData.recommendations_summary || analysis.recommendations_summary || '-');
            
            // Populate Compliance Insights
            if (analysis.compliance_insights) {
                const insights = analysis.compliance_insights;
                setTextContent('complianceTrajectory', insights.compliance_trajectory || '-');
                setTextContent('trendsAnalysis', insights.trends_analysis || '-');
                
                // Populate strengths
                const strengthsList = document.getElementById('complianceStrengths');
                if (strengthsList && insights.strengths) {
                    strengthsList.innerHTML = '';
                    insights.strengths.forEach(strength => {
                        const li = document.createElement('li');
                        li.textContent = strength;
                        strengthsList.appendChild(li);
                    });
                }
                
                // Populate immediate concerns
                const concernsList = document.getElementById('immediateConcerns');
                if (concernsList && insights.immediate_concerns) {
                    concernsList.innerHTML = '';
                    insights.immediate_concerns.forEach(concern => {
                        const li = document.createElement('li');
                        li.textContent = concern;
                        concernsList.appendChild(li);
                    });
                }
            }
            
            // Populate Priority Actions
            if (analysis.priority_actions) {
                const actionsList = document.getElementById('priorityActionsList');
                if (actionsList) {
                    actionsList.innerHTML = '';
                    
                    // Count actions by priority
                    let criticalCount = 0, highCount = 0, mediumCount = 0;
                    
                    analysis.priority_actions.forEach(action => {
                        const actionItem = createDetailedActionItem(action);
                        actionsList.appendChild(actionItem);
                        
                        // Count by priority
                        const priority = (action.priority || '').toLowerCase();
                        if (priority === 'critical') criticalCount++;
                        else if (priority === 'high') highCount++;
                        else if (priority === 'medium') mediumCount++;
                    });
                    
                    // Update summary cards
                    setTextContent('actionsCount', `${analysis.priority_actions.length} actions`);
                    setTextContent('criticalCount', criticalCount.toString());
                    setTextContent('highCount', highCount.toString());
                    setTextContent('mediumCount', mediumCount.toString());
                }
            }
            
            // Populate Financial Impact
            if (analysis.financial_impact) {
                const financial = analysis.financial_impact;
                setTextContent('totalExposure', financial.immediate_exposure || '-');
                setTextContent('immediateExposure', financial.immediate_exposure || '-');
                setTextContent('annualComplianceCosts', financial.annual_compliance_costs || '-');
                setTextContent('priorityInvestment', financial.priority_investment || '-');
                setTextContent('potentialFines', financial.potential_fines || '-');
                setTextContent('maintenanceCosts', financial.maintenance_costs || '-');
                setTextContent('costBenefitAnalysis', financial.cost_benefit_analysis || '-');
                
                // Populate cost breakdown
                const breakdownGrid = document.getElementById('costBreakdownGrid');
                if (breakdownGrid && financial.cost_breakdown) {
                    breakdownGrid.innerHTML = '';
                    Object.entries(financial.cost_breakdown).forEach(([category, cost]) => {
                        const breakdownItem = document.createElement('div');
                        breakdownItem.className = 'breakdown-item';
                        breakdownItem.innerHTML = `
                            <div class="breakdown-category">${category.replace('_', ' ').toUpperCase()}</div>
                            <div class="breakdown-value">${cost}</div>
                        `;
                        breakdownGrid.appendChild(breakdownItem);
                    });
                }
            }
            
            // Populate Equipment Monitoring
            if (analysis.equipment_monitoring) {
                const equipment = analysis.equipment_monitoring;
                
                // Update equipment summary and counts
                let totalDevices = 0;
                if (equipment.elevators) {
                    setTextContent('elevatorCount', equipment.elevators.total_devices || '0');
                    totalDevices += parseInt(equipment.elevators.total_devices || 0);
                }
                if (equipment.boilers) {
                    setTextContent('boilerCount', equipment.boilers.total_devices || '0');
                    totalDevices += parseInt(equipment.boilers.total_devices || 0);
                }
                if (equipment.electrical) {
                    setTextContent('electricalCount', equipment.electrical.active_permits || '0');
                }
                
                setTextContent('equipmentSummary', `${totalDevices} total devices`);
                
                // Populate detailed equipment tabs
                populateDetailedEquipmentTabs(equipment);
            }
            
            // Populate Regulatory Intelligence
            if (analysis.regulatory_intelligence) {
                const regulatory = analysis.regulatory_intelligence;
                setTextContent('upcomingInspections', regulatory.upcoming_inspections || '-');
                setTextContent('seasonalConsiderations', regulatory.seasonal_considerations || '-');
                setTextContent('regulatoryChanges', regulatory.regulatory_changes || '-');
                setTextContent('monitoringSchedule', regulatory.monitoring_schedule || '-');
                
                // Populate best practices
                const bestPracticesList = document.getElementById('bestPracticesList');
                if (bestPracticesList && regulatory.best_practices) {
                    bestPracticesList.innerHTML = '';
                    regulatory.best_practices.forEach(practice => {
                        const li = document.createElement('li');
                        li.textContent = practice;
                        bestPracticesList.appendChild(li);
                    });
                }
            }
        }
        
        function createDetailedActionItem(action) {
            const item = document.createElement('div');
            item.className = `priority-action-item ${(action.priority || '').toLowerCase()}`;
            
            // Safely extract data with proper fallbacks
            const actionId = action.id || `action_${Date.now()}`;
            const title = action.title || 'Action Required';
            const category = action.category || 'General';
            const priority = action.priority || 'Medium';
            const actionText = action.action || 'No action specified';
            const reason = action.reason || '';
            
            // Financial impact with safe extraction
            const financial = action.financial_impact || {};
            const estimatedCost = financial.estimated_cost || 'Not specified';
            const potentialPenalty = financial.potential_penalty || 'Not specified';
            const penaltyEscalation = financial.penalty_escalation || '';
            const costBenefit = financial.cost_benefit || '';
            
            // Timeline with safe extraction
            const timeline = action.timeline || {};
            const urgency = timeline.urgency || 'Not specified';
            const deadline = timeline.deadline || 'Not specified';
            const consequences = timeline.consequences || 'Not specified';
            
            // Regulatory context
            const regulatory = action.regulatory_context || {};
            const regulationRef = regulatory.regulation_reference || '';
            const penaltySchedule = regulatory.penalty_schedule || '';
            const filingRequirements = regulatory.filing_requirements || '';
            
            item.innerHTML = `
                <div class="action-item-header" onclick="toggleActionItem('${actionId}')">
                    <div class="action-main-info">
                        <div class="action-title">${title}</div>
                        <div class="action-category-badge">${category}</div>
                        <div class="action-priority-badge ${priority.toLowerCase()}">${priority}</div>
                    </div>
                    <div class="action-summary">
                        <span class="cost-summary">${estimatedCost}</span>
                        <i class="fas fa-chevron-down expand-icon" id="${actionId}-icon"></i>
                    </div>
                </div>
                <div class="action-item-content" id="${actionId}-content" style="display: none;">
                    <div class="action-description">
                        <h4>Action Required</h4>
                        <p>${actionText}</p>
                        ${reason ? `<p><strong>Reason:</strong> ${reason}</p>` : ''}
                    </div>
                    
                    <div class="action-details-grid">
                        <div class="detail-section financial">
                            <h4><i class="fas fa-dollar-sign"></i> Financial Impact</h4>
                            <div class="detail-items">
                                <div class="detail-item">
                                    <span class="detail-label">Estimated Cost:</span>
                                    <span class="detail-value">${estimatedCost}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Potential Penalty:</span>
                                    <span class="detail-value">${potentialPenalty}</span>
                                </div>
                                ${penaltyEscalation ? `
                                <div class="detail-item">
                                    <span class="detail-label">Penalty Escalation:</span>
                                    <span class="detail-value">${penaltyEscalation}</span>
                                </div>` : ''}
                                ${costBenefit ? `
                                <div class="detail-item">
                                    <span class="detail-label">Cost vs Benefit:</span>
                                    <span class="detail-value">${costBenefit}</span>
                                </div>` : ''}
                            </div>
                        </div>
                        
                        <div class="detail-section timeline">
                            <h4><i class="fas fa-clock"></i> Timeline</h4>
                            <div class="detail-items">
                                <div class="detail-item">
                                    <span class="detail-label">Urgency:</span>
                                    <span class="detail-value urgency-${urgency.toLowerCase().replace('_', '-')}">${urgency}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Deadline:</span>
                                    <span class="detail-value">${deadline}</span>
                                </div>
                                <div class="detail-item">
                                    <span class="detail-label">Consequences:</span>
                                    <span class="detail-value">${consequences}</span>
                                </div>
                            </div>
                        </div>
                        
                        ${regulationRef || penaltySchedule || filingRequirements ? `
                        <div class="detail-section regulatory">
                            <h4><i class="fas fa-gavel"></i> Regulatory Context</h4>
                            <div class="detail-items">
                                ${regulationRef ? `
                                <div class="detail-item">
                                    <span class="detail-label">Regulation:</span>
                                    <span class="detail-value">${regulationRef}</span>
                                </div>` : ''}
                                ${penaltySchedule ? `
                                <div class="detail-item">
                                    <span class="detail-label">Penalty Schedule:</span>
                                    <span class="detail-value">${penaltySchedule}</span>
                                </div>` : ''}
                                ${filingRequirements ? `
                                <div class="detail-item">
                                    <span class="detail-label">Filing Requirements:</span>
                                    <span class="detail-value">${filingRequirements}</span>
                                </div>` : ''}
                            </div>
                        </div>` : ''}
                    </div>
                </div>
            `;
            
            return item;
        }
        
        function populateEquipmentTabs(equipment) {
            // Populate Elevators tab with device-specific information
            if (equipment.elevators) {
                const elevatorsPanel = document.getElementById('elevators-panel');
                if (elevatorsPanel) {
                    const elevatorData = equipment.elevators;
                    
                    // Handle individual elevator devices if available
                    let deviceList = '';
                    if (elevatorData.devices && Array.isArray(elevatorData.devices)) {
                        deviceList = elevatorData.devices.map(device => `
                            <div class="device-card">
                                <h5>${device.device_id || 'Elevator Device'}</h5>
                                <p><strong>Status:</strong> ${device.status || 'Unknown'}</p>
                                <p><strong>Last Inspection:</strong> ${device.last_inspection || 'Not specified'}</p>
                                <p><strong>Next Due:</strong> ${device.next_due || 'Not specified'}</p>
                                ${device.compliance_gaps ? `<p><strong>Issues:</strong> ${device.compliance_gaps.join(', ')}</p>` : ''}
                            </div>
                        `).join('');
                    }
                    
                    elevatorsPanel.innerHTML = `
                        <div class="equipment-summary">
                            <h4>Elevator Overview</h4>
                            <p><strong>Total Devices:</strong> ${elevatorData.total_devices || '-'}</p>
                            <p><strong>Active Devices:</strong> ${elevatorData.active_devices || '-'}</p>
                            <p><strong>Estimated Annual Costs:</strong> ${elevatorData.estimated_annual_costs || '-'}</p>
                        </div>
                        ${deviceList ? `<div class="device-list">${deviceList}</div>` : ''}
                        <div class="equipment-requirements">
                            <h4>CAT-1 Requirements</h4>
                            <ul>${(elevatorData.cat1_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                            <h4>CAT-5 Requirements</h4>
                            <ul>${(elevatorData.cat5_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                            <h4>Compliance Gaps</h4>
                            <ul>${(elevatorData.compliance_gaps || []).map(gap => `<li style="color: #dc3545;">${gap}</li>`).join('')}</ul>
                        </div>
                    `;
                }
            }
            
            // Populate Boilers tab
            if (equipment.boilers) {
                const boilersPanel = document.getElementById('boilers-panel');
                if (boilersPanel) {
                    boilersPanel.innerHTML = `
                        <div class="equipment-summary">
                            <h4>Boiler Overview</h4>
                            <p><strong>Total Devices:</strong> ${equipment.boilers.total_devices || '-'}</p>
                            <p><strong>Inspection Status:</strong> ${equipment.boilers.inspection_status || '-'}</p>
                            <p><strong>Estimated Annual Costs:</strong> ${equipment.boilers.estimated_annual_costs || '-'}</p>
                        </div>
                        <div class="equipment-requirements">
                            <h4>Filing Requirements</h4>
                            <ul>${(equipment.boilers.filing_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                            <h4>Compliance Gaps</h4>
                            <ul>${(equipment.boilers.compliance_gaps || []).map(gap => `<li style="color: #dc3545;">${gap}</li>`).join('')}</ul>
                        </div>
                    `;
                }
            }
            
            // Populate Electrical tab
            if (equipment.electrical) {
                const electricalPanel = document.getElementById('electrical-panel');
                if (electricalPanel) {
                    electricalPanel.innerHTML = `
                        <div class="equipment-summary">
                            <h4>Electrical Overview</h4>
                            <p><strong>Active Permits:</strong> ${equipment.electrical.active_permits || '-'}</p>
                            <p><strong>Status:</strong> ${equipment.electrical.status_summary || '-'}</p>
                        </div>
                        <div class="equipment-requirements">
                            <h4>Actions Needed</h4>
                            <ul>${(equipment.electrical.action_needed || []).map(action => `<li>${action}</li>`).join('')}</ul>
                        </div>
                    `;
                }
            }
        }
        
        function toggleActionItem(actionId) {
            const content = document.getElementById(`${actionId}-content`);
            const icon = document.getElementById(`${actionId}-icon`);
            
            if (content && icon) {
                const isVisible = content.style.display !== 'none';
                content.style.display = isVisible ? 'none' : 'block';
                icon.className = isVisible ? 'fas fa-chevron-down expand-icon' : 'fas fa-chevron-up expand-icon';
            }
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '-';
            try {
                const date = new Date(timestamp);
                return date.toLocaleString();
            } catch (e) {
                return timestamp;
            }
        }
        
        function populateDetailedEquipmentTabs(equipment) {
            // Populate Elevators tab with detailed information
            if (equipment.elevators) {
                const elevatorsPanel = document.getElementById('elevators-panel');
                if (elevatorsPanel) {
                    const elevatorData = equipment.elevators;
                    
                    elevatorsPanel.innerHTML = `
                        <div class="equipment-overview">
                            <div class="equipment-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Total Devices:</span>
                                    <span class="stat-value">${elevatorData.total_devices || '-'}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Active Devices:</span>
                                    <span class="stat-value">${elevatorData.active_devices || '-'}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Estimated Annual Costs:</span>
                                    <span class="stat-value">${elevatorData.estimated_annual_costs || '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="equipment-requirements">
                            <div class="requirement-section">
                                <h4><i class="fas fa-clipboard-check"></i> CAT-1 Requirements</h4>
                                <ul>${(elevatorData.cat1_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                            </div>
                            <div class="requirement-section">
                                <h4><i class="fas fa-clipboard-list"></i> CAT-5 Requirements</h4>
                                <ul>${(elevatorData.cat5_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                            </div>
                            <div class="requirement-section gaps">
                                <h4><i class="fas fa-exclamation-triangle"></i> Compliance Gaps</h4>
                                <ul>${(elevatorData.compliance_gaps || []).map(gap => `<li class="gap-item">${gap}</li>`).join('')}</ul>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Populate Boilers tab with detailed information
            if (equipment.boilers) {
                const boilersPanel = document.getElementById('boilers-panel');
                if (boilersPanel) {
                    const boilerData = equipment.boilers;
                    
                    boilersPanel.innerHTML = `
                        <div class="equipment-overview">
                            <div class="equipment-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Total Devices:</span>
                                    <span class="stat-value">${boilerData.total_devices || '-'}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Inspection Status:</span>
                                    <span class="stat-value">${boilerData.inspection_status || '-'}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Estimated Annual Costs:</span>
                                    <span class="stat-value">${boilerData.estimated_annual_costs || '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="equipment-requirements">
                            <div class="requirement-section">
                                <h4><i class="fas fa-file-alt"></i> Filing Requirements</h4>
                                <ul>${(boilerData.filing_requirements || []).map(req => `<li>${req}</li>`).join('')}</ul>
                            </div>
                            <div class="requirement-section gaps">
                                <h4><i class="fas fa-exclamation-triangle"></i> Compliance Gaps</h4>
                                <ul>${(boilerData.compliance_gaps || []).map(gap => `<li class="gap-item">${gap}</li>`).join('')}</ul>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Populate Electrical tab with detailed information
            if (equipment.electrical) {
                const electricalPanel = document.getElementById('electrical-panel');
                if (electricalPanel) {
                    const electricalData = equipment.electrical;
                    
                    electricalPanel.innerHTML = `
                        <div class="equipment-overview">
                            <div class="equipment-stats">
                                <div class="stat-item">
                                    <span class="stat-label">Active Permits:</span>
                                    <span class="stat-value">${electricalData.active_permits || '-'}</span>
                                </div>
                                <div class="stat-item">
                                    <span class="stat-label">Status Summary:</span>
                                    <span class="stat-value">${electricalData.status_summary || '-'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="equipment-requirements">
                            <div class="requirement-section">
                                <h4><i class="fas fa-tasks"></i> Actions Needed</h4>
                                <ul>${(electricalData.action_needed || []).map(action => `<li>${action}</li>`).join('')}</ul>
                            </div>
                        </div>
                    `;
                }
            }
        }
        
        // Expandable sections functionality
        function toggleSection(sectionId) {
            const content = document.getElementById(`${sectionId}-content`);
            const icon = document.getElementById(`${sectionId}-icon`);
            
            if (content && icon) {
                const isExpanded = content.classList.contains('expanded');
                
                if (isExpanded) {
                    content.classList.remove('expanded');
                    icon.classList.remove('rotated');
                } else {
                    content.classList.add('expanded');
                    icon.classList.add('rotated');
                }
            }
        }
        
        // Tab functionality for equipment monitoring
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabPanels = document.querySelectorAll('.tab-panel');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Remove active class from all buttons and panels
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabPanels.forEach(panel => panel.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding panel
                    this.classList.add('active');
                    document.getElementById(`${tabName}-panel`).classList.add('active');
                });
            });
            
            // Auto-expand first section by default
            const firstSection = document.querySelector('.expandable-section');
            if (firstSection) {
                const firstSectionId = firstSection.querySelector('.section-content').id.replace('-content', '');
                toggleSection(firstSectionId);
            }
        });
        
        function showAIAnalysisError(errorMessage) {
            // Show error state
            document.getElementById('aiLoadingState').style.display = 'none';
            document.getElementById('aiResultsState').style.display = 'block';
            
            // Update header to show error
            const confidenceBadge = document.getElementById('aiConfidenceBadge');
            if (confidenceBadge) {
                confidenceBadge.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
                confidenceBadge.style.background = 'rgba(220, 38, 38, 0.2)';
            }
            
            // Show error in risk assessment
            const riskContainer = document.getElementById('riskAssessmentContainer');
            if (riskContainer) {
                riskContainer.className = 'risk-assessment-enhanced risk-critical-border';
            }
            
            const riskBadge = document.getElementById('riskBadgeEnhanced');
            if (riskBadge) {
                riskBadge.textContent = 'ERROR';
                riskBadge.className = 'risk-badge-enhanced risk-critical';
            }
            
            const riskSummary = document.getElementById('riskSummaryEnhanced');
            if (riskSummary) {
                riskSummary.textContent = errorMessage || 'Unable to process AI analysis at this time.';
            }
            
            const actionsGrid = document.getElementById('actionsGrid');
            if (actionsGrid) {
                actionsGrid.innerHTML = `
                    <div class="action-card-enhanced action-critical">
                        <div class="action-title-enhanced">AI Analysis Temporarily Unavailable</div>
                        <div class="action-reason">Our AI service is currently experiencing issues. The compliance data shown above remains accurate and actionable.</div>
                    </div>
                `;
            }
        }
    </script>
</body>
</html>