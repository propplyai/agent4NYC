{% extends "propply/base.html" %}

{% block title %}Dashboard - Propply AI{% endblock %}
{% block page_title %}Dashboard{% endblock %}
{% block page_subtitle %}Overview of your property compliance status{% endblock %}

{% block content %}
<!-- Overview Cards -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="overview-card">
            <div class="card-icon bg-primary">
                <i class="fas fa-building"></i>
            </div>
            <div class="card-content">
                <div class="card-value" id="totalProperties">--</div>
                <div class="card-label">Total Properties</div>
                <div class="card-change positive">
                    <i class="fas fa-arrow-up"></i> 12% from last month
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="overview-card">
            <div class="card-icon bg-success">
                <i class="fas fa-shield-check"></i>
            </div>
            <div class="card-content">
                <div class="card-value" id="complianceRate">--</div>
                <div class="card-label">Compliance Rate</div>
                <div class="card-change positive">
                    <i class="fas fa-arrow-up"></i> 5% improvement
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="overview-card">
            <div class="card-icon bg-warning">
                <i class="fas fa-clock"></i>
            </div>
            <div class="card-content">
                <div class="card-value" id="pendingInspections">--</div>
                <div class="card-label">Pending Inspections</div>
                <div class="card-change neutral">
                    <i class="fas fa-minus"></i> No change
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="overview-card">
            <div class="card-icon bg-danger">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="card-content">
                <div class="card-value" id="overdueItems">--</div>
                <div class="card-label">Overdue Items</div>
                <div class="card-change negative">
                    <i class="fas fa-arrow-down"></i> 2 resolved
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Main Dashboard Content -->
<div class="row">
    <!-- Upcoming Deadlines -->
    <div class="col-lg-8 mb-4">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Upcoming Deadlines
                </h3>
                <div class="card-actions">
                    <button class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-calendar-plus"></i>
                        Schedule
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="upcomingDeadlines" class="deadlines-list">
                    <!-- Deadlines will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="col-lg-4 mb-4">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h3>
            </div>
            <div class="card-body">
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="openPropertySearch()">
                        <div class="action-icon bg-primary">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Search Property</div>
                            <div class="action-subtitle">Find property compliance data</div>
                        </div>
                    </button>
                    
                    <button class="quick-action-btn" onclick="generateReport()">
                        <div class="action-icon bg-success">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Generate Report</div>
                            <div class="action-subtitle">Create compliance report</div>
                        </div>
                    </button>
                    
                    <button class="quick-action-btn" onclick="scheduleInspection()">
                        <div class="action-icon bg-warning">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">Schedule Inspection</div>
                            <div class="action-subtitle">Book inspection service</div>
                        </div>
                    </button>
                    
                    <button class="quick-action-btn" onclick="aiAnalysis()">
                        <div class="action-icon bg-info">
                            <i class="fas fa-brain"></i>
                        </div>
                        <div class="action-content">
                            <div class="action-title">AI Analysis</div>
                            <div class="action-subtitle">Get intelligent insights</div>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Compliance Overview Chart -->
<div class="row">
    <div class="col-lg-8 mb-4">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-chart-line me-2"></i>
                    Compliance Trends
                </h3>
                <div class="card-actions">
                    <select class="form-select form-select-sm" style="width: auto;">
                        <option>Last 30 days</option>
                        <option>Last 90 days</option>
                        <option>Last year</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <canvas id="complianceChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="col-lg-4 mb-4">
        <div class="dashboard-card">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-history me-2"></i>
                    Recent Activity
                </h3>
            </div>
            <div class="card-body">
                <div id="recentActivity" class="activity-list">
                    <!-- Activity items will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Property Search Modal -->
<div class="modal fade" id="propertySearchModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-search me-2"></i>
                    Search Property
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="propertySearchForm">
                    <div class="mb-3">
                        <label for="propertyAddress" class="form-label">Property Address</label>
                        <input type="text" class="form-control" id="propertyAddress" 
                               placeholder="Enter property address (e.g., 123 Main Street, Brooklyn)">
                    </div>
                    <div class="mb-3">
                        <label for="zipCode" class="form-label">ZIP Code (Optional)</label>
                        <input type="text" class="form-control" id="zipCode" 
                               placeholder="Enter ZIP code">
                    </div>
                </form>
                
                <div id="searchResults" class="search-results mt-4" style="display: none;">
                    <h6>Search Results:</h6>
                    <div id="propertyList" class="property-list"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="searchProperty()">
                    <i class="fas fa-search me-1"></i>
                    Search
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Dashboard JavaScript
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardData();
    initializeComplianceChart();
});

async function loadDashboardData() {
    try {
        showLoading(true);
        const response = await fetch('/api/dashboard-data');
        const data = await response.json();
        
        if (response.ok) {
            updateOverviewCards(data.overview);
            updateUpcomingDeadlines(data.upcoming_deadlines);
            updateRecentActivity(data.recent_activity);
        } else {
            showError('Failed to load dashboard data');
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showError('Failed to load dashboard data');
    } finally {
        showLoading(false);
    }
}

function updateOverviewCards(overview) {
    document.getElementById('totalProperties').textContent = overview.total_properties;
    document.getElementById('complianceRate').textContent = overview.compliance_rate + '%';
    document.getElementById('pendingInspections').textContent = overview.pending_inspections;
    document.getElementById('overdueItems').textContent = overview.overdue_items;
}

function updateUpcomingDeadlines(deadlines) {
    const container = document.getElementById('upcomingDeadlines');
    container.innerHTML = '';
    
    if (deadlines.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">No upcoming deadlines</div>';
        return;
    }
    
    deadlines.forEach(deadline => {
        const deadlineElement = document.createElement('div');
        deadlineElement.className = 'deadline-item';
        deadlineElement.innerHTML = `
            <div class="deadline-priority priority-${deadline.priority}"></div>
            <div class="deadline-content">
                <div class="deadline-title">${deadline.inspection_type}</div>
                <div class="deadline-property">${deadline.property}</div>
                <div class="deadline-date">Due: ${formatDate(deadline.due_date)}</div>
            </div>
            <div class="deadline-actions">
                <button class="btn btn-sm btn-outline-primary">Schedule</button>
            </div>
        `;
        container.appendChild(deadlineElement);
    });
}

function updateRecentActivity(activities) {
    const container = document.getElementById('recentActivity');
    container.innerHTML = '';
    
    if (activities.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-4">No recent activity</div>';
        return;
    }
    
    activities.forEach(activity => {
        const activityElement = document.createElement('div');
        activityElement.className = 'activity-item';
        activityElement.innerHTML = `
            <div class="activity-icon ${getActivityIconClass(activity.type)}">
                <i class="${getActivityIcon(activity.type)}"></i>
            </div>
            <div class="activity-content">
                <div class="activity-description">${activity.description}</div>
                <div class="activity-property">${activity.property}</div>
                <div class="activity-time">${formatTimeAgo(activity.timestamp)}</div>
            </div>
        `;
        container.appendChild(activityElement);
    });
}

function initializeComplianceChart() {
    const ctx = document.getElementById('complianceChart').getContext('2d');
    new Chart(ctx, {
        type: 'line',
        data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
                label: 'Compliance Rate',
                data: [82, 85, 88, 87, 90, 87.5],
                borderColor: '#4f46e5',
                backgroundColor: 'rgba(79, 70, 229, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    min: 70,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// Quick Action Functions
function openPropertySearch() {
    const modal = new bootstrap.Modal(document.getElementById('propertySearchModal'));
    modal.show();
}

function generateReport() {
    showInfo('Report generation feature coming soon!');
}

function scheduleInspection() {
    showInfo('Inspection scheduling feature coming soon!');
}

function aiAnalysis() {
    showInfo('AI Analysis feature coming soon!');
}

async function searchProperty() {
    const address = document.getElementById('propertyAddress').value.trim();
    const zipCode = document.getElementById('zipCode').value.trim();
    
    if (!address) {
        showError('Please enter a property address');
        return;
    }
    
    try {
        showLoading(true);
        const response = await fetch('/api/search', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                address: address,
                zip_code: zipCode
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            displaySearchResults(data.matches);
        } else {
            showError(data.error || 'Search failed');
        }
    } catch (error) {
        console.error('Search error:', error);
        showError('Search failed');
    } finally {
        showLoading(false);
    }
}

function displaySearchResults(matches) {
    const resultsContainer = document.getElementById('searchResults');
    const propertyList = document.getElementById('propertyList');
    
    propertyList.innerHTML = '';
    
    if (matches.length === 0) {
        propertyList.innerHTML = '<div class="text-center text-muted py-3">No properties found</div>';
    } else {
        matches.forEach(match => {
            const propertyElement = document.createElement('div');
            propertyElement.className = 'property-result';
            propertyElement.innerHTML = `
                <div class="property-info">
                    <div class="property-address">${match.address}</div>
                    <div class="property-details">
                        Borough: ${match.borough} | BIN: ${match.bin || 'N/A'}
                    </div>
                </div>
                <button class="btn btn-sm btn-primary" onclick="generateComplianceReport('${match.bin}', '${match.borough}', '${match.block}', '${match.lot}')">
                    Generate Report
                </button>
            `;
            propertyList.appendChild(propertyElement);
        });
    }
    
    resultsContainer.style.display = 'block';
}

async function generateComplianceReport(bin, borough, block, lot) {
    try {
        showLoading(true);
        const response = await fetch('/api/compliance', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                bin: bin,
                borough: borough,
                block: block,
                lot: lot
            })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showSuccess('Compliance report generated successfully!');
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('propertySearchModal')).hide();
            // Optionally redirect to compliance page or show report
        } else {
            showError(data.error || 'Failed to generate compliance report');
        }
    } catch (error) {
        console.error('Compliance report error:', error);
        showError('Failed to generate compliance report');
    } finally {
        showLoading(false);
    }
}

// Utility Functions
function formatDate(dateString) {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
    });
}

function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
    
    if (diffInHours < 1) return 'Just now';
    if (diffInHours < 24) return `${diffInHours}h ago`;
    
    const diffInDays = Math.floor(diffInHours / 24);
    return `${diffInDays}d ago`;
}

function getActivityIcon(type) {
    const icons = {
        'inspection_completed': 'fas fa-check-circle',
        'violation_resolved': 'fas fa-shield-check',
        'report_generated': 'fas fa-file-alt',
        'deadline_approaching': 'fas fa-clock'
    };
    return icons[type] || 'fas fa-info-circle';
}

function getActivityIconClass(type) {
    const classes = {
        'inspection_completed': 'bg-success',
        'violation_resolved': 'bg-primary',
        'report_generated': 'bg-info',
        'deadline_approaching': 'bg-warning'
    };
    return classes[type] || 'bg-secondary';
}
</script>
{% endblock %}
